<!DOCTYPE html>
<html lang="en">
<!--/*! home | index.html noiseless v.1.0.1 (dev branch) | (c) 2019 | b2.io */-->
<head>
  <title>Brennan B2</title>
  <link rel="shortcut icon" type="image/png" href="b2appicon.png">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script src="js/jquery-1.11.3.min.js"></script>
  <script src="js/bootstrap-3.3.5.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/perfect-scrollbar.min.css">  
  <script src="js/perfect-scrollbar.jquery.js"></script>
  <script src="js/smoothie.js"></script>
  <script src="bundle.js"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="b2appicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">  
  
 <script>
	 	 
var selectedPanelForMobile = 0;
var selectedSubPanel = 0;
var selectedSearchSubPanel = 0;
var selectedSearchItem;
var targetPlaylist = 0;
var lastPanels = [];
var debugTimer;
var bluetoothTimer;
var uploadEnabled;
var folderUploadEnable;
var folderUploadCount;
var searchResultsHaveFocus;
var lastGuestPlaylist;
var youtubeHistory = [];
var youtubeHistoryDeletionIndex;
var youtubeSearchResults = [];
var vTunerSearchResults = [];
var vTunerItemResults = [];
var selectedPlaylistItem;
var USBResults;
var USBIndex;
var USBPaths = [];
var sourceText;

var searchCount = 200;
var searching = 0;
var newSearchText = 0;
	 
$(function() {

	nowPlaying = {};
	
	setInterval (statusFunction,500);


	$('.iconToggle').on('click',function(){
		icon = $(this).find("span");
		icon.toggleClass("myGrey");
//		console.log (icon.hasClass("myGrey"));
		searchFunction ();
	});

	
	lastRandom = true;
	$('#randomIcon').toggleClass("myGrey",false);
	lastSorted = true;
	$('#alphaIcon').toggleClass("myGrey",false);
	
	$('.transportButton').on('click',function(event){
		$(this).blur();
		$.get('b2cgi.fcgi',$(this).attr('value')+"&"+new Date ().getTime(),function(data){
			// ignore response to ajax get
		});
	});	

	$('#SearchContainer').perfectScrollbar ();
	$('#playlistContainer').perfectScrollbar ();	
	$('#AlbumTracksBox').perfectScrollbar ();
	$('#ArtistAlbumsBox').perfectScrollbar ({minScrollbarLength: 20});
	$('#presetsBox').perfectScrollbar ();
//	$('#USBItemsBox').perfectScrollbar ({minScrollbarLength: 20});
	
	$('#SearchContainer').on('ps-y-reach-end',searchMore);	
	
//	panels[0] = $('#nowPlayingPanel');
//	panels[1] = $('#panel1');
//	panels[2] = $('#panel2');
//	panels[3] = $('#ArtistAlbumsBox');
//	panels[4] = $('#AlbumTracksBox');
//	selectPanel (0);


	listPlaylistsFunction ();			// populate the list of playlists
										// will also select the first and display

//	listalbumAndArtistFunction (1000000);
	listRandomAlbumAndArtistFunction ();		
//	listArtistFunction (3000000);	
	listPresetsFunction ();

	 $("#slider-1").on ("input", function() {
		$( "#volume" ).text( "Volume: "+this.value );
		var t = "vol"+this.value+"&"+new Date ().getTime();
		$.get('b2cgi.fcgi',t,function(data){			// send volxx to fcgi
		});
	});
	
	 $("#slider-1").on ("change", function() {			// for IE
		$( "#volume" ).text("Volume: "+this.value );
		var t = "vol"+this.value+"&"+new Date ().getTime();
		$.get('b2cgi.fcgi',t,function(data){			// send volxx to fcgi
		});
	});

	$("#slider-1").on ("mouseenter", function() {		// to stop status updates causing jitter
		 mouseOverSlider = true;
	}).on ("mouseleave", function() {
		 mouseOverSlider = false;
	});

	 $("#trebleSlider").on ("input", toneChange);
	 $("#trebleSlider").on ("change", toneChange);
	 $("#bassSlider").on ("input", toneChange);
	 $("#bassSlider").on ("change", toneChange);

	$("#progressSlider").on ("change", progressChange);
	$("#progressSlider").on ("input", progressInput);
	$("#progressSlider").on ("mouseenter", function() {		// to stop status updates causing jitter
		 mouseOverProgressSlider = true;
	}).on ("mouseleave", function() {
		 mouseOverProgressSlider = false;
	});
	
	smoothie = new SmoothieChart({maxValue:100,minValue:0});
	
	var canvas = document.getElementById("mycanvas");
	canvas.width = $('#canvasBox').width();
	
	smoothie.streamTo (canvas,500);
	vuLine1 = new TimeSeries();
	smoothie.addTimeSeries(vuLine1);
	$('#CDDBPanel').hide();
	$('#uploading').hide ();
	$('#fetchingArt').hide ();
	
	$('#vTunerBox').perfectScrollbar ();	
	$('#vTunerSearchBox').perfectScrollbar ();	
	$('#YoutubeSearchResultsBox').perfectScrollbar ();	
	$('#YoutubeHistoryBox').perfectScrollbar ();
	$('#USBItemsBox').perfectScrollbar ();



/*	
//	$('a[href="#VTunerPanel"]').on('shown.bs.tab',startVtuner);
	$('a[href="#VTunerPanel"]').on('shown.bs.tab',function (e) {
//	$('a[data-toggle="tab"]').on('shown.bs.tab',function (e) {
		console.log ("vTuner Selected");
		vTunerInit ();
	});	
*/
	
	lastWidth = window.innerWidth;
	
	adjustHeights ();
	canvas.width = $('#canvasBox').width();

	selectPlaylistSubPanel (0);
	selectSearchSubPanel (0);	
	searchFunction ();					// populate list of matches
		
	selectedSource = 0;
	selectedDest = 0;
	selectedMode = 0;	
	
	if (getCookie("uiMode")=="") setCookie ("uiMode","normal",365);
	
	$("#webMode").prop("checked",getCookie("uiMode")=="mobile");
	
	$("#webModeAuto").prop("checked",getCookie ("uiMode")=="normal");	
	$("#webModeMobile").prop("checked",getCookie ("uiMode")=="mobile");
	$("#webModeDesktop").prop("checked",getCookie ("uiMode")=="desktop");	
	
	
	if (getCookie("bigPicture")=="") setCookie ("bigPicture","false",365);
//	console.log ("bigPictureCookie = "+getCookie("bigPicture"));
	$("#webBigPicture").prop("checked",getCookie("bigPicture")=="true");
	adjustForBigPicture ();
		
	if (getCookie("whichUI")=="") setCookie ("whichUI","original",365);
	$("#webDefaultUI").prop("checked",getCookie("whichUI")=="mobile");
	
//	$("#selectedPanel").focus ();	
//	document.getElementById ("selectedPanel").focus ();

	$('.ps-scrollbar-y').attr('tabindex',-1);


	$('#SearchPanel').keydown (searchKeyHandler);
	searchResultsHaveFocus = false;
	
	$("#youtubeSearching").hide ();		
	$("#youtubeStarting").hide ();
	$("#artSearching").hide ();	



	USBPaths[0] = "/usba";	
	USBPaths[1] = "/usbc";
	USBIndex = 0;	

	$('#folderUploading').hide ();
	$('#unknownWarning').hide ();
	
	uploadSelect ();
	
});
</script>  
 
<style type="text/css">
  
.well {
	margin-bottom: 10px;
}
.ScrollBox {
	position: relative;
	height: 100%;
	overflow-y: hidden;
	overflow-x: hidden;
}

.SearchScrollBox {
	position: relative;
	height: 12em;
	overflow-y: hidden;
	overflow-x: hidden;
}

.vTunerScrollBox {
	position: relative;
	height: 10em;
	overflow-y: hidden;
	overflow-x: hidden;
}

.ArtistScrollBox {
	position: relative;
/*	height: 12em;	*/
	overflow-y: hidden;
	overflow-x: hidden;
}

.panelContentOld {
	margin-top: 10px;
	padding: 10px;
	border: 2px solid #3C4144;
	border-radius: 4px;
	
}

.panelContent {
	margin-top: 10px;
/*	padding-top: 10px; */
/*	border-top: 4px solid #003366; */
/*	border-top: 4px solid #3C4144; */

}

.YoutubeScrollBox {
	position: relative;
	height: 24em;
	overflow-y: scroll;
	margin: 10px;
	padding: 5px;
/*	
	overflow-y: hidden;
	overflow-x: hidden;
*/	
}

#YoutubeHistoryBox {
	position: relative;
	padding: 0px;
}

#YoutubeSearchResultsBox {
	position: relative;
	padding: 0px;
}

.USBScrollBox {
	position: relative;
	overflow-y: hidden;
	overflow-x: hidden;
}

#USBItemsBox {
	position: relative;
	padding: 0px;
}

.fit {
	height: 20px;
}	

#ArtistAlbumsBox {
	position: relative;	
}	

#AlbumTracksBox {
	position: relative;	
}	

#albumImage {
/*	max-height: 30px; */
	max-width: 100%;
}	

.panel {

	margin-bottom: 0px;
}	

.panel-body {

	padding: 8px;
}

#mixText {
	margin-top: 15px;
	margin-left: 10px;
}		

#debugText {
	font-family: monospace;
	height: 600px;
	overflow-y: scroll;
	overflow-x: hidden;	
}

#settingsBody p {
	margin-bottom: 0px;
}
#settingsBody {
	margin-bottom: 10px;
}

.npInline {
	display: inline-block;

}	

#nowPlayingBody {
	padding-left: 5px;
	padding-right: 5px;
}	

/*
#nowPlayingArt {
	padding-left: 5px;
	padding-right: 5px;

	flex: 1;
	align-self: center;
	
	max-height: 100%;
}
*/
.artContainer {
	padding-left: 5px;
	padding-right: 5px;
/*
	flex: 1;
	align-self: center;
*/	
	max-height: 100%;
	
	margin-left: auto;
	margin-right: auto;	
}

#nowPlayingArt {
	max-height: 100%;	
	width: 100%;
	height: 100%;
	

}

.flexArt {
	max-height: 100%;
	max-width: 100%;
	
/*
	display: block;
	margin-left: auto;
	margin-right: auto;	
*/	
}	


.center {

	display: block;
	margin-left: auto;
	margin-right: auto;	
	
}		

.w80 {
	width: 78%;
}
.w20 {
	width: 19%;
}		

.top > * {
	vertical-align: top;
}

.middle > * {
	vertical-align: middle;
}
	

@media screen and (min-width: 990px){

	.ScrollBox {
		position: relative;
		height: 100%;
		overflow-y: hidden;
		overflow-x: hidden;
	}

	.SearchScrollBox {
		position: relative;
		height: 48em;
		overflow-y: hidden;
		overflow-x: hidden;
	}

	.vTunerScrollBox {
		position: relative;
		height: 20em;
		overflow-y: hidden;
		overflow-x: hidden;
	}

	.ArtistScrollBox {
		position: relative;
/*		height: 23em;	*/
		overflow-y: hidden;
		overflow-x: hidden;
	}

}


div[class^="col"]{padding-left:5px; padding-right: 5px}

@media (max-width: 990px){

	    .col-xs-4 { width:100%;}

		#nowPlayingWell {
			display:table;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: visible;
		}

	    #nowPlayingArt {padding-top: 0px; padding-right: 0px;}

		div[class^="col"]{padding-left:0px; padding-right: 0px}
		.container-fluid{padding-left: 0px; padding-right: 0px}
		.panel {margin-bottom: 0px;}
		.panel {border: 0px}
		.panel-body {padding-top: 5px; padding-bottom: 5px}
		.well {margin-bottom: 0px}
		.well-sm {padding-top: 0px; padding-bottom: 5px}

		/*#settingsButton {width: 16.66666666%;}.col-sm-10 {width: 83.33333333%}*/
		li#t2>a {display: inline-block;}		
}	

@media (max-width: 767px) {
	    /*.nav>li>a {padding: 0px 0px;}*/
        #t2 .col-sm-10{padding-top: 10px; padding-bottom: 10px; padding-left: 15px; padding-right: 15px;}
        #settingsButton {width: 16.66666667%; padding-top: 10px; padding-bottom: 10px; margin-top: -3px;}
		.col-sm-10 {width: 83.33333333%; margin-right: -4px;}

}

@media (max-width: 599px) {
	.nav>li>a {display: none;}
	div.well{padding-top: 0px; padding-bottom: 0px;}
	ul#t1{display: none;}
	#nowPlayingPanel {margin-top: 0px;}

}

.container-fluid {
	max-width: 1400px;
}

.mobile-width {
	max-width: 500px;
}		

.myGrey {
	color: #888;
}

.usbIcon {
	color: #C80;
}	

.youtubeIcon {
	color: #C22;
}

.mylink {
	cursor: pointer;
}

.breadcrumb {
	margin-bottom: 0px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}	

/*
ul.nav-pills {
	margin-bottom: 0.6em;
}	
*/

.scrollBoxHeader {
	margin-bottom: 0.3em;
}

.topBorder {
	border-style: solid;
	border-width: 2px 0px 0px 0px;
	border-colour: white;
}

#cdbox img {
	max-width:100%;
	max-height:100%;	
}

#canvasBox {
	margin: 10px 0px 0px 0px;
}

@font-face {
	font-family: 'icomoon';
	src:url('fonts/icomoon.woff');
}

.icon-radioMast:before {
	font-family: icomoon;
	content: "\e600";
}

#volumeSlider {
	/*margin: 1em;*/
	margin-top: 0.5em;
	margin-left: 1em;
	margin-right: 1em;
	margin-bottom: 0.5em;
}				

#progressSliderDiv {

	margin-left: 1em;
	margin-right: 1em;
	position: relative;
}	

#progressMask {
	position: absolute;
	left:0;
	top:0;
	background: rgba(28,30,34,0.7);
	height:100%;
	width:100%;
}	

.navbar-right {
	margin-right: 0px;
} 

.btn-group-right {
	margin-top: 6px;
	margin-right: 6px;
}

.nomargin {
	margin: 0px;
}	

.spaceForScrollbar {
	padding-right: 32px !important;
}	

.youtube>td {
	padding: 4px !important;
}	

.youtube>tr {
	padding-right: 10px !important;
}	

.leftjustified {
	text-align: left;
}	


#albumArtModal td {
	border: 0px;
}	

#albumArtModal .modal-body {
	padding: 5px;
}	

#nowPlayingWell {
	overflow: hidden;
}	

#handsetNav {
	padding: 0px 5px 0px 10px;
}	

#CDDBMessage {
	padding: 5px 10px 0px 10px;
}	

.lighter {
	background-color: #505050;
}

#CDDBDropdownUl>li {
	
	border-bottom: 2px solid black;
}	

#CDDBDropdownUl>li:last-child {
	
	border-bottom: none;
}	

.mw100 {
	max-width: 100%;
}
.mw80 {
	max-width: 80%;
}		

.w100 {
	width: 100%;
}
.w90 {
	width: 90%;
}
.w10 {
	width: 10%;
}
.h100 {
	height: 100%;
}	

.myflex {
    display: flex;
}

.mflex {
	display: flex;
    flex-basis:400px;
    max-width: 450px;
    min-width: 100px;

}

.flexV {
	display: flex;
	flex-direction: column;
}
.artflexV {
	display: flex;
	flex-direction: column-reverse;
}

.flex1 {
	flex: 1;
}

.listflex {
	flex: 1;
}

.flex2 {
	flex: 2;
}

.selfCentered {
	align-self: center;
}

.item { flex: 1 1 0; }



#menu2 {
	margin: 0px;
	display: flex;
}

.flexCenter {
	margin: auto;
}
			
.clipText {
	overflow: hidden;
	text-overflow: ellipsis;
}	

.row {
	margin-right: 0px;
}	

/* this works only because font-size is 12px and line-height is 1.1 */

.twoLines {
	max-height: 27px;
}	

#nowPlayingWell {
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}	

#playlistMenu {
	right: 0;
	left: auto;
}	

.notAButton {
	white-space: normal;
	text-align: left;
}	

.modal-header {
	padding: 5px;
}	

.modal-body {
	padding: 5px;
}	

.modal-footer {
	padding: 5px;
}	

#settingsModal td {
	padding: 4px !important;
}	

#settingsModal .checkbox {
	margin-top: 4px !important;
	margin-bottom: 4px !important;
}

#searchButtons {
	margin-top: 5px;
}

#settingsModal {
	overflow-y: scroll;
}			

#settingsModal .modal-dialog {
	max-width: 450px !important;
}	

#bluetoothModal .modal-dialog {
	max-width: 450px !important;
}

.myModalContent {
	padding: 20px;
}	

#addToPlaylistModal .modal-body {
	padding: 20px 0px 20px 0px;
}	

.textCenter {
	text-align: center;
}	

#folderUploading {
	margin-bottom: 15px;
}	

#playlistDropdownUl {
	max-height: 300px;
	overflow-y: scroll;
}

.disabledSlider {
	color: #666;
}	


.historyPic {
	position: relative;
}	

.historyCheck {
	position: absolute;
	right:5px;
	top:5px;
	color: #0F0;
}	
		
#sliders {
	margin: 20px 0px;
}

.eqslider {
	margin: 10px 0px 0px 0px;
}

.btn-lg, .btn-group-lg>.btn {
	padding: 7px;
	font-size: 14px;

}

#searchButtons .btn-lg, .btn-group-lg>.btn {
	padding: 10px;
}

</style> 


</head>
<body onresize="resize()">

 
<div class="container-fluid">

<!-- handset UI -->

			<div id="handsetNav" class="row">
<!--				<div class="well well-sm">-->
				<div class="col-md-4">
				<div class="btn-group">
					<a tabindex="-1" class ="navbar-brand" href="#" aria-hidden="true">Brennan B2</a>
				</div>	
				<div class="btn-group pull-right btn-group-right">

					<a id="selectedPanel" tabindex="0" href="#" class="btn btn-default dropdown-toggle" 
						data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" aria-label="Main Navigation - Now Playing Selected">
							Now Playing <span class="caret"></span></a>
							
					<ul class="dropdown-menu" role="menu">
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(0)">Now Playing</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(1)">Search</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(2)">vTuner</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(3)">Playlists</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(6)">Presets</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(9)">Youtube</a></li>	
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(4)">CD</a></li>												
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(5)">Upload</a></li>

<!--
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(7)">Album</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(8)">Artist</a></li>
-->												
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(10)">Settings</a></li>	
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(11)">USB</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(12)">Bluetooth</a></li>
					</ul>
					<a tabindex="-1" href="#" role="button" class="btn btn-default" onclick="panelBackFunction()">Back</a>					
				</div>
				</div>
<!--				</div>-->												
			</div>


 <div id="ColumnOne" class="col-xs-4">



	<div id="nowPlayingWell" class="well well-sm" ondragover="allowDrop(event)" ondrop="dropSpeaker(event)">

	
<!--	<a class="col-sm-2 btn btn-default" href="#" title="Random On Off" onclick="randomToggle()"><span id="randomIcon" class="glyphicon glyphicon-random" ></span></a>-->			

		<div id="nowPlayingTop" class="flex1 flexV">
			
			<ul class="nav nav-pills nav-stacked scrollBoxHeader" id="nowPlayingHeader">
				<li><a class="col-xs-10"><span>Brennan B2</span></a>
					<a id="settingsButton" class="col-xs-2 btn btn-default" href="#" title="Settings & Status" role="button" onclick="openSettingsModal()"><span class="glyphicon glyphicon-cog" ></span></a>			
				</li>	
			</ul>			

<!--			<div  data-toggle="tooltip" title="Drag items here to Play">-->

				<div id="nowPlayingDetails" class="panel-body flex1 mflex">
					<div class="flex2" id="nowPlayingBody"></div>
					<div class="flex1 mflex">
						<div class="artContainer">
							<div id="nowPlayingArt"><img class="flexArt" src="noimage.jpg"></div>
						</div>	
					</div>

				</div>



		<!-- </div> -->
		



		<div id="transport">

				<div id=canvasBox>
					<canvas id="mycanvas" width="100%" height="60" style="display:none;"></canvas>
				</div>	  

				<div>

					<div id="progressSliderDiv">    
						<input type="range" title="Progress" name="progressSlider" id="progressSlider" class="danielstern" min="0" max="1000" value="0">
						<small id="seekTimeLeft">Time left:</small>	
						<div id="progressMask"></div>				
					</div>

					<div id="volumeSlider">    
						<input type="range" title="Volume" name="slider-1" id="slider-1" class="danielstern" min="0" max="64" value="32">
						<small id="volume"></small>
					</div> 
					
				</div>	


</div>



				<div class="btn-group btn-group-justified">
					<a href="#" class="btn btn-default btn-lg" data-toggle="tooltip" title="Tone Control" onclick="openToneControl ()"><span class="glyphicon glyphicon-music"></span></a>				
					<a class="btn btn-default btn-block" href="#" data-toggle="tooltip" title="Random Play On/Off" onclick="randomToggle()"><span id="randomIcon" class="glyphicon glyphicon-random" ></span></a>
					<a href="#" class="transportButton btn btn-default" title="Back button" value='back'><span class="glyphicon glyphicon-backward"></span></a>
					<a href="#" class="transportButton btn btn-default" title="Play Stop button" value='play' id="playbutton"><span class="glyphicon glyphicon-play"></span></a>
					<a href="#" class="transportButton btn btn-default" title="Next button" value='next'><span class="glyphicon glyphicon-forward"></span></a>
				</div> 
						
		</div>	
 
	</div>




  <div id="playlistWell" class="well well-sm">

 <div id="playlistTabs" class="btn-group btn-group-justified">

	 <a id='playlistTab' class="btn btn-default" onclick="selectPlaylistSubPanel(0)">Playlists</a>
	 <a id='CDTab' class="btn btn-default" onclick="selectPlaylistSubPanel(1)">CD</a>
	 <a id='PresetsTab' class="btn btn-default" onclick="selectPlaylistSubPanel(2)">Presets</a>
	 <a id='UploadTab' class="btn btn-default" onclick="selectPlaylistSubPanel(3)">Upload</a>	 
 </div>


 <div class="tab-content" id="panel1">

<!-- Playlists -->


	<div id="playlistPanel" class="panelContent">

		<div class="scrollBoxHeader">
			

			<div id="playlistButtons" class="btn-group w100 myflex">
				
				<div class="dropdown myflex listflex">
				
					<a class="btn btn-default dropdown-toggle" title="Select playlist" id="menu1" data-toggle="dropdown" href="#" draggable="true" ondragstart="dragPlaylist(event)">
						<span class="caret flexCenter"></span></a>
					<ul class="dropdown-menu" id="playlistDropdownUl" role="menu">
					<li><a href="#">Red</a></li>
					</ul>
					<a class="btn btn-default clipText listflex" href="#"><span id="playlistChoice">Red</span></a>
				
				</div>

				<div class="dropdown dropleft">
					<a class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="#">
						<span class="glyphicon glyphicon-option-horizontal"></span></a>
					<ul class="dropdown-menu" id="playlistMenu" role="menu">
						<li><a href="#" onclick="renamePlaylist ()">Rename this playlist</a></li>
						<li><a href="#" onclick="deletePlaylist ()">Delete this playlist</a></li>
						<li><a href="#" onclick="createPlaylist ()">Create new playlist</a></li>
						<li><a href="#" onclick="mixPlaylist ()">Combine playlists</a></li>					
						<li><a href="#" onclick="assignPlaylist ()">Assign to Preset</a></li>	
					</ul>
				</div>	
<!--								
				<a tabindex="-1" class="btn btn-default iconToggle" href="#" data-toggle="tooltip" title="Search Only Current Playlist" onclick="playlistFilterToggle()"><span class="glyphicon glyphicon-list myGrey" id='playlistCheckbox'></span></a>
-->
			</div>


			      
		</div>

  
 		<div class="ScrollBox" id="playlistContainer">
			<table class="table table-hover">

				<tbody id="playlistTbody">
					<tr>
						<td>Empty</td>
					</tr>
				</tbody>
			</table>  
		</div> 
		
 	</div>
 
 
 <!-- CD -->
 

	<div id="CDPanel" class="panelContent">


		<div id="cdTitleBar" class="panel panel-default">
			<div class="panel-heading">
				<div class="btn-group pull-right">
<!--					<a href="#" class="btn btn-default" onclick="ripFunction()" data-toggle="tooltip" title="Rip CD">Rip</a>-->
<!--					<a href="#" class="btn btn-default" onclick="ripFunction()" data-toggle="tooltip" title="Rip CD"><span class="glyphicon glyphicon-save"></a>-->
<!--					<a href="#" class="btn btn-default"onclick="ejectFunction()"  data-toggle="tooltip" title="Eject CD"><span class="glyphicon glyphicon-eject"></a>-->
<!--					<a href="#" class="btn btn-default transportButton" value='eject' data-toggle="tooltip" title="Eject CD"><span class="glyphicon glyphicon-eject"></a>-->		
<!--					<a href="#" class="btn btn-default" onclick="getArtFunction()" data-toggle="tooltip" title="Get Album Art">Art</a>-->

				</div>
				<h4 id="cdstatus">status</h4>
			</div>
		</div>

        
		<div class="scrollBoxHeader" id="CDDBPanel">
				
				<p id="CDDBMessage"></p>
			
				<div class="btn-group dropleft w100 myflex">
					

					<a class="btn btn-default dropdown-toggle" id="menu2" data-toggle="dropdown" href="#">
						<span class="caret flexCenter"></span></a>
					<ul class="dropdown-menu" id="CDDBDropdownUl">
						<li><a href="#">Dark Side of The Moon</a></li>
					</ul>
<!--					<a class="btn btn-default" href="#"><span class="flex1" id="cddbChoice">CDDB</span></a>-->
					<div class="btn btn-default notAButton flex1"><span id="cddbChoice">CDDB</span></div>
					
					<a class="btn btn-default myflex" href="#" onclick="ripFunction()"><span class="flexCenter">Rip</span></a>
				</div> 
			

		<a href="#" class="btn btn-default btn-block" id="artButton" onclick="getArtFunction()" >Get Cover Art</a>

		</div>        

        
		<div id="fetchingArt">
			<img src="ajax-loader.gif">
		</div>	        

		<div id="cdbox">  
		</div>
 
	</div>
 
 
 <!-- Upload -->
 
 	<div id="UploadPanel" class="panelContent">
 
  	<div>
		<div>

			<div>
				<div>
					<fieldset class="form-group">
						<div class="form-check">
							<label class="form-check-label">
								<input type="radio" class="form-check-input" name="uploadOptions" id="bulkOption" value="bulkOption" checked="" onclick="uploadSelect()">
								Bulk upload - pick a folder, uploads all music and art below
							</label>
						</div>
						<div class="form-check">
							<label class="form-check-label">
								<input type="radio" class="form-check-input" name="uploadOptions" value="fileOption" onclick="uploadSelect()">
								File upload - specify Artist and Album, then pick files.
							</label>
						</div>
					</fieldset>
					<div id="bulkDiv">
						<div id="bulkForm" class="form-group">
							<input id="folderUpload" type="file" class="form-control" placeholder="Folder" webkitdirectory mozdirectory onchange="folderUploadOnChange(this)">
						</div>
						<div id="folderUploading">
							<img src="ajax-loader.gif"><span id="folderUploadProgress">&nbsp&nbsp&nbspSending Files</span>
						</div>
						<p id="unknownWarning" class="text-warning">Folders hidden by browser for security reasons - music uploaded to Artist/Album Unknown</p>					

						<button type="button" class="btn btn-default" onclick="folderUploadCancel()">Cancel</button>		  
					</div>
					<div id="fileDiv">
						<div class="form-group">
							<input id="uploadAlbum" type="text" class="form-control" placeholder="Type album name here">
						</div>
						<div class="form-group">
							<input id="uploadArtist" type="text" class="form-control" placeholder="Type artist here">
						</div>	
						<div class="form-group">
							<input id="uploadFileSelect" type="file" class="form-control" multiple/>
						</div>
						<div id="uploading">
							<img src="ajax-loader.gif"><span id="uploadProgress">&nbsp&nbsp&nbspSending Files</span>
						</div>
						<button type="button" class="btn btn-default" onclick="uploadCancelFunction()">Cancel</button>		  
						<button type="button" class="btn btn-default" onclick="uploadFunction()">Send to B2</button>
					</div>	
				</div>
			</div>
		</div>
	</div>
  
  
	</div>
 
 
  <!-- Presets -->
 
 	<div id="PresetsPanel" class="panelContent">

	<div class="ScrollBox collapse in" id="presetsBox">  
		<table class="table table-hover">
			<tbody id="presets"></tbody>
		</table> 
	</div> 

	</div>

  </div>


  </div>
  
 </div>


<!-- Rename Modal -->
	<div id="myModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

    <!-- Modal content-->
			<div class="modal-content myModalContent">
				<div class="modal-header">
<!--        <button type="button" class="close" data-dismiss="modal">&times;</button>-->
					<h4 id="renameTitle" class="modal-title">Rename Track</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<input id="renameValue" type="text" class="form-control" value="Initial Track Name">
					</div>
					<div id="renameArtist" class="form-group">
						<label for="renameSecondValue">Artist</label>  
						<input id="renameSecondValue" type="text" class="form-control" value="Parent Artist">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="renameOKFunction()">OK</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>


<!-- Playlist Mix Modal -->
	<div id="mixModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<h4 id="mixTitle" class="textCenter modal-title">Combine Playlists</h4>
				</div>
				<div class="modal-body">

					<div class="btn-group btn-block">
						<a class="btn btn-default btn-block dropdown-toggle" id="mixMenu1" data-toggle="dropdown" href="#">Add
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="mixModeDropdownUl" role="menu">
							<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickMode(0)">Append</a></li>						
							<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickMode(1)">Subtract</a></li>						
							<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickMode(2)">Merge</a></li>
						</ul>
					</div>
					

					<div class="btn-group  btn-block">
						<a class="btn btn-default  btn-block dropdown-toggle" id="mixMenu2" data-toggle="dropdown" href="#">Red
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="mixSourceDropdownUl">
							<li><a href="#">Red</a></li>
							<li><a href="#">Orange</a></li>
						</ul>
					</div>

					
					<h4 class="textCenter" id="mixText">To</h4>

					<div>
					<div class="btn-group btn-block">
						<a class="btn btn-default btn-block dropdown-toggle" id="mixMenu3" data-toggle="dropdown" href="#">Red
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="mixDestDropdownUl">
							<li><a href="#">Red</a></li>
							<li><a href="#">Orange</a></li>
						</ul>
					</div>
					</div>

					<p class="text-muted"><br />Append adds to end and allows duplicates</p> 
					<p class="text-muted">Merge adds but removes duplicates</p> 
					<p class="text-muted">Subtract removes items in the first from the second - very smart - for example if you subtract an Artist it will remove tracks and albums by that artist</p> 					
					<p class="text-muted">Use All Music to create a playlist containing all your music - as a starting point</p> 

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="mixOKFunction()">OK</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>
	
<!-- New Playlist Modal -->
	<div id="newPlaylistModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<h4 class="modal-title">Create a New Playlist</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<input id="newPlaylistValue" type="text" class="form-control" placeholder="Playlist Name">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="newPlaylistOKFunction()">OK</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>	
	
<!-- Search Item Modal -->
	<div id="searchItemModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class=modal-header>
					<p class="textCenter" id="searchItemTitle" class="modal-title">Search Item</p>
				</div>	
				<div class="modal-body">
					<button type="button" class="btn btn-default btn-block" onclick="searchItemDeleteButton()" >Delete</button>	
					<button type="button" class="btn btn-default btn-block" onclick="searchItemAddButton()" >Add To Playlist</button>
					<button type="button" class="btn btn-default btn-block" onclick="searchItemRenameButton()" >Rename</button>
					<button type="button" class="btn btn-default btn-block artButton" onclick="searchItemArt()" >Get Art (Musicbrainz)</button>
					<button type="button" class="btn btn-default btn-block artButton" onclick="searchItemArt2()" >Get Art (Amazon)</button>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
<!--					<button type="button" class="btn btn-default">OK</button>-->
				</div>
			</div>
		</div>
	</div>	

<!-- Album Art Modal -->
	<div id="albumArtModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<p class="textCenter" id="albumArtTitle">Album Art Search</p>
					<p class="textCenter" id="albumArtArtist"></p>
					<p class="textCenter" id="albumArtAlbum"></p>
				</div>
				<div class="modal-body">
					<table class="table table-hover">
						<tbody id="albumArtResultsTable"></tbody>
					</table>
					<div id="artSearching"> <img class="fit" src="ajax-loader.gif"></div>
					<p class="text-muted" id="albumArtBottomLine"></p> 
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>	


<!-- Playlist Item Modal -->
	<div id="playlistItemModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<p id="playlistItemTitle" class="modal-title textCenter">Playlist Item</p>
				</div>
				<div class="modal-body">
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemDeleteButton()" >Delete</button>	
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemStartButton()" >Move to start</button>
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemEndButton()" >Move to end</button>
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemUpButton()" >Move up</button>
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemDownButton()" >Move down</button>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Finished</button>		  
<!--					<button type="button" class="btn btn-default">OK</button>-->
				</div>
			</div>
		</div>
	</div>	

<!-- vTuner Search Item Menu Modal -->
	<div id="vTunerSearchMenuModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<p id="vTunerSearchMenuTitle" class="modal-title">Search Item</p>
				</div>
				<div class="modal-body" id="vTunerSearchMenuBody">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>	

<!-- vTuner Item Menu Modal -->
	<div id="vTunerItemMenuModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<p id="vTunerItemMenuTitle" class="modal-title">Search Item</p>
				</div>
				<div class="modal-body" id="vTunerItemMenuBody">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>	

<!-- Tone Control Modal -->
<!--
	<div id="toneModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<p class="modal-title">Tone Control</p>
				</div>
				<div class="modal-body">
					<h3>Bass</h3>
					<input type="range" title="Bass" name="bassSlider" id="bassSlider" min="-6" max="6" value="0">					
					<h3>Treble</h3>
					<input type="range" title="Treble" name="trebleSlider" id="trebleSlider" min="-6" max="6" value="0">	
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>		  
				</div>
			</div>
		</div>
	</div>	
-->
	<div id="toneModal" class="modal" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content myModalContent">
				<div class="modal-header">
					<p class="modal-title">Equaliser</p> 
					<span class="checkbox">
						<label>
							<input type="checkbox" id="equaliser" onclick="equaliserClick()"> Enabled
						</label>
					</span>
				</div>
				<div class="modal-body" id="sliders">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="equaliserFlat()">Flat</button>					
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>		  
				</div>
			</div>
		</div>
	</div>


<!-- Are You Sure Modal -->
	<div id="areYouSureModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-body">

					<p class="textCenter"><span class="text-muted">Delete </span>					
						<span id="areYouSureTitle" class="modal-title">Name</span></p><br />
					<h4 class="textCenter text-warning">Are You Sure?</h4><br />
				</div>
				<div class="btn-group btn-group-justified">

					<a href="#" class="btn btn-default" onclick="deleteConfirmed ()">Delete</a>					  
					<a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>

				</div>				
			</div>
		</div>
	</div>

<!-- General Are You Sure Modal -->
	<div id="generalAreYouSureModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-body">
					
					<p class="textCenter"><span id="generalAreYouSureTitle" class="modal-title">Name</span></p><br />
					<h4 class="textCenter text-warning">Are You Sure?</h4><br />					

				</div>

				<div class="btn-group btn-group-justified">
					<a type="button" class="btn btn-default" onclick="areYouSureAction()">Confirm</a>
					<a type="button" class="btn btn-default" data-dismiss="modal">Cancel</a>		  

				</div>
			</div>
		</div>
	</div>


	<div id="guestModeModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-body">
					<h5 class="textCenter text-warning">Sorry can't make changes in Guest Mode</h4><br />										
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">OK</button>		  
				</div>
			</div>
		</div>
	</div>

<!-- Alert Modal -->
	<div id="alertModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
				<div class="modal-body">
					<h5 class="textCenter text-warning" id="alertModalText" >Text</h5>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">OK</button>		  
				</div>
			</div>
		</div>
	</div>


<!-- Add To Playlist Modal -->
	<div id="addToPlaylistModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content myModalContent">
		
				<div class="modal-body">



						<p class="textCenter"><span class="text-muted">Add </span>
								<span id="addToPlaylistTitle" class="modal-title">Name</span>
								<span class="text-muted"> to Playlist</span></p>
						
							<div class="btn-group btn-block">
							<a class="btn btn-default btn-block dropdown-toggle" id="addToPlaylistMenu" data-toggle="dropdown" href="#">Red
								<span class="caret"></span></a>
								<ul class="dropdown-menu" id="addToPlaylistDropdownUl">
									<li><a href="#">Red</a></li>
									<li><a href="#">Orange</a></li>
								</ul>
							</div>						
						
						</td></tr>



				</div>
				<div class="btn-group btn-group-justified">

					<a href="#" class="btn btn-default" onclick="addToPlaylistOK ()">OK</a>					  
					<a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>

				</div>
			</div>
		</div>
	</div>


<!-- Podcast Modal -->
	<div id="podcastModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

    <!-- Modal content-->
			<div class="modal-content myModalContent">
				<div class="modal-header">
					<h4 class="modal-title">Podcast</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<input id="podcastValue" type="text" class="form-control" placeholder="Podcast URL">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="podcastPlayFunction()">Play</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>


<!-- bTube Debug Modal -->
	<div id="bTubeDebugModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

    <!-- Modal content-->
			<div class="modal-content myModalContent">
				<div class="modal-header">
					<h4 class="modal-title">bTube Debug</h4>
				</div>
				<div class="modal-body">
					<ol>
						<li><a class="mylink" onclick="deleteP3()">Delete P3</a></li>
						<li><a class="mylink" onclick="quitProgram()">Quit Program</a></li>
						<li><a class="mylink" onclick="reboot()">Reboot</a></li>
					</ol>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>

	
 <div id="ColumnTwo" class="col-xs-4">

 <div class="well well-sm id="middleWell">
	 
	<div id="searchTabs" class="btn-group btn-group-justified">

		<a id='SearchTab' class="btn btn-default" onclick="selectSearchSubPanel(0)"><span class="glyphicon glyphicon-search"></span></a>
		<a id='VTunerTab' class="btn btn-default myGrey" onclick="selectSearchSubPanel(1)">vTuner</a>
		<a id='YoutubeTab' class="btn btn-default myGrey" onclick="selectSearchSubPanel(2)" data-toggle="tooltip" title="Experimental" >Youtube*</a>
		<a id='USBTab' class="btn btn-default myGrey" onclick="selectSearchSubPanel(3)">USB</a>
 
	</div>	 	 
	 
 <div class="tab-content" id="panel2">


<!-- Search -->


	<div id="SearchPanel" class="panelContent tab-pane">	 
	
		<div id="searchControls" class="scrollBoxHeader topButtons">
			<div>
				<input type="text" id="searchInput" class="form-control" size="6" placeholder="Search B2" onkeyup="searchFunction()">
			</div>
				
			<div>
			<div id="searchButtons" class="btn-group btn-group-justified">
				<a class="btn btn-default btn-lg" onclick="toggleArtist()" href="#" title="Artists toggle"><span class="glyphicon glyphicon-user" id='artistCheckbox'></span></a>
				<a class="btn btn-default btn-lg" onclick="toggleAlbum()" href="#" title="Albums toggle"><span class="glyphicon glyphicon-cd myGrey" id='albumCheckbox'></span></a>
				<a class="btn btn-default btn-lg" onclick="toggleTrack()" href="#" title="Tracks toggle"><span class="glyphicon glyphicon-music myGrey" id='trackCheckbox'></span></a>	
				<a class="btn btn-default btn-lg" onclick="toggleVideo()" href="#" title="Video toggle"><span class="glyphicon glyphicon-facetime-video myGrey" id='videoCheckbox'></span></a>	
<!--				<a id="radioButton" class="btn btn-default iconToggle" href="#" title="Radio Stations toggle"><span class="icon-radioMast" id='radioCheckbox'></span></a>   -->
				<a class="btn btn-default btn-lg" href="#" data-toggle="tooltip" title="Alpha Sort On/Off" onclick="alphaToggle()"><span id="alphaIcon" class="glyphicon glyphicon-sort-by-alphabet" ></span></a>
				<a class="btn btn-default btn-lg iconToggle" href="#" data-toggle="tooltip" title="Search Only Current Playlist"><span class="glyphicon glyphicon-list myGrey" id='playlistCheckbox'></span></a>
			</div> 
			</div>
		</div>

		<div class="SearchScrollBox" id="SearchContainer">  
			<table class="table table-hover">
				<tbody id="Results"></tbody>
			</table> 
		</div>  
		
	</div>
	
<!-- vTuner -->

	<div id="VTunerPanel" class="panelContent tab-pane">	

		<div class="scrollBoxHeader">
			<div id="vTunerButtons" class="btn-group topButtons">
				<a href="#" data-toggle="tooltip" title="Go Back" class="btn btn-default" onclick="vTunerGoBack ()">Back</a>
				<a href="#" data-toggle="tooltip" title="World" class="btn btn-default" onclick="vTunerInit ()">Top</a>

			</div>      
		</div>


		<div class="vTunerScrollBox" id="vTunerBox">  
			<table class="table table-hover">
				<tbody id="vTunerTable" role="list" aria-label="vTuner categories"></tbody>
			</table> 
		</div>  
		
		<div style="height:10px;"></div>

		<div class="input-group scrollBoxHeader">
			<input type="text" id="vTunerSearchInput" class="form-control" size="6" placeholder="Search vTuner" onkeydown = "if (event.keyCode == 13) vTunerSearch ()">
			<div class="input-group-btn">
				<a class="btn btn-default" onclick="vTunerSearch ()" href="#"><span class="glyphicon glyphicon-search"></span></a>
			</div>				
		</div>
		
		<div class="vTunerScrollBox" id="vTunerSearchBox">  
			<table class="table table-hover">
				<tbody id="vTunerMatches"></tbody>
			</table> 
		</div>  
	</div>
	
	
<!-- Youtube -->

	<div id="YoutubePanel" class="panelContent tab-pane">	

		<div class="input-group scrollBoxHeader topButtons" id="youtubeSearchBar">
			<div>
				<input id="bTubeSearchValue" onkeydown = "if (event.keyCode == 13) youtubeGo ()" type="text" class="form-control" placeholder="Text search or Youtube url or id">
			</div>
			<div class="input-group-btn">
					<button type="button" class="btn btn-default" onclick="youtubeGo()">
						<span class="glyphicon glyphicon-search"></span>
					</button>
			</div> 

		</div>

				<div class="panel panel-default" >
					<div class="panel-heading" id="youtubeSearchHeading">Search results <span id="youtubeSearching"> <img class="fit" src="ajax-loader.gif"></span></div>
					<div class="panel-body vTunerScrollBox" id="YoutubeSearchResultsBox">
						<table class="table table-hover">
							<tbody id="youtubeSearchResultsTable"></tbody>
						</table> 
							
					</div>				
				</div>

				<div class="panel panel-default" >
					<div class="panel-heading">History <span id="youtubeStarting"> <img class="fit" src="ajax-loader.gif"></span></div>
					<div class="panel-body  vTunerScrollBox" id="YoutubeHistoryBox">
						<table class="table table-hover" >
							<tbody id="youtubeHistoryTable"></tbody>
						</table>
					</div> 
				</div>


		
	</div>	
	

<!-- USB -->

	<div id="USBPanel" class="panelContent tab-pane">	

		<ol class="breadcrumb topButtons" id="USBBreadcrumb">
			<li class="breadcrumb-item" id="USBPath"></li>
		</ol>
		<div id="USBButtons" class="btn-group">
			<button type="button" class="btn btn-default" data-toggle="tooltip" title="Up to parent folder" onclick="usbUp ()">Up</button>
			<button type="button" class="btn btn-default" data-toggle="tooltip" title="Select USB A" onclick="usbA ()">USB A</button>
			<button type="button" class="btn btn-default" data-toggle="tooltip" title="Select USB C" onclick="usbC ()">USB C</button>					
		</div>
		<div class="panel-body USBScrollBox" id="USBItemsBox">
			<table class="table table-hover">
				<tbody id="USBItems"></tbody>
			</table>
		</div>	
		<ol class="breadcrumb">
			<li class="breadcrumb-item" id="USBBackgroundText"></li>
		</ol>		
	</div>

	
	
</div>		
		

 </div>
 
 
 </div>


 
 <div id="ColumnThree" class="col-xs-4">

	<div id="ArtistWell" class="well well-sm">	 
	  
<!-- Artist -->


		<div id="ArtistPanel">	 


			<ul class="nav nav-pills nav-stacked scrollBoxHeader" id="artistHeader">
				<li><a><span class="text-muted">Artist </span><span id="artistname">None Selected</span></a>
<!--					<a id="settingsButton" tabindex="-1" class="col-xs-2 btn btn-default" href="#" title="Settings & Status" role="button" onclick="openSettingsModal()"><span class="glyphicon glyphicon-cog" ></span></a>			-->
				</li>	
			</ul>

			<div class="panelContent ArtistScrollBox">
				<nav id="ArtistAlbumsBox">  
					<table class="table table-hover">
						<tbody id="ArtistAlbums"></tbody>
					</table>
				</nav> 
			</div> 
		</div>
	</div> 
	
	<div id="AlbumWell" class="well well-sm">	 
	  
<!-- Album -->

		<div id="AlbumPanel">	 

			<ul class="nav nav-pills nav-stacked scrollBoxHeader" id="albumHeader" onClick="clickArt()" ondragover="allowDrop(event)" ondrop="dropArt(event)" onpaste="pasteArt(event)" data-toggle="tooltip" title="Drag Artwork here
or click image to open upload panel">

				<li>
					<a class="middle">
						<div class="npInline w80"><span class="text-muted">Album </span><span id="albumname">None Selected</span></div>
						<div class="npInline w20"><img id="albumImage" src="noimage.jpg"></div>
					</a>
					
<!--					<a><span class="text-muted">Album </span><span id="albumname">None Selected</span><img id="albumImage" class="pull-right"></a>-->
<!--					<a class="col-sm-10"><span class="text-muted">Album </span><span id="albumname">None Selected</span></a>-->
					

				</li>	

			</ul>
			
			<div class="panelContent ArtistScrollBox">
				<nav id="AlbumTracksBox">  
					<table class="table table-hover">
						<tbody id="AlbumTracks"></tbody>
					</table> 
				</nav>	
			</div>
	
		</div>
	</div>	
	
</div>


<!-- Debug Modal -->
	<div id="debugModal" class="modal" role="dialog">
		<div class="modal-dialog modal-lg">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Debug</h4></br>
				</div>
				<div class="modal-body">

					<div id="debugText">

					</div>


				</div>
				<div class="modal-footer">
					
<!--
					<div class="btn-group">
						<a class="btn btn-default dropdown-toggle" title="Logging Mode" id="loggingMenu" data-toggle="dropdown" href="#">Normal <span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="#" onclick="setLogging('Normal')">Normal</a></li>
							<li><a href="#" onclick="setLogging('File')">File</a></li>
							<li><a href="#" onclick="setLogging('TV Off')">TV Off</a></li>
						</ul>
					</div>
-->					
					
<!--					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>-->
					<button type="button" class="btn btn-default" onclick="clearDebugModal()">Clear</button>
					<button type="button" class="btn btn-default" onclick="closeDebugModal()">Close</button>					
<!--					<button type="button" class="btn btn-default" onclick="refreshDebug()">Refresh</button>-->
				</div>
			</div>
		</div>
	</div>

<!-- Settings & Status Modal -->
	<div id="settingsModal" class="modal" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-header">
					
					<ul class="nav nav-pills nav-stacked scrollBoxHeader">
						<li><a class="col-xs-10"><span>Settings & Status</span></a>
							<a class="col-xs-2 btn btn-default" data-dismiss="modal"><span>X</span></a>			
						</li>	
					</ul>					
<!--					
					<h4 class="modal-title">Settings & Status
					<button type="button" class="btn btn-default pull-right" data-dismiss="modal">X</button>
					</h4>
-->					
				</div>
				<div class="modal-body">
					<div id="settingsBody">

					</div>

					<table class="table">
						<tbody>

							<tr>
								<td>
									<div class="btn-group btn-block">
										<a class="btn btn-default btn-block dropdown-toggle" title="Compression Mode" id="compressionMenu" data-toggle="dropdown" href="#">FLAC <span class="caret"></span></a>
										<ul class="dropdown-menu">
											<li><a href="#" onclick="setCompression('FLAC')">FLAC</a></li>
											<li><a href="#" onclick="setCompression('MP3 128K')">MP3 128K</a></li>
											<li><a href="#" onclick="setCompression('MP3 256K')">MP3 256K</a></li>	
											<li><a href="#" onclick="setCompression('None')">None</a></li>							
										</ul>
									</div>									
								</td>
								<td class="col-sm-10" >Compression Mode</td>
							</tr>

							<tr>
								<td>
									<div class="btn-group btn-block">
										<a class="btn btn-default btn-block  dropdown-toggle" title="Segue Mode" id="segueMenu" data-toggle="dropdown" href="#">Off <span class="caret"></span></a>
										<ul class="dropdown-menu">
											<li><a href="#" onclick="setSegue('Off')">Off</a></li>
											<li><a href="#" onclick="setSegue('On')">On</a></li>
											<li><a href="#" onclick="setSegue('Short')">Short</a></li>							
										</ul>
									</div>									
								</td>
								<td class="col-sm-10" >Segue Mode</td>
							</tr>

							<tr>
								<td>
									<a class="btn btn-default btn-block" href="#" data-toggle="tooltip" title="Scan Disk" onclick="scanDisk()">Scan</a>
								</td>
								<td class="col-sm-10" >Scan Disk</td>
							</tr>

							<tr>
								<td colspan="2">
									<div class="radio">
										<label><input onclick="webModeClick()" type="radio" id="webModeAuto" name="webMode" value="normal" checked>Automatic</label>
										<label><input onclick="webModeClick()" type="radio" id="webModeMobile" name="webMode" value="mobile" >Force Mobile</label>
										<label><input onclick="webModeClick()" type="radio" id="webModeDesktop" name="webMode" value="desktop" >Force Desktop</label>

									</div>
								</td>
							</tr>


							<tr>
								<td class="col-sm-3">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="guestMode" onclick="guestModeClick()"> Guest Mode
										</label>
									</div>
								</td>
								<td class="col-sm-9">
									<div class="btn-group">
										<a class="btn btn-default dropdown-toggle" id="guestMenu" data-toggle="dropdown" href="#">Red
											<span class="caret"></span></a>
										<ul class="dropdown-menu" id="guestDropdownUl">
											<li><a href="#">Red</a></li>
											<li><a href="#">Orange</a></li>
										</ul>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="tvUi" onclick="tvUiClick()"> Enable TV UI
										</label>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="hdmi" onclick="HDMIClick()"> Audio on HDMI (TV)
										</label>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="vCache" onclick="vCacheClick()"> Enable Youtube Cache
										</label>
									</div>
								</td>
							</tr>

							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label><input onclick="bigPictureClick()" type="checkbox" id="webBigPicture">Big Picture</label>
									</div>
								</td>
							</tr>
							
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label><input onclick="defaultUIClick()" type="checkbox" id="webDefaultUI">Default to Mobile on this Browser</label>
									</div>
								</td>
							</tr>
							
							<tr>
								<td>Background</td>
								<td id="backgroundText" class="col-sm-10" ></td>
							</tr>
							
						</tbody>
					</table> 


				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-default" data-toggle="tooltip" title="B2 Debug Window" onclick="openDebugModal ()"><span class="glyphicon glyphicon-wrench" ></span></button>
					<button type="button" class="btn btn-default" data-toggle="tooltip" title="Bluetooth" onclick="openBluetoothModal ()"><span>Bluetooth</span></button>
<!--					<button type="button" class="btn btn-default" data-toggle="tooltip" title="B2 Image Viewer" onclick="openJBV ()"><span class="glyphicon glyphicon-camera" ></span></button>-->
<!--					<button type="button" class="btn btn-default" data-toggle="tooltip" title="Youtube" onclick="openBTube ()"><span class="glyphicon glyphicon-film" ></span></button>-->
				</div>
			</div>
		</div>
	</div>

</div>



<!-- Bluetooth Modal -->
	<div id="bluetoothModal" class="modal" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Bluetooth  <span id="bluetoothBusy"><img src="ajax-loader.gif"></span></h4></br>
				</div>
				<div class="modal-body">
					<div id="bluetoothBody">

					</div>
					<a class="btn btn-default" href="#" data-toggle="tooltip" title="Update Paired Devices" onclick="listDevices()">Refresh Paired Devices</a>
					<a class="btn btn-default b2Only" href="#" data-toggle="tooltip" title="Scan" onclick="scanBluetooth()">Scan Bluetooth</a>
					<a class="btn btn-default" href="#" data-toggle="tooltip" title="Reset" onclick="resetBluetooth1()">Reset Bluetooth</a>
					<div class="checkbox b2Only"><label>
						<input id="tandemBox" type="checkbox" onclick="tandemClick()">Bluetooth and wired speakers together
					</label></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="closeBluetoothModal ()">Close</button>
				</div>
			</div>
		</div>
	</div>


</div>





<script>
	
var playlists;
var selectedPlaylist;
var selectedAlbum;
var selectedAlbumName;
var selectedArtistName;
var playlist;
var albumTracks;
var artistAlbums;
var nowPlaying;
var renameID;
var renameOldName;
var renameOldArtist;
var lastDiscid;
var lastCDLoaded;
var smoothie;
var vuLine1;
var cddb;
var selectedcddb;
var currentUpload;
var uploadTry;
var uploadArtist;
var uploadAlbum;
var uploadFiles;
var lastVolume;
var mouseOverSlider = false;
var mouseOverProgressSlider = false;
var bpsuTimer;
var enableProgressSliderUpdates = true;
var lastWidth;
var	th = 990;
var searchOffset;
var selectedSource;
var selectedDest;
var selectedMode;
var lastRandom;
var lastSorted;
var lastBackground;
var lastCompression;
var lastSegue;
var lastLogging;
var lastTvUi;
var lastHDMI;
var lastvCache;
var lastEqualiser;
var lastBluetoothStatus;
var lastGuest;

function isTrack (id){
	return ((id >= 2000000)&&(id < 3000000));
}

function isAlbum (id){	
	return ((id >= 1000000)&&(id < 2000000));
}

function isArtist (id){	
	return ((id >= 3000000)&&(id < 4000000));
}

function isPlaylist (id){	
	return ((id >= 4000000)&&(id < 5000000));
}

function isRadio (id){	
	return ((id >= 5000000)&&(id < 6000000));
}

function isVideo (id){	
	return ((id >= 8000000)&&(id < 9000000));
}

function isUSBAlbum (id){	
	return ((id >= 9000000)&&(id < 10000000));
}

function isUSBTrack (id){	
	return ((id >= 10000000)&&(id < 11000000));
}

function isUSBArtist (id){	
	return ((id >= 11000000)&&(id < 12000000));
}

function isPlaylistIndex (id){
	return (id < 1000000);
}

function playlistToID (index){
	return 4000000+index;
}	

function trackIcon () {return '<span class="glyphicon glyphicon-music"></span>'};
function artistIcon () {return '<span class="glyphicon glyphicon-user"></span>'};
function albumIcon () {return '<span class="glyphicon glyphicon-cd"></span>'};

function USBTrackIcon () {return '<span class="glyphicon glyphicon-music usbIcon"></span>'};
function USBArtistIcon () {return '<span class="glyphicon glyphicon-user usbIcon"></span>'};
function USBAlbumIcon () {return '<span class="glyphicon glyphicon-cd usbIcon"></span>'};

/*
function USBTrackIcon () {return '<span class="glyphicon glyphicon-hdd"> </span><span class="glyphicon glyphicon-music"></span>'};
function USBArtistIcon () {return '<span class="glyphicon glyphicon-hdd"> <span class="glyphicon glyphicon-user"></span>'};
function USBAlbumIcon () {return '<span class="glyphicon glyphicon-hdd"> <span class="glyphicon glyphicon-cd"></span>'};
*/

function getIcon (id){
	if (isTrack(id)) return trackIcon();
	if (isArtist(id)) return artistIcon();
	if (isPlaylist(id)) return '<span class="glyphicon glyphicon-th-list"></span>';
	if (isAlbum(id)) return albumIcon();
	if (isRadio(id)) return ' <span class="icon-radioMast"></span> ';
//	if (isVideo(id)) return ' <span class="glyphicon glyphicon-film"></span> ';
//	if (isVideo(id)) return ' <span class="glyphicon glyphicon-expand youtubeIcon"></span> ';
	if (isVideo(id)) return ' <span class="glyphicon glyphicon-facetime-video youtubeIcon"> </span> ';
	if (isUSBTrack(id)) return USBTrackIcon();
	if (isUSBArtist(id)) return USBArtistIcon();
	if (isUSBAlbum(id)) return USBAlbumIcon();
	return '<span class="glyphicon glyphicon-exclamation-sign"></span>';		
}	
	
		


function refreshPlaylistsFunction () {
	var urlTail = 'listplaylists&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		playlists = data;
		var ul = $('#playlistDropdownUl');
		ul.children().remove();
		var l = data.length;
//		ul.append('<h4 class="dropdown-header">Pick a playlist</h4>');
		for (var i=0;i<l;i++){ 
			ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickPlaylist('+i+')">'
				+data[i].name+' ('+data[i].length+')</a></li>');
		}
		if (selectedPlaylist >= data.length) selectedPlaylist = 0;
		pickPlaylist (selectedPlaylist);				
	});	
};



function listPlaylistsFunction () {

	selectedPlaylist = 0;
	refreshPlaylistsFunction ();
	
};


function playlistItem (list,i){

/*
	return '<tr><td  class="mylink" onclick="playlistItemClick(event)" ondblclick="playlistItemRename('+i+')" ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')" draggable="true" ondragstart="dragPlaylistItem(event)">'
				+getIcon(list[i].id)+' '+stripClass(list[i].name)+'</td></tr>';	
		
*/

	return $('<tr class="mylink"><td><span class="glyphicon glyphicon-play" onclick="playPlaylistItemFunction('+i+')"</span></td>'+
				'<td class="col-sm-10" onclick="playlistItemClick(event)" ondblclick="playlistItemRename('+i+')" ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')" draggable="true" ondragstart="dragPlaylistItem(event)">'
				+getIcon(list[i].id)+' '+stripClass(list[i].name)+'</td>'+
				'<td><span class="glyphicon glyphicon-option-horizontal" onclick="playlistItemFunction('+i+')"</span></td>'+
				'</tr>');

}

function listPlaylistFunction (index) {
	id = index+4000000;

	var urlTail = 'listplaylist&id='+id+" &"+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		var tbody = $('#playlistTbody');
		tbody.children().remove();
		playlist = data;
		var l = data.length;


		for (var i=0;i<l;i++){ 
/*
			tbody.append('<tr><td  class="mylink" onclick="playlistItemClick(event)" ondblclick="playlistItemRename('+i+')" ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')" draggable="true" ondragstart="dragPlaylistItem(event)">'
				+getIcon(data[i].id)+' '+stripClass(data[i].name)+'</td></tr>');
*/				
			tbody.append(playlistItem(data,i));
			
		}	
		tbody.append('<tr><td></td><td  ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')">'
			+'--end--</td><td></td></tr>');

		box = $('#playlistContainer');
		box.scrollTop(0);	
		box.perfectScrollbar ('update');
		
	});	
};


function playPlaylistItemFunction (index){
	
	console.log ("playPlaylistItemFunction () id="+playlist[index].id);

//	command = 'playID&'+playlist[index].id+'&' + new Date ().getTime()
//	$.get('b2cgi.fcgi',command,function(data){});
	
	var pid = selectedPlaylist+4000000;
	var command = 'startPlaylist&playlist='+pid+'&id='+playlist[index].id+'&time='+ new Date ().getTime();		// IE;
	$.get('b2cgi.fcgi',command,function(data){});

		
}		

function pickPlaylist (i){
	
	if ((lastGuest==1)&&(lastGuestPlaylist > 0)&&(i != lastGuestPlaylist-1)) {
		$('#guestModeModal').modal();			
		return;
	}
	
	selectedPlaylist = i;
	
//	$("#menu1").html(playlists[i].name+' <span class="caret"></span>');
	$("#playlistChoice").text(playlists[i].name);
	listPlaylistFunction (i);
	
	
	if (!$("#playlistCheckbox").hasClass ("myGrey")) searchFunction ();	

}

function playlistItemFunction (index){

	console.log ("playlistItemFunction ("+index+")");

	selectedPlaylistItem = index;
	
	var name = playlist[index].name;
	var id = playlist[index].id;
		
	$('#playlistItemTitle').html(getIcon(id)+' '+name);	
	$('#playlistItemModal').modal();	
}

function playlistItemDeleteButton (){
	
	playlistIndex = selectedPlaylistItem;
	console.log ("Removing playlist "+selectedPlaylist+" item "+playlistIndex);
	command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+playlistIndex+'&' + new Date ().getTime();
	$.get('b2cgi.fcgi',command,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();				
	});
	$('#playlistItemModal').modal("hide");		
}

function playlistItemStartButton (){
	
	playlistMove (selectedPlaylistItem,0);
	selectedPlaylistItem = 0;
	
}	
	
function playlistItemEndButton (){
	
	playlistMove (selectedPlaylistItem,playlist.length);
	selectedPlaylistItem = playlist.length-1;
	
}

function playlistItemUpButton (){
	
	if (selectedPlaylistItem > 0){
		playlistMove (selectedPlaylistItem,selectedPlaylistItem-1);
		selectedPlaylistItem--;
	}	
	
}

function playlistItemDownButton (){
	
	if (selectedPlaylistItem < playlist.length){
		playlistMove (selectedPlaylistItem,selectedPlaylistItem+1);
		selectedPlaylistItem++;
	}	

}


function allowDrop (ev) {
	ev.preventDefault();
}

function dragPlaylistItem (ev){
	i = ev.target.parentElement.rowIndex;
	ev.dataTransfer.setData ("text",""+i);
}


function playlistItemClick (ev){
	i = ev.target.parentElement.rowIndex;	
	id = playlist[i].id;
	console.log ("playlistItemClick "	+ id);
	if (isAlbum(id)) {
		listalbumAndArtistFunction (id);
		if (!desktop()) pickPanel (7);
	}	
	else if (isTrack (id)) {
		listTrackFunction (id);	
		if (!desktop()) pickPanel (7);
	}	
	else if (isArtist (id)) {
		listArtistAndFirstAlbum (id,true);
		if (!desktop()) pickPanel (8)
	}	
}

function dropSpeaker (ev){
	ev.preventDefault();
	i = ev.dataTransfer.getData ("text");
	console.log ("Dropped item i="+i);	
	
	if (isPlaylistIndex(i)) id = playlist[i].id;
	else id = i;
	
//	alert ("Play id="+id);
	command = 'playID&'+id+'&' + new Date ().getTime()
	$.get('b2cgi.fcgi',command,function(data){});	
}

function searchFunction (stay){
	

	
	
	var t = document.getElementById("searchInput");
	
	
//	if (t.value.toLowerCase() == "usb") {
//		openUSBPanel ();
//		return;
//	}	
			
	if (t.value.toLowerCase() == "podcast") {
		openPodcastPanel ();
		return;
	}
	if (isBTube() && (t.value.toLowerCase() == "debug")) {
		openbTubeDebugPanel ();
		return;
	}

	if (searching){
		newSearch = 1;
		return;
	}
	else {
		searching = 1;
		newSearch = 0;
	}	
	
	var urlTail = 'search';
	searchOffset = 0;
	if ($("#artistCheckbox").hasClass ("myGrey")) urlTail += '&artists=N';
	if ($("#albumCheckbox").hasClass ("myGrey")) urlTail += '&albums=N';
	if ($("#trackCheckbox").hasClass ("myGrey")) urlTail += '&tracks=N';
//	if ($("#radioCheckbox").hasClass ("myGrey")) urlTail += '&radio=N';	
	urlTail += '&radio=N';	
	if ($("#videoCheckbox").hasClass ("myGrey")) urlTail += '&video=N';	
	if ((lastGuest==1)&&(lastGuestPlaylist!=0)) urlTail += '&playlist='+(lastGuestPlaylist-1);
	else if (!$("#playlistCheckbox").hasClass ("myGrey")) urlTail += '&playlist='+selectedPlaylist;
		
	urlTail += '&offset='+searchOffset;
	urlTail += '&count='+searchCount;

	urlTail += '&time='+new Date ().getTime();			// IE
	
	urlTail += '&string='+t.value
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
//		console.log ("Got search results length = "+data.length);
		
		matches = data;
		var results = $('#Results');
		results.children().remove();
		var l = data.length;
		for (var i=0;i<l;i++) 
			results.append(makeSearchResult (i,data[i]));

		box = $('#SearchContainer');
		if (!stay) box.scrollTop(0);	
		box.perfectScrollbar ('update');
		
		
			
	}).always (function (){
		
		searching = 0;
		if (newSearch){
			newSearch = 0;
			searchFunction ();
		}

	});	
}		

function toggleArtist (){

	if ($("#artistCheckbox").hasClass ("myGrey")) {
		$("#artistCheckbox").removeClass ("myGrey");
		$("#albumCheckbox").addClass ("myGrey");		
		$("#trackCheckbox").addClass ("myGrey");
		$("#videoCheckbox").addClass ("myGrey");
	}

	searchFunction ();				
}	

function toggleAlbum (){

	if ($("#albumCheckbox").hasClass ("myGrey")) {
		$("#albumCheckbox").removeClass ("myGrey");
		$("#artistCheckbox").addClass ("myGrey");		
		$("#trackCheckbox").addClass ("myGrey");
		$("#videoCheckbox").addClass ("myGrey");
	}
				
	searchFunction ();	
}	

function toggleTrack (){

	if ($("#trackCheckbox").hasClass ("myGrey")) {
		$("#trackCheckbox").removeClass ("myGrey");
		$("#artistCheckbox").addClass ("myGrey");		
		$("#albumCheckbox").addClass ("myGrey");
		$("#videoCheckbox").addClass ("myGrey");		
	}

	searchFunction ();					
}

function toggleVideo (){

	if ($("#videoCheckbox").hasClass ("myGrey")) {
		$("#videoCheckbox").removeClass ("myGrey");
		$("#trackCheckbox").addClass ("myGrey");
		$("#artistCheckbox").addClass ("myGrey");		
		$("#albumCheckbox").addClass ("myGrey");
	}

	searchFunction ();					
}


function searchMore (){

//	alert ("searchMore ()");
	
//	console.log ("searchMore () length = "+$('#Results').children ().length+" Searching="+searching);
	if (searching) return;

	if (!$('#SearchContainer').is(":visible")) return;
	
//	if (!panels[2].is(":visible")) return;
//	if (!$("#SearchPanel").hasClass ("active")) return;	
	
	if (!$('#Results').children ().length) {
		$('#SearchContainer').scrollTop(0);		
		return;	
	}
	
	var t = document.getElementById("searchInput");
	var urlTail = 'search';
	searchOffset += searchCount;
	if ($("#artistCheckbox").hasClass ("myGrey")) urlTail += '&artists=N';
	if ($("#albumCheckbox").hasClass ("myGrey")) urlTail += '&albums=N';
	if ($("#trackCheckbox").hasClass ("myGrey")) urlTail += '&tracks=N';
//	if ($("#radioCheckbox").hasClass ("myGrey")) urlTail += '&radio=N';
	urlTail += '&radio=N';
	if ($("#videoCheckbox").hasClass ("myGrey")) urlTail += '&video=N';		
	if ((lastGuest==1)&&(lastGuestPlaylist!=0)) urlTail += '&playlist='+(lastGuestPlaylist-1);		
	else if (!$("#playlistCheckbox").hasClass ("myGrey")) urlTail += '&playlist='+selectedPlaylist;
	
	urlTail += '&offset='+searchOffset;
	urlTail += '&count='+searchCount;

	urlTail += '&time='+new Date ().getTime();			// IE
	
	urlTail += '&string='+t.value
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
//		console.log ("Got search results length = "+data.length);
		if (data.length){
			var results = $('#Results');
			var l = data.length;
			for (var i=0;i<l;i++) {
				results.append(makeSearchResult (matches.length,data[i]));
				matches.push(data[i]);
			}
			box = $('#SearchContainer');
			box.perfectScrollbar ('update');
		}
		else {
			searchOffset -= searchCount;
		}	
			
	});	
	
	

}

function makeSearchResult (i,n){
	
	var menu;
	var t;
	var id = n.id;
	var name = '';
	var ariaName = '';
	
	if (isTrack(id)||isUSBTrack(id)) {
		name = n.track;
		ariaName = 'Track: '+name;
	}	
	else if (isAlbum(id)||isUSBAlbum(id)) {
		name = stripClass(n.album);
		ariaName = 'Album: '+name;
	}	
	else if (isArtist(id)||isUSBArtist(id)) {
		name = n.artist;
		ariaName = 'Artist: '+name;		
	}	
	else if (isRadio(id)) {
		name = n.radio;
		ariaName = 'Radio: '+name;		
	}	
	else if (isVideo(id)) {
		name = n.video;
		ariaName = 'Video: '+name;		
	}
	
	if (searchResultsHaveFocus) t = 'tabindex="0"';
	else t = 'tabindex="-1"';
	
	if (isRadio(id)||isUSBTrack(id)||isUSBAlbum(id)||isUSBArtist(id)) menu = '<td></td>';
	else if (desktop ()) menu = '<td><span class="glyphicon glyphicon-option-horizontal" onclick="searchItemFunction('+i+')"</span></td>';
	else menu = '<td class="spaceForScrollbar"><span class="glyphicon glyphicon-option-horizontal" onclick="searchItemFunction('+i+')"</span></td>';
	
	return $('<tr '+t+' class="mylink" aria-label="'+ariaName+'"><td><span class="glyphicon glyphicon-play" onclick="playTestFunction('+i
				+')"</span></td><td class="col-sm-10" draggable="true" ondragstart="dragSearchItem(event)" ondblclick="searchItemRename(event,'+i
				+')" onclick="searchItemClick(event)">'+getIcon(id)+' '+name
				+'</td>'+
				menu+
				'</tr>');
};

function dragSearchItem (ev){
	i = ev.target.parentElement.rowIndex;
	ev.dataTransfer.setData ("text",""+matches[i].id);
	console.log ("drag "+matches[i].id);
}

function dragPlaylist (ev){
//	i = ev.target.parentElement.rowIndex;
	ev.dataTransfer.setData ("text",""+(selectedPlaylist+4000000));
	console.log ("dragPlaylist index = 	"+selectedPlaylist+4000000);
}

function playPlaylist (){
	command = 'playID&'+ (selectedPlaylist+4000000);
	$.get('b2cgi.fcgi',command,function(data){})
	activateNowPlayingTab ();		
}

function dragvTunerSearchItem (ev){
	i = ev.target.parentElement.rowIndex;
	i += 5200000;
	ev.dataTransfer.setData ("text",""+i);
	console.log ("drag "+i);
}

function dragvTunerItem (ev){
	console.log ("dragvTunerItem "+ev.target.parentElement);
	var i = ev.target.parentElement.rowIndex;
	console.log ("dragvTunerItem ("+i+")");
	i += 5100000;
	ev.dataTransfer.setData ("text",""+i);
	console.log ("drag "+i);
}

function dragPreset (ev){
	i = ev.target.parentElement.rowIndex;
	i += 6000000;
	ev.dataTransfer.setData ("text",""+i);
	console.log ("drag "+i);
}


function playAlbumTrack (index){

	id = albumTracks[index].id;
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});
	activateNowPlayingTab ();	
		
}	

function makeAlbumItem (i){
	
	var menu;
	
	if (isUSBTrack(albumTracks[i].id)){
		if (desktop ()) menu = '<td></td>';
		else  menu = '<td>class="spaceForScrollbar"</td>';
	}
	else {	
		if (desktop ()) menu = '<td><span class="glyphicon glyphicon-option-horizontal" onclick="albumItemFunction('+i+')"</span></td>';
		else menu = '<td class="spaceForScrollbar"><span class="glyphicon glyphicon-option-horizontal" onclick="albumItemFunction('+i+')"</span></td>';
	}	

	var el = $('<tr class="mylink"><td><span onclick="playAlbumTrack('+i+')" class="glyphicon glyphicon-play"></span></td><td class="col-sm-10" draggable="true" ondragstart="dragAlbumTrack(event)" onclick="albumTrackRename('+i+')">'+
							albumTracks[i].name+'</td>'+menu+'</tr>');	
	return el;
	
}	



function listalbumAndArtistFunctionRaw (id,inSitu){
	
	selectedAlbum = id;
	

	var urlTail = 'listalbum&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		albumTracks = data;
		var results = $('#AlbumTracks');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			results.append(makeAlbumItem(i));
		}



	});

	if (!inSitu){								// don't scroll to top if item changed
		box = $('#AlbumTracksBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
	}	
	
//	console.log ("albumDetails");
	
	displayArt (id);	
	
	var urlTail = 'albumDetails&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
//	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log ("Album details "+data.name);
		selectedAlbumName = data.name;
		$('#albumname').text(stripClass(data.name));		
	});	
	
	urlTail = 'getParent&id='+id+" &"+new Date ().getTime();	// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log ("Reply ID = "+data.id);
		listArtistFunction (data.id);		
	});
}

function listRandomAlbumAndArtistFunction (){

	var urlTail = 'getWebInfo&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		var id = Math.floor (Math.random()*data.albums) + 1000000;
		listalbumAndArtistFunction (id);		
	});	
}	


function listalbumAndArtistFunction (id){
	listalbumAndArtistFunctionRaw (id,false);
}

function listalbumAndArtistInSitu(id){
	listalbumAndArtistFunctionRaw (id,true);
}	



function listalbumFunction (id){
	
	selectedAlbum = id;
	
	var urlTail = 'listalbum&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		albumTracks = data;
		var results = $('#AlbumTracks');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
//			var el = $('<tr class="mylink"><td><span onclick="playAlbumTrack('+i+')" class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragAlbumTrack(event)" ondblclick="albumTrackRename('+i+')">'+data[i].name+"</td></tr>");
			results.append(makeAlbumItem(i));

		}



	});

	box = $('#AlbumTracksBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');	
	
	console.log ("albumDetails");
	
	displayArt (id);
	
	var urlTail = 'albumDetails&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		console.log ("Album details "+data.name);
		selectedAlbumName = data.name;		
		$('#albumname').text(stripClass(data.name));		
	});	
	
}




function searchItemClick (ev){
	i = ev.target.parentElement.rowIndex;	
	id = matches[i].id;
	console.log ("searchItemClick "	+ id);
	if (isAlbum(id)||isUSBAlbum(id)) {
		listalbumAndArtistFunction (id);
		activateAlbumTab ();
	}	
	else if (isArtist(id)||isUSBArtist(id)){
//		listArtistFunction (id);
		listArtistAndFirstAlbum (id,true);		
		activateArtistTab ();
	}	
	else if (isTrack (id)||isUSBTrack(id)) {
		listTrackFunction (id);
		activateAlbumTab ();
	}		
}	

function dragAlbumTrack (ev){
	i = ev.target.parentElement.rowIndex;
	console.log ("dragAlbumTrack () i= "+i);
	ev.dataTransfer.setData ("text",""+albumTracks[i].id);

}

function playArtistAlbum (index){

	id = artistAlbums[index].id;
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});
	activateNowPlayingTab ();		
}

function listArtistAndFirstAlbum (id,listAlbumFlag){
	
	console.log ("listArtistAndFirstAlbumFunction ("+id+")");
	var urlTail = 'listartist&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
//	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		artistAlbums = data;
		var results = $('#ArtistAlbums');
		results.children().remove();
		var l = data.length;
//		console.log ("listArtistsFunction () ajax reply length "+l);

		for (var i=0;i<l;i++){

			if (isUSBAlbum(artistAlbums[i].id)){
				if (desktop ()) menu = '<td></td>';
				else  menu = '<td>class="spaceForScrollbar"</td>';
			}
			else {
				if (desktop ()) menu = '<td><span class="glyphicon glyphicon-option-horizontal" onclick="artistItemFunction('+i+')"</span></td>';
				else menu = '<td class="spaceForScrollbar"><span class="glyphicon glyphicon-option-horizontal" onclick="artistItemFunction('+i+')"</span></td>';
			}	

			results.append('<tr class="mylink"><td><span class="glyphicon glyphicon-play" onclick="playArtistAlbum('+i+')"></span></td><td class="col-sm-10" ondblclick="artistItemRename('+i+') " draggable="true" ondragstart="dragArtistAlbum(event)" onclick="artistAlbumClick(event)">'+stripClass(data[i].name)+"</td>"+menu+"</tr>");
		}

		box = $('#ArtistAlbumsBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');

		if (listAlbumFlag) listalbumFunction (artistAlbums[0].id);	
	});	


	
//	console.log ("artistDetails");
	var urlTail = 'artistDetails&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
//	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log ("Artist details "+data.name);
		selectedArtistName = data.name;
		$('#artistname').text(data.name);		
	});	
	
}

function listArtistFunction (id){

	listArtistAndFirstAlbum (id,false);
}	



function artistAlbumClick (ev){
	i = ev.target.parentElement.rowIndex;	
	id = artistAlbums[i].id;
//	console.log ("artistAlbumClick "+ id);
	if (isAlbum(id)||isUSBAlbum(id)) listalbumFunction (id);
	activateAlbumTab ();	
}

function artistItemRename (index){

	var id = artistAlbums[index].id;
	if (isUSBAlbum(id)) {
		console.log ("Cannot rename USB");
		return;
	}
	openRenameWindow (id,artistAlbums[index].name);

}

function dragArtistAlbum (ev){
	i = ev.target.parentElement.rowIndex;
	console.log ("dragArtistAlbum () i= "+i);
	ev.dataTransfer.setData ("text",""+artistAlbums[i].id);

}

function dragNowPlayingTrack (ev){
	ev.dataTransfer.setData ("text",""+nowPlaying['trackid']);
	console.log ("dragNowPlayingTrack ()" + nowPlaying['trackid']);
}	

function dragNowPlayingAlbum (ev){
	ev.dataTransfer.setData ("text",""+nowPlaying['albumid']);
	console.log ("dragNowPlayingTrack ()" + nowPlaying['albumid']);
}

function dragNowPlayingArtist (ev){
	ev.dataTransfer.setData ("text",""+nowPlaying['artistid']);
	console.log ("dragNowPlayingTrack ()" + nowPlaying['artistid']);
}


function changed (newvalue,oldvalue){

	return ((typeof oldvalue === "undefined")||(newvalue !== oldvalue));

}	

function refreshNowPlaying () {
	
	nowPlaying = {};
	
}	

function sourceChanged (data){

		return ((data['source'] != nowPlaying['source'])||changed(data['playing'],nowPlaying['playing'])||
				(data['playlist'] != nowPlaying['playlist'])||
				((data['source'] == 'Internet Radio') && data.playing));
}	

function showProgress (){
//		$('#progressSliderDiv').show();
//		$('#progressSliderDiv').removeClass("disabledSlider");	
//		$('#progressSlider').prop('disabled',false);
//		$('#seekTimeLeft').show();
		$('#progressMask').hide();
}

function hideProgress (){
//		$('#progressSliderDiv').hide();	
//		$('#progressSliderDiv').addClass("disabledSlider");			
//		$('#progressSlider').prop('disabled',true);	
//		$('#seekTimeLeft').hide();
		$('#progressMask').show();
		$('#seekTimeLeft').html ("Time: 0:00");	
		$("#progressSlider").val (0);		
}	
	


function statusFunction () {
	
	var playlist;
	
	if (folderUploadEnable) return;
	
	var urlTail = 'status&' + new Date ().getTime();
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		var ps;
		var t = $('#playbutton');
		
		var change = false;			// window may have resized

		if (changed(data['playing'],nowPlaying['playing'])){
		
			if (data['playing'] == 0) {
				t.children().remove();
				t.append('<span class="glyphicon glyphicon-play"></span>');
			}				
			else {
				t.children().remove();
				t.append('<span class="glyphicon glyphicon-pause"></span>');			
			}
		
		}
	
		if (sourceChanged(data)){

//			change = true;			// doesn't resize

			if (data['playing'] == 0) ps = ' Paused ';
			else ps = ' Playing ';
			
//			playlist = data['playlist']||"";
			playlist = "";
			
//			var f = $('#sourceHeader');
//			var sourceText;
			
			if ((data['source'] == 'Internet Radio') && data.playing) sourceText = data.radioStatus;
			else if ((data['source'] == 'Web Browser')) {
				sourceText = data['source']+" "+data['track']+ps;
			}	
			else sourceText = data['source']+" "+playlist+ps;
			
			if (!((data['source'] == 'Hard Disk')||
				(data['source'] == 'SD Card')||
				(data['source'] == 'Youtube')||
				(data['source'] == 'Internet Radio'))) clearCurrentArt ();			
			
			
//			f.text (sourceText);
			
		}
		
		var b = $('#nowPlayingBody');
	
//		console.log ("statusFunction () "+data['source']);
//		console.dir (data);
	
		if ((data['source'] == 'Hard Disk')||(data['source'] == 'SD Card')){
			if ((data['track'] != nowPlaying['track'])||(sourceChanged(data))){

				change = true;

				if (data['track'] != nowPlaying['track']) displayCurrentArt ();

				playlist = data['playlist'];				
				var ph = '';
				if (playlist && (playlist != "All Music")) ph = '<h6><span class="text-muted">Playlist: </span>'+playlist+'</h6>';

				b.html(
					'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
					'<h6 class="mylink clipText twoLines" draggable="true" ondragstart="dragNowPlayingTrack (event)" onclick="nowPlayingTrackClick()"><span class="text-muted">Track </span>'+data['track']+'</h6>'+
					'<h6 class="mylink clipText twoLines" draggable="true" ondragstart="dragNowPlayingArtist (event)" onclick="nowPlayingArtistClick()"><span class="text-muted">Artist </span>'+data['artist']+
					'</h6><h6 class="mylink clipText twoLines" draggable="true" ondragstart="dragNowPlayingAlbum (event)" onclick="nowPlayingAlbumClick()"><span class="text-muted">Album </span>'+data['album']+'</h6>'
					+ph
//					+'<h6><span class="text-muted">Time left: </span><span id="timeLeft"></span></h6>'
					);
			}		
		}
		else if (data['source'] == 'Internet Radio'){
			if ((data['station'] != nowPlaying['station'])||(sourceChanged(data))){
				change = true;
				b.html(
				'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
				'<h6><span class="text-muted">Station </span>'+data['station']+'</h6>');
				
				if (data['station'] != nowPlaying['station']){
					console.log ("internet radio changed "+data['station']+" != "+nowPlaying['station']);
					if (data['logo']) displayRadioLogo (data['logo']);
					else clearCurrentArt ();
				}	
			}	
		}	
		else if (data['source'] == 'Bluetooth'){
			if ((data['btstatus'] != nowPlaying['btstatus'])||(sourceChanged(data))){			
				change = true;
				b.html(
				'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
				'<h6>'+data['btstatus']+'</h6>');
				clearCurrentArt ();	
			}	
		}
		else if (data['source'] == 'CD Player'){
			if ((data['track'] != nowPlaying['track'])||(sourceChanged(data))){
				change = true;
				b.html(
				'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
				'<h6>'+data['track']+'</h6>');		
				clearCurrentArt ();					
			}	
		}
		else if (data['source'] == 'Youtube'){
			if ((data['track'] != nowPlaying['track'])||(sourceChanged(data))){
				displayCurrentArt ();				
				change = true;
				b.html(
				'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
				'<h6>'+data['track']+'</h6>');
			}	
		}
		else if (data['source'] == 'Podcast'){
			var m = Math.floor(data.seconds / 60);
			var s = Math.round(data.seconds % 60);
			var ss = "0"+s;
			b.html(
				'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
				'<h6>'+m+":"+ss.substr(-2)+'</h6>');	
		}
		else {
			console.log ("This displays track by default "+data['source']);
			if ((data['track'] != nowPlaying['track'])||(sourceChanged(data))){
				change = true;
				b.html(
					'<h6><span class="text-muted">Source </span>'+sourceText+'</h6>'+
					'<h6>'+data['track']+'</h6>');
			}	
		}	

		
		if (data.volume != lastVolume){
			$( "#volume" ).text("Volume: "+data.volume );
			if (!mouseOverSlider){
				$("#slider-1").val (data.volume);
				lastVolume = data.volume;
			}	
		}
		
//		if (change) adjustHeights ();

		if (data.cddbmatches != nowPlaying.cddbmatches){
			listCDDBFunction (data.cdloaded);
		}	
		
			
		nowPlaying = data;
		
		var vu = data['vu'];
		var t = new Date().getTime();
		vuLine1.append (t+0,vu[4]);			
		vuLine1.append (t+100,vu[3]);
		vuLine1.append (t+200,vu[2]);
		vuLine1.append (t+300,vu[1]);
		vuLine1.append (t+400,vu[0]);						
		
		$('#cdstatus').text(data.cdstatus);
		if (lastCDLoaded != data.cdloaded){
//			console.log ("cdloaded = "+data.cdloaded);
			if (data.cdloaded) {
				activateCDTab ();
				
			}
			else $('#CDDBPanel').hide();		
			lastCDLoaded = data.cdloaded;
			if (!data.cdloaded) $('#cdbox').html ('<div></div>');
		}	

		if (lastDiscid != data.discid) {
//			console.log ("discid = ",data.discid);
			lastDiscid = data.discid;		
//			doAlbumArt (data.discid);
		}

		if (lastRandom != !!parseInt(data.random)) {
//			console.log ("random = ",parseInt(data.random));
			lastRandom = !!parseInt(data.random);		
			$('#randomIcon').toggleClass("myGrey",!lastRandom);
		}

		if (lastSorted != !!parseInt(data.sorted)) {
			lastSorted = !!parseInt(data.sorted);		
			$('#alphaIcon').toggleClass("myGrey",!lastSorted);
		}
		
		if (lastBackground != data.background) {
			lastBackground = data.background;		
			$("#backgroundText").html(data.background);			
			$("#USBBackgroundText").html(data.background);	
		}
		
		if (lastCompression != data.compression) {
			lastCompression = data.compression;
			setCompressionText (data.compression);
		}	
				
		if (lastSegue != data.segue) {
			lastSegue = data.segue;
			setSegueText (data.segue);
		}

		if (lastLogging != data.logging) {
			lastLogging = data.logging;
			setLoggingText (data.logging);
		}
		if (lastTvUi != data.tvui) {
			lastTvUi = data.tvui;
			$("#tvUi").prop("checked",data.tvui==1);
		}
		if (lastHDMI != data.hdmi) {
			lastHDMI = data.hdmi;
			$("#hdmi").prop("checked",data.hdmi==1);
		}
		if (lastvCache != data.vCache) {
			lastvCache = data.vCache;
			$("#vCache").prop("checked",data.vCache==1);
		}
		if (lastEqualiser != data.equaliser) {
			lastEqualiser = data.equaliser;
			$("#equaliser").prop("checked",data.equaliser==1);
		}
		if (lastGuestPlaylist != data.guestPlaylist) {
//			console.log ("incoming Guest Mode changed="+data.guestPlaylist);
			lastGuestPlaylist = data.guestPlaylist;
		}
		if (lastGuest != data.guest) {
			lastGuest = data.guest;
			$("#guestMode").prop("checked",data.guest==1);
			if (lastGuest == 1) {
				searchFunction ();
				if (lastGuestPlaylist > 0) {
					selectedPlaylist = lastGuestPlaylist-1;
					refreshPlaylistsFunction ();			
				}	
			}
		}
		
		if (data.forceWebRefresh){
			console.log ("forceWebRefresh");
			searchFunction (false);
			listalbumAndArtistFunction (1000000);			
			refreshPlaylistsFunction ();
			refreshUSB ();	
			refreshHistoryList ();								
		}
		
		if (data.duration && data.duration != 0){
			
			showProgress ();
			
//			console.log ("timeLeft "+data.timeLeft+" duration "+data.duration);

			if (enableProgressSliderUpdates){
//				displayTimeLeft (data.timeLeft,data.duration);
				displayTimeLeft2 (data.timeIntoTrack,data.duration);
				if (!mouseOverProgressSlider){
//					var p = ((data.duration - data.timeLeft)*1000)/data.duration;
					var p = ((data.timeIntoTrack)*1000)/data.duration;
					$("#progressSlider").val (p);
				}	
			}	
	
		}
		else hideProgress ();


		var m = Math.floor(data.timeLeft / 60);
		var s = Math.round(data.timeLeft % 60);
		var ss = "0"+s;
		if (typeof data.timeLeft != "undefined") 
			$('#timeLeft').text (m+':'+ss.substr(-2));
		else
			$('#timeLeft').text ("");		
				
		if (isBTube()) $('#radioButton').hide();
		
	});	
};

function doAlbumArt (discid){

	if (discid != ""){
		url = 'http://musicbrainz.org/ws/2/discid/'+discid;
		urlTail = 'fmt=json';
	
		console.log ("Musicbrainz request "+url+' '+urlTail);
	
		$.getJSON(url,urlTail,function(data){
			var n,l;
			var releases;
			var release;
		
			console.log ("Musicbrainz reply= ",data);
			
			$('#fetchingArt').hide ();
				
			releases = data.releases;
			l = releases.length;
			for (n=0;n<l;n++) {
				release = releases[n];
				console.log ("Release "+n+" = "+release.title);
				console.log ("id "+n+" = "+release['id']);
				console.log ("front "+n+" = "+release['cover-art-archive']['front']);
					
				if (release['cover-art-archive']['front']){
					
					url = 'http://coverartarchive.org/release/'+release['id']+"/front-500";
					console.log ("Querying coverartarchive.org "+url);
						
					$('#cdbox').html ('<img class="center" src="http://coverartarchive.org/release/'+release['id']+'/front-500">');

//****************

					setCDBoxHeight ();	

//***************

					$.getJSON('b2gci.fcgi',"artURL&url="+url+"&time="+new Date ().getTime(),function(data){});	
											
					break;
				}	
			}
			if (n == l) $('#cdbox').html ('<p>No Cover Art available at www.coverartarchive.org</p>');
	
		}).fail (function () {
			
			console.log ("Request failed");
			$('#fetchingArt').hide ();
			$('#cdbox').html ('<p>No reply from musicbrainz.org</p>');
			
		});			
	}
	else $('#fetchingArt').hide ();	
}	

function setCDBoxHeight (){


		var poh = vpbm (".panelContent");
		var pwh = $('#playlistWell').height();
		var pth = $('#playlistTabs').outerHeight (true);
		var cdth = $('#cdTitleBar').outerHeight();
		var cddbh = $('#CDDBPanel').outerHeight();
		
		var ih = pwh - pth - cdth - cddbh - poh;
		var iw = $('#CDPanel').width();

		var is = ih > iw? iw : ih;
//		console.log ("setCDBoxHeight () is "+is+" iw "+iw+" ih "+ih+ " pwh "+pwh+" pth "+pth+" cdth "+cdth+"cddbh "+cddbh);

		$('#cdbox').height(is);
}	

function getArtFunction(){

	$('#artButton').hide ();
	$('#fetchingArt').show ();
	$.getJSON('b2gci.fcgi',"getDiscid&time="+new Date ().getTime(),function(data){
		console.log ("Discid = "+data);
		doAlbumArt (data);		
	});		
	
}


function nowPlayingAlbumClick (){
	id = nowPlaying['albumid'];
	console.log ("nowPlayingAlbumClick "+ id);
	if (isAlbum(id)) listalbumAndArtistFunction (id);
	if (!desktop()) pickPanel (7);
}

function nowPlayingArtistClick (){
	id = nowPlaying['artistid'];
	console.log ("nowPlayingArtistClick "+ id);
	if (isArtist(id)) listArtistFunction (id);
	if (!desktop()) pickPanel (8);
}

function listTrackFunction (id){
	var urlTail = 'getParent&id='+id+" &"+new Date ().getTime();	// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		console.log ("Reply ID = "+data.id);
		listalbumAndArtistFunction (data.id);		
	});
}

function nowPlayingTrackClick (){
	id = nowPlaying['trackid'];
	console.log ("nowPlayingTrackClick "+ id);
	listTrackFunction (id);
}


function playlistDragenter (ev,index){
		ev.preventDefault();
//		console.log ("playlistDragenter "+index);
		var tbody = $('#playlistTbody');
		tbody.children().eq(index).addClass("topBorder");		
}	

function playlistDragleave (ev,index){
		ev.preventDefault();
//		console.log ("playlistDragleave "+index);
		var tbody = $('#playlistTbody');
		tbody.children().eq(index).removeClass("topBorder");
}


function playlistMove (from,to){
	
	var id;
		
	if (to == from) return;
	id = playlist[from].id;
	console.log ("playlistMove "+selectedPlaylist+" from "+from+" to "+to);

	command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+from+'&time='+new Date ().getTime();			// IE
	$.get('b2cgi.fcgi',command,function(data){
//		if (from < to) to--;
			
		console.log ("Now adding id "+id+" back to index "+to);

		urlTail = 'addIdToPlaylist&id='+id+'&playlist='+selectedPlaylist+'&index='+to+'&time='+new Date ().getTime();			// IE;
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			listPlaylistFunction (selectedPlaylist);
			refreshPlaylistsFunction ();
		});
	});
			
}



function playlistDrop (ev,index){
	
		var fromPlaylist;
		var id;
		
		ev.preventDefault();
		console.log ("playlistDrop "+index);
		
		if (lastGuest==1) {
			$('#guestModeModal').modal();			
			return;
		}		
		
		var tbody = $('#playlistTbody');
		tbody.children().eq(index).removeClass("topBorder");

		i = ev.dataTransfer.getData ("text");
		if (isPlaylistIndex(i)){
			fromPlaylist = 1;
			id = playlist[i].id;
			playlistIndex = i;
		}
		else {
			fromPlaylist = 0;
			id = i;
			playlistIndex = 0;
		}
		
//		console.log ("playlist[0].id=",playlist[0].id);
//		console.log ("playlist[1].id=",playlist[1].id);
//		console.log ("fromPlaylist="+fromPlaylist+" id="+id+" playlistIndex "+playlistIndex);
		

		if (fromPlaylist) {
			if (index == playlistIndex) return;
			console.log ("Removing playlist "+selectedPlaylist+" item "+playlistIndex);
			command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+playlistIndex+'&time='+new Date ().getTime();			// IE
			$.get('b2cgi.fcgi',command,function(data){

				if (index > playlistIndex) index--;
				
				console.log ("Now adding id "+id+" back to index "+index);

				urlTail = 'addIdToPlaylist&id='+id+'&playlist='+selectedPlaylist+'&index='+index+'&time='+new Date ().getTime();			// IE;
				$.getJSON('b2gci.fcgi',urlTail,function(data){
					listPlaylistFunction (selectedPlaylist);
					refreshPlaylistsFunction ();
				});
			});
		}
		else {
			urlTail = 'addIdToPlaylist&id='+id+'&playlist='+selectedPlaylist+'&index='+index+'&time='+new Date ().getTime();			// IE;
			$.getJSON('b2gci.fcgi',urlTail,function(data){
				listPlaylistFunction (selectedPlaylist);
				refreshPlaylistsFunction ();
			});
		}
			
}	


function openRenameWindow (id,name){
	
	console.log ("openRenameWindow ("+id+","+name+")");


	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
	
	console.log ("CD Status ="+nowPlaying.cdstatus);
	
	if (nowPlaying.cdstatus.toLowerCase().search("rip")>=0){
		
		alert ("Not while Ripping");
		return;
		
	}	
		
	
	
	renameID = id;
	renameOldName = name;

	var title;
	if (isTrack(id)) title = "Rename Track";
	else if (isAlbum(id)) title = "Rename Album";
	else if (isArtist(id)) title = "Rename Artist";	
	else if (isPlaylist(id)) title = "Rename Playlist";

	$('#myModal').modal();
	$('#renameTitle').text(title);
	$('#renameValue').val(name);
	$('#renameValue').focus();
	
	$('#renameValue').off ("keydown");
	$('#renameSecondValue').off ("keydown");
	
	$('#renameValue').keydown (function(event){
		if ((event.keyCode == 13)||event.code == 10){
			renameOKFunction ();
			return false;
		}
	});
	$('#renameSecondValue').keydown (function(event){
		if ((event.keyCode == 13)||event.code == 10){
			renameOKFunction ();
			return false;
		}
	});
	
	if (isAlbum(id)){
		$('#renameArtist').show ();
		var urlTail = 'albumDetails&id='+id+'&time='+new Date ().getTime();			// IE
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			console.log ("Album details "+data.artist);
			renameOldArtist = data.artist;
			$('#renameSecondValue').val(data.artist);		
		});	
	}
	else {
	
		$('#renameArtist').hide ();
	}	
}

function albumTrackRename (index){
	
	var id = albumTracks[index].id;
	if (isUSBTrack(id)) {
		console.log ("Cannot rename USB");
		return;
	}	
	openRenameWindow (id,albumTracks[index].name);
}	

function renameOKFunction (){

	var urlTail;
	var newName;
	var artistChanged;
	
	console.log ("renameOKFunction ()");
	$('#myModal').modal("hide");

	newName = $('#renameValue').val();
	console.log ("Newname = "+newName);
	
	artistChanged = (isAlbum(renameID) && (renameOldArtist != $('#renameSecondValue').val()));
	
	if (newName != renameOldName){
		
		urlTail = 'renameID&id='+renameID+'&time='+new Date ().getTime()+'&name='+	encodeURIComponent(newName);		// IE	
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			if (!artistChanged){
				searchFunction (true);					// refresh		
				listalbumAndArtistInSitu (selectedAlbum);
				listPlaylistFunction (selectedPlaylist);
				refreshPlaylistsFunction ();
			}	
		});	
	}
	
	if (artistChanged){
		newName = $('#renameSecondValue').val();		

		console.log ("Artist changed = "+newName);
			
		urlTail = 'moveID&id='+renameID+'&time='+new Date ().getTime()+'&name='+	encodeURIComponent(newName);	// IE		
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			searchFunction (true);					// refresh		
			listalbumAndArtistInSitu (selectedAlbum);
			listPlaylistFunction (selectedPlaylist);
		});	
	}
	

}


function searchItemRename (ev,index){

	ev.preventDefault();

	var name;
	var id = matches[index].id

//	console.log ("searchItemRename event="+ev); 
	
	if (isTrack(id)) name = matches[index].track;
	else if (isAlbum(id)) name = matches[index].album;
	else if (isArtist(id)) name = matches[index].artist;
	else return;
	
	openRenameWindow (id,name);

}	

function playlistItemRename (index){

	openRenameWindow (playlist[index].id,playlist[index].name);

}

function dropBin (ev){
	ev.preventDefault();
	i = ev.dataTransfer.getData ("text");
	console.log ("Dropped item i="+i);
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}	
	
	if (isPlaylistIndex(i)){
		playlistIndex = i;
		console.log ("Removing playlist "+selectedPlaylist+" item "+playlistIndex);
		command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+playlistIndex+'&' + new Date ().getTime();
		$.get('b2cgi.fcgi',command,function(data){
				listPlaylistFunction (selectedPlaylist);
				refreshPlaylistsFunction ();				
		});
	}
}

function ripFunction (){
	console.log ("ripFunction ()");
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
		
	command = 'rip&index='+selectedcddb+'&' + new Date ().getTime();
	$.get('b2cgi.fcgi',command,function(data){
			
	});
}

function ejectFunction (){
	
	$.get('b2cgi.fcgi',"eject&"+new Date ().getTime(),function(data){
			// ignore response to ajax get
		});	
	
}	

function listCDDBFunction (display) {

	var background;
	
	command = 'getCDDB&' + new Date ().getTime();				// IE
	$.getJSON('b2gci.fcgi',command,function(data){
//		console.log ("getCDDB replied "+data);
		if (display) $('#CDDBPanel').show();
		$('#artButton').show ();				
		cddb = data;
		var ul = $('#CDDBDropdownUl');
		ul.children().remove();
		var l = data.length;
		
		if (l){
			if (l == 1)
			$('#CDDBMessage').html("CDDB found one match<br />Press Art now to get cover art from musicbrainz<br />Then press Rip to copy CD to hard disk");
			else
			$('#CDDBMessage').html("CDDB found "+l+" matches<br />Press Art now to get cover art from musicbrainz<br />Then pick name and press Rip");
			for (var i=0;i<l;i++){
	
				ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickCddb('+i+')">'
					+data[i].album+'</br><h6><strong>'+data[i].artist+'</strong></h6></a></li>');
			}		
			selectedcddb = 0;
			pickCddb (0);
		}
		else {
			$('#CDDBMessage').text("CDDB found no matches");
			$('#artButton').hide ();			
		}			
	});	
};

function pickCddb (i){

	selectedcddb = i;
	
//	$("#menu2").html(cddb[i].album+' <span class="caret"></span>');
	$("#cddbChoice").html(cddb[i].album+"<br />"+cddb[i].artist);
}	

function playTestFunction (index){
	var id = matches[index].id
//	alert ("playTestFunction "+id);
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});
	activateNowPlayingTab ();		
}		



function nextUpload (){
	
	var formData = new FormData ();

//	formData.append (uploadAlbum,uploadFiles[currentUpload],uploadFiles[currentUpload].name);

	var name = uploadFiles[currentUpload].name;
	if (name.toUpperCase ().indexOf (".JPG") > 0) name = "coverart.jpg";
	else if (name.toUpperCase ().indexOf (".PNG") > 0) name = "coverart.png";	

	formData.append (uploadAlbum,uploadFiles[currentUpload],name);

	$.ajax ({
		url: 'b2cgi.fcgi?upload&artist='+uploadArtist,
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {

//			console.log ("Upload success currentUpload = "+currentUpload);
//			console.log ("data= "+data);
//			console.log ("textStatus = "+textStatus);

			currentUpload++;
			uploadTry = 1;
			if (uploadEnabled && (currentUpload < uploadFiles.length)){
				var n = currentUpload+1;
				$('#uploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length);		
				nextUpload ();
			}
			else  {
				$('#uploading').hide ();				
				searchFunction ();					// refresh		
				listalbumAndArtistFunction (selectedAlbum);
				refreshNowPlaying ();				
			}	
		},
		error: function (jqXHR, textStatus, errorThrown){
			
				if (uploadEnabled && (uploadTry < 3)){
					uploadTry++;
					var n = currentUpload+1;
					$('#uploadProgress').html ('&nbsp&nbsp&nbspRetrying '+n+' of '+uploadFiles.length);					
					nextUpload ();
				}
				else {	
					$('#uploadModal').modal("hide");
					alert ("Upload error: "+textStatus+" file = "+uploadFiles[currentUpload].name);
				}	
			}
		});	
}

// This version used for Art upload doesn't reset search window 

function uploadOne (){
	
	var formData = new FormData ();

	formData.append (uploadAlbum,uploadFiles[currentUpload],uploadFiles[currentUpload].name);

	$.ajax ({
		url: 'b2cgi.fcgi?upload&artist='+uploadArtist,
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {
			$('#uploading').hide ();				
			listalbumAndArtistFunction (selectedAlbum);				
		},
		error: function (jqXHR, textStatus, errorThrown){
			
				if (uploadEnabled && (uploadTry < 3)){
					uploadTry++;
					var n = currentUpload+1;
					$('#uploadProgress').html ('&nbsp&nbsp&nbspRetrying '+n+' of '+uploadFiles.length);					
					uploadOne ();
				}
				else {	
					$('#uploadModal').modal("hide");
					alert ("Upload error: "+textStatus+" file = "+uploadFiles[currentUpload].name);
				}	

		}	
	});	
}


function uploadFunction (){

	uploadArtist = $('#uploadArtist').val();
	uploadAlbum = $('#uploadAlbum').val();
	uploadFiles = $('#uploadFileSelect').prop('files');

	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}

	if (uploadArtist && uploadAlbum && uploadFiles.length){

		currentUpload = 0;
		uploadTry = 1;
		var n = currentUpload+1;

		$('#uploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length);		
		$('#uploading').show ();
		
		uploadEnabled = true;		
		
		nextUpload ();

	}
	else myAlert ("You need to specify Album, Artists and Choose Files");
}

function uploadCancelFunction (){

		uploadEnabled = false;
	
}	


function openArtistPanel (){
		$('#artistButton').replaceWith ('<span id="artistButton" class="glyphicon glyphicon-minus-sign"></span>');
		$('#AlbumTracksBox').collapse ("show");
}	

function closeArtistPanel (){
		$('#artistButton').replaceWith ('<span id="artistButton" class="glyphicon glyphicon-plus-sign"></span>');
		$('#AlbumTracksBox').collapse ("hide");
}

function showHideArtistPanel (){
	
		var glyph = $('#artistButton').attr("class");
		
		console.log ("showHideArtistPanel "+glyph+" "+glyph.indexOf ("plus"));		
		
		if (glyph.indexOf ("plus") == -1) closeArtistPanel ();
		else openArtistPanel ();

}	


function openPresetsPanel (){
		$('#presetsButton').replaceWith ('<span id="presetsButton" class="glyphicon glyphicon-minus-sign"></span>');
		$('#presetsBox').collapse ("show");
}	

function closePresetsPanel (){
		$('#presetsButton').replaceWith ('<span id="presetsButton" class="glyphicon glyphicon-plus-sign"></span>');
		$('#presetsBox').collapse ("hide");
}


function listPresetsFunction (){
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#presets');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<tr class="mylink" onclick="playPreset('+i+')"><td><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragPreset(event)" ondblclick="presetEdit('+i+')" ondragover="allowDrop(event)" ondrop="presetDrop(event,'+i+')" class="mylink">['+i+'] '+data[i].name+"</td></tr>");
			results.append(el);
		}
		
		box = $('#presetsBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');		
		

	});
	
}

function playPreset (index){

	id = index += 6000000;	
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});
	activateNowPlayingTab ();		
}	


function presetDrop (ev,preset){
	
	ev.preventDefault();	

	id = ev.dataTransfer.getData ("text");
	
//	console.log ("presetDrop () preset = "+preset+" id = "+id);
	
	var urlTail = 'setPresetFromID&id='+id+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});	

	
}


function vTunerGoBack (){

	var loading = $('#vTunerTable');
	loading.children().remove();
	loading.append ('<div><img src="ajax-loader.gif"></div>');

	
	var urlTail = 'vTunerBack&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		
		var vTunerLinks = $('#vTunerTable');
		vTunerLinks.children().remove();

		for (var i=0;i<data.length;i++){
//			vTunerLinks.append('<tr><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick(event)" class="mylink">'+data[i]+"</td></tr>");
//			vTunerLinks.append('<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink"><a href="#" alt="'+data[i].name+'">'+data[i].name+"</a></td></tr>");
			vTunerLinks.append(makevTunerItem (i,data[i]));
		}

		var box = $('#vTunerBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
				
	});	
}
	

function vTunerSearch (){

	var t = document.getElementById("vTunerSearchInput");
	var urlTail = 'vTunerSearch&time='+ new Date ().getTime()+'&string='+t.value;	// IE

//	console.log ("Search urltail ="+urlTail);

	var loading = $('#vTunerMatches');
	loading.children().remove();
	loading.append ('<div><img src="ajax-loader.gif"></div>');
	
	var box = $('#vTunerSearchBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');

	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		
//		console.log ("vTunerSearch result = "+data);

		vTunerSearchResults = data;

		var vTunerLinks = $('#vTunerMatches');
		vTunerLinks.children().remove();

		for (var i=0;i<data.length;i++){

			var menu = '<td><span class="mylink glyphicon glyphicon-option-horizontal" onclick="vTunerSearchItemMenu('+i+')"</span></td>';
			var link = 'class="mylink" onclick="vTunerSearchItemClick('+i+')"';

//			vTunerLinks.append('<tr class="mylink" onclick="vTunerSearchItemClick('+i+')"><td><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragvTunerSearchItem(event)">'+data[i]+"</td></tr>");

			vTunerLinks.append('<tr><td '+link+'><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragvTunerSearchItem(event)">'+data[i]+"</td>"+menu+"</tr>");


		}
		var box = $('#vTunerSearchBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');		
				
	});		
}

function vTunerSearchItemMenu (index){
	
	$('#vTunerSearchMenuModal').modal();
//	$('#vTunerSearchMenuTitle').html("Move "+vTunerSearchResults[index]+"<br />To Preset");

	$('#vTunerSearchMenuTitle').html('<p class="textCenter"><span class="text-muted">Move </span>'+
								'<span class="modal-title">'+vTunerSearchResults[index]+'</span>'+
								'<span class="text-muted"> to Preset</span></p>');
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#vTunerSearchMenuBody');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<button type="button" class="btn btn-default btn-block leftjustified" onclick="vTunerSearchPresetAdd('+index+','+i+')" >['+i+'] '+data[i].name+'</button>');
			results.append(el);
		}

	});	
		
}	

function vTunerItemMenu (index){
	
	$('#vTunerItemMenuModal').modal();
//	$('#vTunerItemMenuTitle').html("Move "+vTunerItemResults[index].name+"<br />To Preset");
	
	$('#vTunerItemMenuTitle').html('<p class="textCenter"><span class="text-muted">Move </span>'+
								'<span class="modal-title">'+vTunerItemResults[index].name+'</span>'+
								'<span class="text-muted"> to Preset</span></p>');
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#vTunerItemMenuBody');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<button type="button" class="btn btn-default btn-block leftjustified" onclick="vTunerItemPresetAdd('+index+','+i+')" >['+i+'] '+data[i].name+'</button>');
			results.append(el);
		}

	});	
		
}	


function vTunerItemPresetAdd (index,preset){
	
	console.log ("vTunerItemPresetAdd ("+index+","+preset+")");
	console.log (vTunerItemResults[index]);
	
	index += 5100000;
	var urlTail = 'setPresetFromID&id='+index+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});	

	$('#vTunerItemMenuModal').modal("hide");
	selectPlaylistSubPanel(2);

}

function vTunerSearchPresetAdd (index,preset){
	
	console.log ("vTunerSearchPresetAdd ("+index+","+preset+")");
	console.log (vTunerSearchResults[index]);

	$('#vTunerSearchMenuModal').modal("hide");
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
	
	index += 5200000;
	var urlTail = 'setPresetFromID&id='+index+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});	

	selectPlaylistSubPanel(2);

}

function vTunerSearchItemClick (i){

	console.log ("vTunerSearchItemClick index="+i);
	
	var urlTail = 'vTunerPlaySearchItem&index='+i+'&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		
		console.log ("vTunerPlaySearchItem result = "+data);

	});
	activateNowPlayingTab ();		
}


function makevTunerItem (i,data){

	if (data.flag){
		var menu = '<td><span class="mylink glyphicon glyphicon-option-horizontal" onclick="vTunerItemMenu('+i+')"</span></td>';
		var link = 'class="mylink" onclick="vTunerItemClick('+i+')"';
		return '<tr><td '+link+'><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink">'+data.name+"</td>"+menu+"</tr>";	
	}	
	else 
		return '<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink">'+data.name+"</td></tr>";	
	
}


function vTunerInit () {

//	console.log ("vTunerInit ()");


	var vTunerLinks = $('#vTunerTable');
	vTunerLinks.children().remove();
	vTunerLinks.append ('<div><img src="ajax-loader.gif"></div>');
	
	var urlTail = 'vTunerTop&' + new Date ().getTime();			// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){			
		
//		console.log ("vTunerTop result = "+data);
		vTunerLinks.children().remove();
		vTunerItemResults = data;


		for (var i=0;i<data.length;i++){

//			vTunerLinks.append('<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink"><a href="#" alt="'+data[i].name+'">'+data[i].name+"</a></td></tr>");
			vTunerLinks.append(makevTunerItem (i,data[i]));


		}

//		console.log ("First Item = "+vTunerLinks.children()[0]);
		vTunerLinks.children().eq(0).focus();
				
		var box = $('#vTunerBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
				
	});
	
}


function vTunerItemClick (index){
//function vTunerItemClick (ev){
//	index = ev.target.parentElement.rowIndex;	
	console.log ("vTunerItemClick "+ index);

	var loading = $('#vTunerTable');
	loading.children().remove();
	loading.append ('<div><img src="ajax-loader.gif"></div>');

	var box = $('#vTunerBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');

	
	var urlTail = 'vTunerLink&index='+index+'&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){	


		vTunerItemResults = data;		
//		console.log ("vTunerLink result = "+data);

		var vTunerLinks = $('#vTunerTable');
		vTunerLinks.children().remove();

		for (var i=0;i<data.length;i++){
//			vTunerLinks.append('<tr><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick(event)" class="mylink">'+data[i]+"</td></tr>");
//			vTunerLinks.append('<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink"><a href="#" alt="'+data[i].name+'">'+data[i].name+"</a></td></tr>");
			vTunerLinks.append(makevTunerItem (i,data[i]));
		}

		vTunerLinks.children().eq(0).focus();

		var box = $('#vTunerBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
				
	});	
}



function activateCDTab (){
/*	
	$('#playlistTab').removeClass("active");	
	$('#PresetsTab').removeClass("active");
	$('#UploadTab').removeClass("active");	
	$('#CDTab').addClass("active");
	
	$('#playlistPanel').removeClass("in active");	
	$('#PresetsPanel').removeClass("in active");
	$('#UploadPanel').removeClass("in active");	
	$('#CDPanel').addClass("in active");
*/
	selectPlaylistSubPanel (1);
}	


function activateAlbumTab (){

/*
	$('#ArtistTab').removeClass("active");	
	$('#AlbumTab').addClass("active");
	
	$('#ArtistPanel').removeClass("in active");	
	$('#AlbumPanel').addClass("in active");
*/
	pickPanel (7);
	
}	

function activateArtistTab (){
/*	
	$('#AlbumTab').removeClass("active");	
	$('#ArtistTab').addClass("active");
	
	$('#AlbumPanel').removeClass("in active");	
	$('#ArtistPanel').addClass("in active");
*/
	pickPanel (8);
	
}


function activateNowPlayingTab (){

	pickPanel (0);
}	

function startVTuner (){
	
	console.log ("startVTuner ()");
	
}	

function adjustPanels (){



	if ((window.innerWidth > th) && (lastWidth <= th)){
		selectPanel (0);
	}	
	if ((window.innerWidth < th) && (lastWidth >= th)){
		selectPanel (0);
	}	
	lastWidth = window.innerWidth;
}	
		

function resize (){
	
	
//	var canvas = document.getElementById("mycanvas");
//	canvas.width = $('#canvasBox').width();


//	adjustPanels ();
	
	box = $('#SearchContainer');
	box.scrollTop(0);	
	box.perfectScrollbar ('update');
	
	adjustHeights ();		
}	


/*
function albumPanelClicked (){
	
	togglePanel (4);

}	

function nowPlayingClicked (event){

	togglePanel (0);

}

function selectPanel (panel){

	if (window.innerWidth > th){
		for (n=0;n<5;n++){
			panels[n].slideDown();
		}
	}
	else {	
		for (n=0;n<5;n++){
			if (n == panel) panels[n].slideDown();
			else panels[n].slideUp();
		}
	}
	
}

function togglePanel (panel){
	
	console.log ("togglePanel "+panel);

	if (window.innerWidth > th){
		for (n=0;n<5;n++){
			panels[n].slideDown();
		}
	}
	else {	
		for (n=0;n<5;n++){
			if (n == panel) panels[n].slideToggle();
			else panels[n].slideUp();
		}
	}
	
}
*/

function stripClass (name){
	
//	return name.replace (/\[[A-Z]*\]/,"");
	return name;

}	

// vpbm returns the vertical padding, border and margin of a container
// selector should look like a css selector "#middleWell" or ".well"

function vpbm (selector){

	var el = $(selector);
	return el.outerHeight(true)-el.height();
}

function adjustHeights (){

//	console.log ("adjustHeights");
	
	var wh = $(window).height();						// browser window height


	mobileModeSwitch ();
	selectPanelForMobile ();

	var desk = desktop ();

	if (desk){

		//if (wh < 850) $('#mycanvas').hide();		
		//else $('#mycanvas').show();
		
		if (wh < 700) wh = 700;
		

/*		
		console.log (".btn-group[] length =" + $(".btn-group").length);
		$(".btn-group").each (function (index){
			console.log (index + " " + $(this).outerHeight (true));
		});	
*/	
		var woh = vpbm (".well");							// well overhead
		var th = $("#SearchTab").outerHeight(true);			// tab height
		var bbh = $("#searchControls").outerHeight(true);	// button bar height
		var poh = vpbm (".panelContent");					// panelContent overhead
		var soh = vpbm ("#SearchContainer");				// searchContainer overhead

		var srch = wh-woh-th-bbh-poh-soh;

//	console.log ("wh "+wh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh+" soh "+soh);
//	console.log ("div height = "+srch);

		$('#SearchContainer').height(srch);

		bbh = $("#vTunerButtons").outerHeight(true);		// button bar height	
		var vth = wh-woh-th-bbh-poh-soh;		
	
		$('#vTunerBox').height((vth-bbh-10)/2);				// 10 px space between two sections
		$('#vTunerSearchBox').height((vth-bbh-10)/2);

		var sbh = $('#youtubeSearchBar').outerHeight(true);
		var ph = $('#youtubeSearchHeading').outerHeight(true);

//		console.log ("wh "+wh+" woh "+woh+" th "+th+" sbh "+sbh+" poh "+poh+" ph "+ph);

		var yth = wh-woh-th-sbh-poh;						// window - well overhead - tab height - search bar - panel overhead 
//		console.log ("div height = "+yth);

		var ytph = ((yth-2)/2) - ph; 
//		console.log ("ytph = "+ytph);

		var npsh;
		if (getCookie("bigPicture")=="true") npsh = wh*2/3;
		else npsh = wh/2;

		// $('#nowPlayingWell').height (npsh-60); -- 60 & -5-

        $('#nowPlayingWell').height (npsh-110);

        $("#nowPlayingWell").height (310);

		$('#YoutubeSearchResultsBox').height(ytph);				// 2 px space between two sections
		$('#YoutubeHistoryBox').height(ytph);

		var npwh = $("#nowPlayingWell").outerHeight(true);		// now playing well height
		var pth = $("#playlistTabs").outerHeight(true);			// tabs height
		bbh = $("#playlistButtons").outerHeight(true);			// button bar height

		// $('#playlistWell').height (wh-npsh+15);

		$('#playlistWell').height (wh-npwh-29);

        // $("#nowPlayingWell").removeAttr("style");

		// $('#playlistContainer').height(wh-npsh-5-pth-bbh-poh);
		// $('#playlistContainer').height(wh-npsh-pth-bbh-poh);

		$('#playlistContainer').height(wh-npwh-pth-bbh-poh-110);


//	console.log ("wh "+wh+" pth "+pth+" bbh "+bbh+" poh "+poh+" soh"+soh);
		
		$('#presetsBox').height(wh-npsh-80-woh-poh-soh);

//		$('#CDPanel').height(wh-npwh-woh-th-poh-soh);

		
//	console.log ("wh "+wh+" npwh "+npwh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh);
//	console.log ("div height = "+(wh-npwh-woh-th-poh-soh));

		var arhh = $("#artistHeader").outerHeight(true);			// artist header
		$('#ArtistAlbumsBox').height((wh+10)/2-woh-arhh-poh);		// 10 = final margin

		var alhh = $("#albumHeader").outerHeight(true);				// album header
		$('#AlbumTracksBox').height((wh+10)/2-woh-alhh-poh);	

//	console.log ("wh "+wh+" woh "+woh+" alhh "+alhh+" poh "+poh);
//	console.log ("div height = "+(wh/2-woh-alhh-poh));


		woh = vpbm (".well");							// well overhead
		th = $("#SearchTab").outerHeight(true);			// tab height
		bbh = $("#USBButtons").outerHeight(true);		// button bar height
		poh = vpbm (".panelContent");					// panelContent overhead

		var usbh = wh-woh-th-poh;

//	console.log ("wh "+wh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh+" soh "+soh);
//	console.log ("USB height = "+usbh);
	
		var bch = $("#USBBreadcrumb").outerHeight(true);		// breadcrumb height
		
		$('#USBPanel').height(usbh);
		$('#USBItemsBox').height(usbh - bbh - 2 * bch);

	}
	else {

		var mbnh = $('#handsetNav').outerHeight(true);		// mobile nav bar height

		var woh = vpbm (".well");							// well overhead
		var th = $("#SearchTab").outerHeight(true);			// tab height
		var bbh = $(".btn-group").outerHeight(true);		// button bar height
		var poh = vpbm (".panelContent");					// panelContent overhead
		var soh = vpbm ("#SearchContainer");				// searchContainer overhead

		var srch = wh-woh-th-bbh-poh-soh;
		srch -= mbnh;

//	console.log ("wh "+wh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh+" soh "+soh);
//	console.log ("div height = "+srch);

		$('#SearchContainer').height(srch);

		$('#vTunerBox').height((srch-bbh-10)/2);				// 10 px space between two sections
		$('#vTunerSearchBox').height((srch-bbh-10)/2);

		$('#YoutubeSearchResultsBox').height((srch-bbh-10)/2);				// 10 px space between two sections
		$('#YoutubeHistoryBox').height((srch-bbh-10)/2);

		var npht = wh-mbnh-15;									// vertical border + padding
		if (npht > 600) npht = 500;								// limit height

		$('#nowPlayingWell').height (npht);	
		// $("#nowPlayingWell").removeAttr("height");

		var npwh = $("#nowPlayingWell").outerHeight(true);		// now playing well height

//		console.log ("nowPlaying Well height "+npwh+" wh="+wh+ " mbnh="+mbnh);


		var sbh = $('#youtubeSearchBar').outerHeight(true);
		var ph = $('#youtubeSearchHeading').outerHeight(true);

//		console.log ("wh "+wh+" woh "+woh+" th "+th+" sbh "+sbh+" poh "+poh+" ph "+ph+" mbnh "+mbnh);

		var yth = wh-woh-th-sbh-poh-mbnh;						// window - well overhead - tab height - search bar - panel overhead 
//		console.log ("div height = "+yth);

		var ytph = ((yth-2)/2) - ph; 
//		console.log ("ytph = "+ytph);

//		$('#YoutubeSearchResultsBox').height(ytph);				// 2 px space between two sections
//		$('#YoutubeHistoryBox').height(ytph);

		
		var temp = wh-woh-th-bbh-poh-soh;
//		console.log ("presetsBox.height = "+temp);
		$('#presetsBox').height(temp);
		
		var temp = wh-woh-th-bbh-poh-soh - mbnh;
//		console.log ("playlistContainer.height = "+temp);
		$('#playlistContainer').height(temp);

		var bch = $("#USBBreadcrumb").outerHeight(true);		// breadcrumb height

		$('#USBPanel').height(temp);
		$('#USBItemsBox').height(temp - bbh - 2*bch);
		
		$('#CDPanel').height(wh-woh-th-poh-soh - mbnh - 2);
		

//	console.log ("wh "+wh+" npwh "+npwh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh+" mbnh "+mbnh);
//	console.log ("div height = "+(wh-woh-th-poh-soh));

		var arhh = $("#artistHeader").outerHeight(true);			// artist header
//		$('#ArtistAlbumsBox').height((wh+10)/2-woh-arhh-poh);		// 10 = final margin
		$('#ArtistAlbumsBox').height(srch);					
		
		var alhh = $("#albumHeader").outerHeight(true);				// album header
//		$('#AlbumTracksBox').height((wh+10)/2-woh-alhh-poh);	
		$('#AlbumTracksBox').height(srch);

//	console.log ("wh "+wh+" woh "+woh+" alhh "+alhh+" poh "+poh);
//	console.log ("div height = "+(wh/2-woh-alhh-poh));


	}

	setCDBoxHeight ();
}

// switches between mobile display and desktop display

function desktop (){
	
//	return $(window).width () >= 975;

//	return ((getCookie("uiMode")!="mobile")&& ($(window).width () >= 975));

//	console.log ("desktop () cookie = "+getCookie("uiMode"));

	if (getCookie("uiMode")=="desktop") return true;
	if (getCookie("uiMode")=="mobile") return false;	
	return $(window).width () >= 600;

}	

function mobileModeSwitch () {

	if (desktop ()){							// desktop mode
		$('#handsetNav').hide();
		$('#playlistTabs').show();
		$('#searchTabs').show();
		$('#settingsButton').show();

		$('#ColumnOne').removeClass ('col-md-4').addClass('col-xs-4');
		$('#ColumnTwo').removeClass ('col-md-4').addClass('col-xs-4');		
		$('#ColumnThree').removeClass ('col-md-4').addClass('col-xs-4');
		
//		$('#mycanvas').show();		
		$('#nowPlayingHeader').show();
						
	}
	else {										// mobile mode
		$('#handsetNav').show();
		$('#playlistTabs').hide();		
		$('#searchTabs').hide();
		$('#settingsButton').hide();	

		$('#ColumnOne').removeClass ('col-xs-4').addClass('col-md-4');
		$('#ColumnTwo').removeClass ('col-xs-4').addClass('col-md-4');		
		$('#ColumnThree').removeClass ('col-xs-4').addClass('col-md-4');

//		$('#mycanvas').show();
//		$('#mycanvas').hide();	
		$('#nowPlayingHeader').hide();
	}	
}


function selectPanelForMobile (){
	
	
	var desk = desktop ();
	var mobile = !desk;

	if ((selectedPanelForMobile == 0)||desk) $('#nowPlayingWell').show ();
	else $('#nowPlayingWell').hide ();

	if ((mobile && selectedPanelForMobile == 0)) $('#playlistWell').hide ();
	else $('#playlistWell').show ();
	
	if (desk){
		$('#ColumnOne').show ();
		$('#ColumnTwo').show ();		

		if (selectedSearchSubPanel== 0) $('#SearchPanel').show ();
		else $('#SearchPanel').hide ();

		if (selectedSearchSubPanel== 1) $('#VTunerPanel').show ();
		else $('#VTunerPanel').hide ();

		if (selectedSearchSubPanel== 3) $('#USBPanel').show ();
		else $('#USBPanel').hide ();
		
		if ((selectedSubPanel == 0)) $('#playlistPanel').show ();
		else $('#playlistPanel').hide ();

		if ((selectedSubPanel == 1)) $('#CDPanel').show ();
		else $('#CDPanel').hide ();

		if ((selectedSubPanel == 2)) $('#PresetsPanel').show ();
		else $('#PresetsPanel').hide ();
			
		if ((selectedSubPanel == 3)) $('#UploadPanel').show ();
		else $('#UploadPanel').hide ();

	}
	else {
	
		if (selectedPanelForMobile == 1) $('#SearchPanel').show ();
		else $('#SearchPanel').hide ();

		if (selectedPanelForMobile == 2) $('#VTunerPanel').show ();
		else $('#VTunerPanel').hide ();

		if (selectedPanelForMobile == 9) $('#YoutubePanel').show ();
		else $('#YoutubePanel').hide ();

		if (selectedPanelForMobile == 11) $('#USBPanel').show ();
		else $('#USBPanel').hide ();

		
		if ((selectedPanelForMobile == 0)||
			(selectedPanelForMobile == 3)||
			(selectedPanelForMobile == 4)||
			(selectedPanelForMobile == 5)||
			(selectedPanelForMobile == 6)){
				$('#ColumnOne').show ();
		}
		else 		
				$('#ColumnOne').hide ();													

		if ((selectedPanelForMobile == 1)||
			(selectedPanelForMobile == 2)||
			(selectedPanelForMobile == 9)||
			(selectedPanelForMobile == 11)){
				$('#ColumnTwo').show ();
		}
		else 		
				$('#ColumnTwo').hide ();


		if ((selectedPanelForMobile == 3)) $('#playlistPanel').show ();
		else $('#playlistPanel').hide ();

		if ((selectedPanelForMobile == 4)) $('#CDPanel').show ();
		else $('#CDPanel').hide ();
	
		if ((selectedPanelForMobile == 5)) $('#UploadPanel').show ();
		else $('#UploadPanel').hide ();

		if ((selectedPanelForMobile == 6)) $('#PresetsPanel').show ();
		else $('#PresetsPanel').hide ();

		
	}	
		
	if ((selectedPanelForMobile == 7)||desk) $('#AlbumWell').show ();
	else $('#AlbumWell').hide ();

	if ((selectedPanelForMobile == 8)||desk) $('#ArtistWell').show ();
	else $('#ArtistWell').hide ();	
}	


function selectPlaylistSubPanel (index){

	selectedSubPanel = index;
	if (index == 0) {
		$('#playlistPanel').show ();
		$('#playlistTab').removeClass ('myGrey').addClass ('selected').removeClass ('deselected');
	}	
	else {
		$('#playlistPanel').hide ();
		$('#playlistTab').addClass ('myGrey').addClass('deselected').removeClass('selected');;
	}	
	
	if (index == 1) {
		$('#CDPanel').show ();
		$('#CDTab').removeClass ('myGrey').addClass ('selected').removeClass ('deselected');		
	}	
	else {
		$('#CDPanel').hide ();
		$('#CDTab').addClass ('myGrey').addClass('deselected').removeClass('selected');		
	}	
	
	if (index == 2) {
		$('#PresetsPanel').show ();
		$('#PresetsTab').removeClass ('myGrey').addClass ('selected').removeClass ('deselected');	
	}	
	else {
		$('#PresetsPanel').hide ();
		$('#PresetsTab').addClass ('myGrey').addClass('deselected').removeClass('selected');;
	}
	if (index == 3) {
		$('#UploadPanel').show ();
		$('#UploadTab').removeClass ('myGrey').addClass ('selected').removeClass ('deselected');			
	}	
	else {
		$('#UploadPanel').hide ();
		$('#UploadTab').addClass ('myGrey').addClass('deselected').removeClass('selected');;
	}	

	adjustHeights ();
	
}

function selectSearchSubPanel (index){
	
	selectedSearchSubPanel = index;

	if (index == 0) {
		$('#SearchPanel').show ();
//		searchFunction ();
		$('#SearchTab').removeClass('myGrey').addClass ('selected').removeClass ('deselected');
	}	
	else {
		$('#SearchPanel').hide ();
		$('#SearchTab').addClass('myGrey').addClass('deselected').removeClass('selected');;
	}	
	
	if (index == 1) {
		$('#VTunerPanel').show ();
		vTunerInit ();
		$('#VTunerTab').removeClass('myGrey').addClass ('selected').removeClass ('deselected');
	}	
	else {
		$('#VTunerPanel').hide ();
		$('#VTunerTab').addClass('myGrey').addClass('deselected').removeClass('selected');;
	}	
	
	if (index == 2) {
		$('#YoutubePanel').show ();
		getHistory (refreshHistoryList);	
		$('#YoutubeTab').removeClass('myGrey').addClass ('selected').removeClass ('deselected');
	}
	else {
		$('#YoutubePanel').hide ();
		$('#YoutubeTab').addClass('myGrey').addClass('deselected').removeClass('selected');;
	}	

	if (index == 3) {
		refreshUSB ();
		$('#USBPanel').show ();
		$('#USBTab').removeClass('myGrey').addClass ('selected').removeClass ('deselected');		
	}
	else {
		$('#USBPanel').hide ();
		$('#USBTab').addClass('myGrey').addClass('deselected').removeClass('selected');;		
	}	
	
	adjustHeights ();
}


// onclick function for main navigation


function panelBackFunction(){
	
//	console.log ("history length ",lastPanels.length," first item ",lastPanels[0]);

	if (lastPanels.length >= 1){
		
		pickPanel (lastPanels.pop());
		lastPanels.pop();
		
	}	
	
}	




var panelNames = ["Now Playing","Search","vTuner","Playlists","CD","Upload"," Presets","Album","Artist","Youtube","Settings","USB","Bluetooth"];

function pickPanel (index){

//	console.log ("pickPanel "+index);

	if (index == 10) {
		openSettingsModal();
		return;
	}	
	if (index == 12) {
		openBluetoothModal();
		return;
	}
		
	lastPanels.push(selectedPanelForMobile);
	
	selectedPanelForMobile = index;
	selectPanelForMobile ();

	setCDBoxHeight ();

	if (index == 1)	searchFunction ();
	if (index == 2) vTunerInit ();
	if (index == 9) {
//		adjustHeights ();
		getHistory (refreshHistoryList);
	}	

	$("#selectedPanel").html(panelNames[index]+' <span class="caret"></span>');
	$('#selectedPanel').attr ("aria-label","Main Navigation "+panelNames[index]+" selected");	

}	



function renamePlaylist (){

	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
	openRenameWindow (playlistToID (selectedPlaylist),playlists[selectedPlaylist].name);

}	


function deletePlaylistPartTwo (){

	$('#generalAreYouSureModal').modal('hide');	

	var id = playlistToID (selectedPlaylist);
	var urlTail = 'deleteID&id='+id+'&time='+ new Date ().getTime();	

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		searchFunction (true);					// refresh		
		refreshPlaylistsFunction ();				
	});		
}	


function deletePlaylist (){
	
	areYouSure ("Delete playlist "+playlists[selectedPlaylist].name,deletePlaylistPartTwo);
	
}	


function pickSource (i){
	
	selectedSource = i;
	if (i >= playlists.length) $("#mixMenu2").html('All Music <span class="caret"></span>');
	else $("#mixMenu2").html(playlists[i].name+' <span class="caret"></span>');
	mixText ();	
}

function pickDest (i){
	
	selectedDest = i;
	$("#mixMenu3").html(playlists[i].name+' <span class="caret"></span>');
	mixText ();	
}

function pickMode (i){
	
	selectedMode = i;
	
	var text;
	
	if (selectedMode == 0) text = "Append";
	else if (selectedMode == 1) text = "Subtract";
	else if (selectedMode == 2) text = "Merge";
	
	$("#mixMenu1").html(text+' <span class="caret"></span>');
	
	mixText ();
}

function mixText (){


	var text;
	
	if (selectedMode == 0) text = "to ";
	else if (selectedMode == 1) text = "from ";
	else if (selectedMode == 2) text = "with ";
	
//	text += playlists[selectedPlaylist].name;
	$("#mixText").text(text);
}	

function mixPlaylist (){


	var ul = $('#mixSourceDropdownUl');
	ul.children().remove();
	var l = playlists.length;
	
	pickMode (selectedMode);
	
	for (var i=0;i<l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickSource('+i+')">'+
			playlists[i].name+' ('+playlists[i].length+')</a></li>');
	}
	ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickSource('+i+')">All Music</a></li>');
	pickSource (selectedSource);
	

	ul = $('#mixDestDropdownUl');
	ul.children().remove();
	
	for (var i=0;i<l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickDest('+i+')">'+
			playlists[i].name+' ('+playlists[i].length+')</a></li>');
	}
	pickDest (selectedDest);	
	

	$('#mixModal').modal();
	
}
		
function mixOKFunction (){
	
	urlTail = 'mixPlaylists&mode='+selectedMode+'&source='+selectedSource+'&dest='+selectedDest+'&time='+ new Date ().getTime();		// IE;
	
	console.log (urlTail);
	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		selectedPlaylist = selectedDest;
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();
		
		$('#mixModal').modal("hide");
		
	});
	
		
	
}

function createPlaylist (){
	
	$('#newPlaylistValue').val("");
	$('#newPlaylistValue').focus();		
	$('#newPlaylistModal').modal();
	
}

function newPlaylistOKFunction (){

	var newName = $('#newPlaylistValue').val();
	console.log ("newPlaylistOKFunction () "+newName);
	
	var urlTail = 'newPlaylist&time='+ new Date ().getTime()+'&name='+	encodeURIComponent(newName);
			
	console.log (urlTail);
	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();
		
		$('#newPlaylistModal').modal("hide");
		
	});	
}			



function playlistToPreset (preset){


	id = 4000000 + selectedPlaylist;
	var urlTail = 'setPresetFromID&id='+id+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});		
	
	$('#vTunerSearchMenuModal').modal('hide');
	selectPlaylistSubPanel(2);
}	


function assignPlaylist (){
	
	console.log ("assignPlaylist "+selectedPlaylist);

	$('#vTunerSearchMenuModal').modal();
	$('#vTunerSearchMenuTitle').html("Move "+playlists[selectedPlaylist].name+"<br />To Preset");
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#vTunerSearchMenuBody');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<button type="button" class="btn btn-default btn-block leftjustified" onclick="playlistToPreset('+i+')" >['+i+'] '+data[i].name+'</button>');
			results.append(el);
		}

	});	
		
}	
	

function searchItemFunction (index){

	console.log ("searchItemFunction ("+index+")");
	
	selectedSearchItem = matches[index];
	var id = selectedSearchItem.id;

	var name = '';
	if (isTrack(id)) name = selectedSearchItem.track;
	else if (isAlbum(id)) name = selectedSearchItem.album;
	else if (isArtist(id)) name = selectedSearchItem.artist;
	else if (isRadio(id)) name = selectedSearchItem.radio;
	else if (isVideo(id)) name = selectedSearchItem.video;
		
	$('#searchItemTitle').html(getIcon(id)+' '+name);	
	
	$('#areYouSureTitle').html(getIcon(id)+' '+name);
	$('#addToPlaylistTitle').html(getIcon(id)+' '+name);
	
	if (isAlbum(id)) $(".artButton").show();
	else $(".artButton").hide();
	
	$('#searchItemModal').modal();	
	
}

function albumItemFunction (index){

	console.log ("albumItemFunction ("+index+")");

	selectedSearchItem = albumTracks[index];

	var id = albumTracks[index].id;
	var name = albumTracks[index].name;

	selectedSearchItem.track = name;	
	
	console.log ("id="+id);		
	console.log ("name="+name);

	$('#searchItemTitle').html(getIcon(id)+' '+name);	
	
	$('#areYouSureTitle').html(getIcon(id)+' '+name);
	$('#addToPlaylistTitle').html(getIcon(id)+' '+name);

	if (isAlbum(id)) $(".artButton").show();
	else $(".artButton").hide();
	
	$('#searchItemModal').modal();

	
}	


function artistItemFunction (index){

	console.log ("artistItemFunction ("+index+")");

	selectedSearchItem = artistAlbums[index];

	var id = artistAlbums[index].id;
	var name = artistAlbums[index].name;

	listalbumFunction (id);

	selectedSearchItem.album = name;	
	
	console.log ("id="+id);		
	console.log ("name="+name);

	$('#searchItemTitle').html(getIcon(id)+' '+name);	
	
	$('#areYouSureTitle').html(getIcon(id)+' '+name);
	$('#addToPlaylistTitle').html(getIcon(id)+' '+name);

	if (isAlbum(id)) $(".artButton").show();
	else $(".artButton").hide();
	
	$('#searchItemModal').modal();

	
}


function searchItemDeleteButton (){

	$('#searchItemModal').modal("hide");
		
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}		
	$('#areYouSureModal').modal();		
}	
	
function searchItemAddButton (){

	$('#searchItemModal').modal("hide");

	pickAddTarget (targetPlaylist);
	
	var ul = $('#addToPlaylistDropdownUl');
	ul.children().remove();
	var l = playlists.length;
		
	for (var i=0;i<l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickAddTarget('+i+')">'+
			playlists[i].name+' ('+playlists[i].length+')</a></li>');
	}	
	
	
	$('#addToPlaylistModal').modal();		
}

function searchItemRenameButton (){

	var id = selectedSearchItem.id;

	var name = '';
	if (isTrack(id)) name = selectedSearchItem.track;
	else if (isAlbum(id)) name = selectedSearchItem.album;
	else if (isArtist(id)) name = selectedSearchItem.artist;
	else if (isRadio(id)) name = selectedSearchItem.radio;
		
	$('#searchItemModal').modal("hide");

	openRenameWindow (id,name);
	
}	


function deleteConfirmed (){
	
	console.log ("deleteConfirmed () id = "+selectedSearchItem.id);
	
	$('#areYouSureModal').modal("hide");
		
	var urlTail = 'deleteID&id='+selectedSearchItem.id+'&time='+ new Date ().getTime();		// IE;			
	
	console.log ("tail = "+urlTail);
	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		searchFunction (true);					// refresh		
		listalbumAndArtistInSitu (selectedAlbum);
//		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();				
	});		
	
}	

function pickAddTarget (index){
	
	targetPlaylist = index;
	$("#addToPlaylistMenu").html(playlists[index].name+' <span class="caret"></span>');

}

function addToPlaylistOK (){

	console.log ("addToPlaylistOK () id = "+selectedSearchItem.id+" playlist = "+targetPlaylist);

	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}

	$('#addToPlaylistModal').modal("hide");

	urlTail = 'addIdToPlaylist&id='+selectedSearchItem.id+'&playlist='+targetPlaylist+'&index='+playlists[targetPlaylist].length+'&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();
	});	
		
}		

function randomToggle (){

	var r;
	
	console.log ("randomToggle ()");
	
	$('#randomIcon').toggleClass("myGrey");
	
	if ($('#randomIcon').hasClass("myGrey")) r=0;
	else r=1;
	
	var urlTail = 'setRandom&random='+r+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
	});		
	
	
}	

function alphaToggle (){

	var r;
	
	console.log ("alphaToggle ()");
	
	$('#alphaIcon').toggleClass("myGrey");
	
	if ($('#alphaIcon').hasClass("myGrey")) r=0;
	else r=1;
	
	var urlTail = 'setSorted&sorted='+r+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		searchFunction ();
		
	});		
	
	
}	

function openDebugModal (){

	$("#settingsModal").modal('hide');		
	$("#debugModal").modal();
	refreshDebug ();
	debugTimer = setInterval (refreshDebug,500);
	
}

function closeDebugModal (){
	
	console.log ("closeDebugModal ()");
	clearInterval (debugTimer);
	$("#debugModal").modal('hide');	
}

function refreshDebug (){

//	console.log ("refreshDebug ()");
	
	var urlTail = 'getWebDebug&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log (data);
		
		text = $("#debugText");
		var l = data.length;
		
		while (data.length){
			var p = data.shift();
			console.log ("Debug> "+p);
//			text.append ("<p>"+p+"</p>");
			text.append ("<p></p>");
			text.children().last().text(p); 
		}
		while (text.children().length > 200){
			text.children().first().remove();
		}
		if (l) {
			refreshDebug ();
			var top = document.getElementById("debugText").scrollHeight;
			text.scrollTop (top);
		}	

	});
	
}	

function clearDebugModal (){

	var text = $("#debugText");	
	text.children().remove();	
	var top = document.getElementById("debugText").scrollHeight;
	text.scrollTop (top)	
}	


function openSettingsModal (){
	
	$("#settingsModal").modal();
	refreshSettings ();

}

function pickGuest (i){
	
	lastGuestPlaylist = i;
	if (i == 0) $("#guestMenu").html('All Music <span class="caret"></span>');
	else $("#guestMenu").html(playlists[i-1].name+' <span class="caret"></span>');
	
	guestModeClick ();	

}

function getSpace (callback){

	var urlTail = 'getSpace&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		callback (data*1000);
	});	
}	

function checkUpload (callback){

	var urlTail = 'checkUpload&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		callback (data);
	});
	
}	


function refreshSettings (){

//	console.log ("refreshSettings ()");
	
	var urlTail = 'getWebInfo&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log (data);
		
		var b = $('#settingsBody');
		b.children().remove();
		b.append('<p>Software '+data.version+'</p>');
		b.append('<p>'+data.tracks+' tracks in '+data.albums+' albums '+data.artists+' artists</p>');
		b.append('<p>'+data.wavs+' WAV '+data.flacs+' FLAC '+data.mp3s+' MP3 '+data.aacs+' AAC</p>');
		b.append('<p>Capacity '+data.capacity+'G Used '+data.used+'Gb</p>');
		b.append('<p>USB '+data.USBTracks+' tracks in '+data.USBAlbums+' albums '+data.USBArtists+' artists</p>');
		b.append('<p>'+data.videos+' Youtubes</p>');
	});
	
	
	var ul = $('#guestDropdownUl');
	ul.children().remove();
	var l = playlists.length;

	ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickGuest(0)">All Music</a></li>');	
	for (var i=1;i<=l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickGuest('+i+')">'+
			playlists[i-1].name+' ('+playlists[i-1].length+')</a></li>');
	}

	
	pickGuest (lastGuestPlaylist);
}

function dropArt (ev){

	ev.preventDefault();

	console.log ("count = "+ev.dataTransfer.files.length);
	console.log ("first = "+ev.dataTransfer.files[0].name);
	console.log ("selectedAlbumName = "+selectedAlbumName);
	console.log ("selectedArtistName = "+selectedArtistName);
	
	selectPlaylistSubPanel(3);

	uploadArtist = selectedArtistName;
	uploadAlbum = selectedAlbumName;
	uploadFiles = ev.dataTransfer.files;
	
	$('#uploadArtist').val(selectedArtistName);
	$('#uploadAlbum').val(selectedAlbumName);

	if (uploadArtist && uploadAlbum && uploadFiles.length){
		
		console.log ("name of first file "+uploadFiles[0].name);
		console.dir (uploadFiles);
		
		if (uploadFiles[0].name.toLowerCase().indexOf (".jpg") != -1){
			uploadFiles[0].name = "coverart.jpg";
			console.log ("replaced by coverart.jpg");
		}	

		console.dir (uploadFiles);

		currentUpload = 0;
		uploadTry = 1;
		var n = currentUpload+1;

		$('#uploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length);		
		$('#uploading').show ();
		
		uploadEnabled = true;		
		
		uploadOne ();

	}

}

function clickArt (){
	
	console.log ("clickArt ()");
	console.log ("selectedAlbumName = "+selectedAlbumName);
	console.log ("selectedArtistName = "+selectedArtistName);
	
	selectPlaylistSubPanel(3);

	uploadArtist = selectedArtistName;
	uploadAlbum = selectedAlbumName;
	
	$('#uploadArtist').val(selectedArtistName);
	$('#uploadAlbum').val(selectedAlbumName);

}	

function displayArt (id){
	
	
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?getAlbumArt&id="+id+"&time="+ new Date ().getTime());
	xhr.responseType = "blob";
	xhr.onload = function (){	
		
//		console.log ("getAlbumArt replied");
		
		var	imageUrl;
			
		if (this.response.size){
//			console.log ("Reply size = "+this.response.size);
			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (this.response);
		}
		else imageUrl = "noimage.jpg";
		
		img = $("#albumImage");
		img.attr ("src",imageUrl);

	};	
	xhr.send ();	
	
}

function displayRadioLogo (url){
	
	console.log ("displayRadioLogo () "+url);

	var text = $('#nowPlayingBody');
	var art = $('#nowPlayingArt');

	art.children().remove();

//	text.addClass ("col-sm-8");		// new bigPicture
//	art.addClass ("col-sm-4");

	art.show ();

	art.append ('<img src="'+url+'" class="flexArt">');
}

function displayCurrentArt (){
	
//	console.log ("displayCurrentArt ()");

	var text = $('#nowPlayingBody');
	var art = $('#nowPlayingArt');

//	text.removeClass("col-sm-8");		// new big picture
//	art.removeClass("col-sm-4");
	art.hide ();
	
	art.children().remove();
			
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?getCurrentArt&time="+ new Date ().getTime());
	xhr.responseType = "blob";

	xhr.onload = function (){
		
//		console.log ("getCurrentArt replied");
		
		var	imageUrl;
			
		if (this.response.size){

//			console.log ("Reply size = "+this.response.size);

			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (this.response);
			
//			text.addClass ("col-sm-8");		// new bigPicture
//			art.addClass ("col-sm-4");
			art.show ();
			
			art.append ('<img src="'+imageUrl+'" class="flexArt">');
			
		}
 
	};
	xhr.send ();
	
}

function getLocalYoutubeThumbnail (target,id){
	
	console.log ("getLocalYoutubeThumbnail () id="+id);

	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?getVideoThumbnail&id="+id+"&time="+ new Date ().getTime());
	xhr.responseType = "blob";

	xhr.onload = function (){
		
//		console.log ("getVideoThumbnail replied");
		
		var	imageUrl;
			
		if (this.response.size > 2){

			console.log ("Reply size = "+this.response.size);

			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (this.response);
			
			target.append ('<div class="historyPic"><img src="'+imageUrl+'" width="100%"><span class="historyCheck glyphicon glyphicon-ok"></span></div>');
			
		}
		else {
			console.log ("no local thumbnail - may be loading - try online");
			target.append ('<img width="100%" src = "https://i.ytimg.com/vi/'+id+'/default.jpg">');			
		}	
 
	};
	xhr.send ();
	
}	
	
function clearCurrentArt (){
	
	console.log ("clearCurrentArt ()");

	var text = $('#nowPlayingBody');
	var art = $('#nowPlayingArt');

//	text.removeClass("col-sm-8");		// new big picture
//	art.removeClass("col-sm-4");
	art.hide ();
	
	art.children().remove();
	
}



function setCompressionText (mode){
	
//	console.log ("setCompressionText "+mode);
	
	$("#compressionMenu").html(mode +' <span class="caret"></span>');
	
}	

function setCompression (mode){

	setCompressionText (mode);	

	var urlTail = 'setCompression&mode='+mode+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}

function setSegueText (mode){
	
	$("#segueMenu").html(mode +' <span class="caret"></span>');
	
}	

function setSegue (mode){

	setSegueText (mode);	

	var urlTail = 'setSegue&mode='+mode+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}

function scanDisk (){


//	console.log ("scanDisk ()");

	var urlTail = 'scanDisk&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}


function setLoggingText (mode){
	
//	console.log ("setLoggingText "+mode);
	
	$("#loggingMenu").html(mode +' <span class="caret"></span>');
	
}	

function setLogging (mode){


	setLoggingText (mode);

	var urlTail = 'setLogging&mode='+mode+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}


function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function webModeClick (){
	
//	console.log ("webModeClick () state="+$("#webMode").prop("checked"));

//	if ($("#webMode").prop("checked")) setCookie ("uiMode","mobile",365);	
//	else setCookie ("uiMode","normal",365);

	if ($("#webModeAuto").prop("checked")) setCookie ("uiMode","normal",365);	
	if ($("#webModeMobile").prop("checked")) setCookie ("uiMode","mobile",365);
	if ($("#webModeDesktop").prop("checked")) setCookie ("uiMode","desktop",365);
	
	adjustHeights ();	
	
}	

function adjustForBigPicture (){

	if (getCookie ("bigPicture")=="true"){
		$('#canvasBox').hide();
		$('#progressSliderDiv').hide();
		$('#nowPlayingDetails').removeClass ("myflex").addClass ("artflexV");
		$('#nowPlayingBody').removeClass ("flex2");
	}
	else {
		$('#canvasBox').show();		
		$('#progressSliderDiv').show();
		$('#nowPlayingDetails').addClass ("myflex").removeClass ("artflexV");
		$('#nowPlayingBody').addClass ("flex2");
	}		

}

function bigPictureClick (){
	
//	console.log ("bigPictureClick () state="+$("#webBigPicture").prop("checked"));	

	if ($("#webBigPicture").prop("checked")) setCookie ("bigPicture","true",365);	
	else setCookie ("bigPicture","false",365);	

	adjustForBigPicture ();

	adjustHeights ();									
}

function defaultUIClick(){
	
	if ($("#webDefaultUI").prop("checked")) {
		setCookie ("whichUI","mobile",365);
		window.location.href="mobile.html";
	}	
	else setCookie ("whichUI","original",365);		
	
}	

function tvUiClick (){
	
	
	if ($("#tvUi").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'tvui&mode='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){

		
	});		
	
}

function guestModeClick (){
	
	console.log ("guest mode clicked");
	
	if ($("#guestMode").prop("checked")) lastGuest = 1;
	else lastGuest = 0;	
	
	var urlTail = 'guest&mode='+lastGuest+'&playlist='+lastGuestPlaylist+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){

		
	});
	
	searchFunction ();
	
	if (lastGuest == 1){
		
		if (lastGuestPlaylist > 0) {
			selectedPlaylist = lastGuestPlaylist-1;
			refreshPlaylistsFunction ();			
		}	
			
	}
}


function HDMIClick (){
	
	console.log ("HDMIClick ()");
	
	if ($("#hdmi").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'hdmi&mode='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});		
	
}

function vCacheClick (){
	
	console.log ("vCacheClick ()");
	
	if ($("#vCache").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'vCache&mode='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});		
	
}

function equaliserClick (){
	
	console.log ("equaliserClick ()");
	
	if ($("#equaliser").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'equaliser&enabled='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});		
	
}

function pasteArt (ev){

	var type;
	
	console.log ("pasteArt ()");
	var items = (event.clipboardData || event.originalEvent.clipboardData).items;
	console.log (JSON.stringify(items));
	for (index in items){
		item = items[index]
//		console.log ("Kind["+index+"]="+item.kind);
		if (item.kind === "file"){
	
			console.log ("File found type="+item.type);
			
			if (item.type.indexOf ("png")>=0) type = "png";
			else if (item.type.indexOf ("jpg")>=0) type = "jpg";
			else continue;
			
			var blob = item.getAsFile();
			
/*			
			var reader = new FileReader ();
			reader.onload = function (event){
				console.log ("Reader.onload ()"+event.target.result)
			};
			reader.readAsDataURL (blob);
*/

			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (blob);			
			console.log ("imageUrl"+imageUrl);

			img = $("#albumImage");
			img.attr ("src",imageUrl);	
			
			uploadBlob (blob,type);		
			
		}		
	}	
}	

function uploadBlob (blob,type){
	
	var formData = new FormData ();

	formData.append (selectedAlbumName,blob,"coverArt."+type);

	$.ajax ({
		url: 'b2cgi.fcgi?upload&artist='+selectedArtistName,
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {

			console.log ("Upload success");
		
			},
		error: function (jqXHR, textStatus, errorThrown){

			console.log ("Upload failed");
	
			}
		});	
}


function refreshBluetooth (){
	
	var urlTail = 'getBluetoothStatus&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){

		var n;
		var s = JSON.stringify(data);
		console.log ("Bluetooth status = "+s);

		if (data.bluetoothScanning == "true") $('#bluetoothBusy').show ();				
		else $('#bluetoothBusy').hide ();
		
		if (JSON.stringify(lastBluetoothStatus) != s){
			lastBluetoothStatus = data;
			var btb = $('#bluetoothBody');
			btb.children().remove();
//			btb.append ('<p>'+JSON.stringify(data)+'</p>');
			if (!isBTube ()){
				if (data.dongle == "true") 	btb.append ('<p>Dongle present</p>');
				else btb.append ('<p>No Dongle</p>');
			}	
			btb.append ('<p>'+data.pairedDevices.length+' Paired Devices</p>');			
			
			if (data.pairedDevices.length > 0){
				
				btb.append ('<div class="well"></div>');
				var w = btb.children().last();
				
				for (n=0;n<data.pairedDevices.length;n++){
					if (data.outputDevice == data.pairedDevices[n].deviceName) icon = '<span class="glyphicon glyphicon-volume-up"></span>';
					else if (data.inputDevice == data.pairedDevices[n].deviceName) icon = '<span class="glyphicon glyphicon-phone"></span>';
					else icon = '';
					
					var output = "";
//					if (data.pairedDevices[n].deviceClass == "audio") output = '<a class="btn btn-default btn-xs" onclick="clickPaired('+n+')">'+button+'</a>';

					if (data.pairedDevices[n].deviceClass == "audio") {
					
						if (data.outputDevice == data.pairedDevices[n].deviceName){
							output = '<div class="nomargin checkbox"><label><input type="checkbox" checked="true" onclick="clickPaired('+n+')">Output</label></div>';
						}	
						else { 	
							output = '<div class="nomargin checkbox"><label><input type="checkbox" onclick="clickPaired('+n+')">Output</label></div>';
						}	
					}
					w.append ('<div><div class="row">'+
								'<div class="col-xs-1">'+icon+'</div>'+
								'<div class="col-xs-7"><p class="mylink" onclick="clickPaired('+n+')">'+data.pairedDevices[n].deviceName+'</p></div>'+
								'<div class="col-xs-2">'+output+'</div>'+								
								'<div class="col-xs-2"><a class="btn btn-default btn-xs" onclick="clickForget('+n+')">Unpair</a></div>'+
								'</div></div>'
								);				
				}
			}
/*			
			if (data.outputDevice != "") btb.append ('<p>Connected Output Device: '+data.outputDevice+'</p>')
			if (data.inputDevice != "") btb.append ('<p>Connected Input Device: '+data.inputDevice+'</p>')
*/
				

			if (data.scannedDevices.length){
				btb.append ('<p>Last scan found '+data.scannedDevices.length+' Devices</p>');			

				btb.append ('<div class="well"></div>');
				w = btb.children().last();
							
				for (n=0;n<data.scannedDevices.length;n++){

					var button = isPaired (n,data)?'':'<a class="btn btn-default btn-xs" onclick="clickScanned('+n+')">Pair</a>';
	
					w.append ('<div><div class="row">'+
								'<div class="col-xs-1"></div>'+
								'<div class="col-xs-9"><p class="mylink" onclick="clickScanned('+n+')">'+data.scannedDevices[n].deviceName+'</p></div>'+
								'<div class="col-xs-2">'+button+'</div>'+
								'</div></div>'
								);	
				}
			}

			$("#tandemBox").prop("checked",data.tandem=="true");			
			
		}			

	});	
	
}

function isPaired (i,data){
	
	var n;
	
	for (n=0;n<data.pairedDevices.length;n++){
		if (data.scannedDevices[i].deviceName == data.pairedDevices[n].deviceName) return true;
	}	
	return false;
}	

function openBluetoothModal (){

//	console.log ("openBluetoothModal ()");
	
	$('#bluetoothBusy').hide ();	
	$("#settingsModal").modal('hide');		
	$("#bluetoothModal").modal();

	if (isBTube ()) $('.b2Only').hide();
	
	listDevices ();
	
	refreshBluetooth ();
	bluetoothTimer = setInterval (refreshBluetooth,500);	
}

function closeBluetoothModal (){
	
//	console.log ("closeBluetoothModal ()");
	clearInterval (bluetoothTimer);
	$("#bluetoothModal").modal('hide');	
}

function listDevices (){

	console.log ("List Devices");

	var urlTail = 'listDevices&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}	

function scanBluetooth (){

	console.log ("scanBluetooth");

	$('#bluetoothBusy').show ();

	var urlTail = 'scanBluetooth&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	lastBluetoothStatus = undefined;	
	
}

function clickPaired (index){
	
	console.log ("clickPaired ("+index+")");
	
	var data = lastBluetoothStatus;

	if (data.outputDevice == data.pairedDevices[index].deviceName){			// connected

		var urlTail = 'disconnectBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
		$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	}
	else {

		var urlTail = 'connectBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
		$.getJSON('b2gci.fcgi',urlTail,function(data){});
		
	}	
}	

function clickForget (index){

	console.log ("clickForget ("+index+")");

	$('#bluetoothBusy').show ();

	var urlTail = 'unpairBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
	
			listDevices ();
			
	});
	
}	

function clickScanned (index){
	
	console.log ("clickScanned ("+index+")");

	$('#bluetoothBusy').show ();
	
	var urlTail = 'pairBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
			listDevices ();
		
	});

}	

function resetBluetooth2 (){

	console.log ("resetBluetooth2 ()");

	$('#generalAreYouSureModal').modal('hide');	
	
	var urlTail = 'resetBluetooth&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
			listDevices ();
		
	});

	
}	

function areYouSure (text,action){
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}	
	areYouSureAction = action;
	$('#generalAreYouSureModal').modal();
	$('#generalAreYouSureTitle').html(text);
}

function myAlert (text){
	$('#alertModal').modal();
	$('#alertModalText').html(text)	
}	

function resetBluetooth1 (){

	clearInterval (bluetoothTimer);
	$("#bluetoothModal").modal('hide');	

	areYouSure ("Delete pairings and reboot",resetBluetooth2);

}	

function tandemClick (){

	var urlTail;
	
	console.log ("tandemClick checked="+$("#tandemBox").prop("checked"));
	
	if ($("#tandemBox").prop("checked")) urlTail = 'bluetoothTandem&mode=1&time='+ new Date ().getTime();
	else urlTail = 'bluetoothTandem&mode=0&time='+ new Date ().getTime();
	$.getJSON('b2gci.fcgi',urlTail,function(data){});	
	
}	

function searchKeyHandler (event){

	console.log ("searchKeyHandler () key = "+event.keyCode);

	var children = $('#Results').children();

	if (document.activeElement.getAttribute('id')=='searchInput'){	
		if (event.keyCode == 13){
			console.log ("enabling focus on search results");
			searchResultsHaveFocus = true;
			children.attr("tabindex",0);
			children.eq(0).focus();
		}	
	}
	else {
		if ((event.keyCode == 27)||(event.keyCode == 37)){			// ESC or LEFT
			console.log ("clearing focus on search results");	
			searchResultsHaveFocus = false;
			$('#searchInput').focus();
			children.attr("tabindex",-1);
			
		}
		else if (event.keyCode == 13){

			var row = children.index(document.activeElement);
			playTestFunction (row);
			$('#searchInput').focus();
			children.attr("tabindex",-1);
		}	
		else if (event.keyCode == 38){

			var row = children.index(document.activeElement);
			if (row) row--;
			children.eq(row).focus();
		}
		else if (event.keyCode == 40){

			var row = children.index(document.activeElement);
			if (row < (children.length - 1)) row++;
			children.eq(row).focus();
		}
		
	}		
	
}	

function openJBV (){

		var win = window.open ("jbv.html",'_blank');
		wind.focus();
}	


function refreshHistoryList (){
	var tb = $('#youtubeHistoryTable');
	tb.children().remove();
	var l = youtubeHistory.length;
	for (var i=0;i<l;i++){ 

		var row = makeYoutubeItem(youtubeHistory[i][0],youtubeHistory[i][1],"playYoutubeHistory",i,true);
		tb.append (row);
		
		if (isBTube()){
			console.log ("refreshHistoryList () result["+i+"]="+row);
			console.dir (row.children().first());
			getLocalYoutubeThumbnail (row.children().first(),getVideoID (youtubeHistory[i][1]));

		}
		
	}
	var box = $('#YoutubeHistoryBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');		
}	


// WARNING temporary - use ytdl

function getVideoID (url) {

var idRegex = /[a-zA-Z0-9-_]{11}/;
	
  var r;
  if (r = idRegex.exec(url)) {
    return r;
  }
  return null;
};


function deleteYoutubeHistoryItem (){

	console.log ("deleteYoutubeHistoryItem ()");
	youtubeHistory.splice (youtubeHistoryDeletionIndex,1);
	uploadHistory ();
	refreshHistoryList ();
	$('#generalAreYouSureModal').modal('hide');				
}	


function youtubeItemMenu (index){

	youtubeHistoryDeletionIndex = index;
	areYouSure ("Delete "+youtubeHistory[index][0],deleteYoutubeHistoryItem);

}

function makeYoutubeItem (text,url,onclick,index,showMenu){

		var img = "";
		if (!showMenu || !isBTube ()){
			var id = getVideoID (url);
			if (id) img = '<img width="100%" src = "https://i.ytimg.com/vi/'+id+'/default.jpg">';
		}	
		if (showMenu){
			var trash = '<td class="mylink col-sm-1" onclick="youtubeItemMenu('+index+')"><span id="randomIcon" class="glyphicon glyphicon-trash" ></span></td>';
			var tdClass = '<td class="col-sm-8" onclick="'+onclick+'('+index+')">';
		}
		else {
			var trash = '';
			var tdClass = '<td class="col-sm-9" onclick="'+onclick+'('+index+')">';			
		}		
		
//		console.log ("img = "+img);
		
		return 	$('<tr class="mylink youtube"><td class="col-sm-3" onclick="'+onclick+'('+index+')">'+img+
					'</td>'+
					tdClass+text+'</td>'+trash+'</tr>');
	
}	

function refreshSearchResults (){
	var tb = $('#youtubeSearchResultsTable');
	tb.children().remove();
	var l = youtubeSearchResults.length;
	for (var i=0;i<l;i++){ 

		tb.append (makeYoutubeItem(youtubeSearchResults[i][0],youtubeSearchResults[i][1],"playYoutubeSearchResult",i,false));
			
	}
	var box = $('#YoutubeSearchResultsBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');	
	
	
}	


function proxyFetch (url,callback){
	
	
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?proxyFetch&url="+url);
	xhr.responseType = "blob";
	xhr.onload = function (){	
		if (this.response.size){
//			console.log ("proxyFetch Reply size = "+this.response.size);
			return callback (0,this.response);
		}
		else return (new Error ("proxyFetch no reply"));
	};	
	xhr.send ();	
}

function proxyFetchText (url,callback){
	
	
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?proxyFetch&url="+url);
	xhr.responseType = "blob";
	xhr.onload = function (){	
		if (this.response.size){
			console.log ("proxyFetchText Reply size = "+this.response.size);
			
			var reader = new FileReader ();
			reader.onload = function () {
//				console.log ("Head of blob = "+reader.result.slice(0,100));
				callback (0,reader.result);
			};
			reader.readAsText (this.response);				

		}
		else return (new Error ("proxyFetchText no reply"));
	};	
	xhr.send ();	
}



function startFfmpeg (url,title,id){
	

	var urlTail = 'ffmpeg&id='+id+'&title='+title+'&url='+url;
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
}

function startOmxplayer (url,title,id){
	

	var urlTail = 'omxplayer&id='+id+'&title='+title+'&url='+url;
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
}


function allIndexOf (str, toSearch){
	var indices = [];
	for (var pos = str.indexOf (toSearch); pos !== -1; pos = str.indexOf (toSearch, pos+1)){
		indices.push(pos);
	}
	return indices;
}		

function scrapeYoutube (q){
	
	console.log ("scrapeYoutube () val=<"+q+">");
	
	var url = "https://www.youtube.com/results?search_query="+q.replace(" ","+");
	
	console.log ("URL = "+url);
	
	$("#youtubeSearching").show ();	
	

	proxyFetchText (url,function (err,blob){
		if (err) console.log ("Scrape failed");
		else {
			
			var n;
			
//			console.log ("Scrape reply "+blob);
	
//			var ixs = allIndexOf (blob,"oxy");
//			console.log ("#indexes of roxy = "+ixs.length);
//			for (var n=0;(n < ixs.length);n++){
//				console.log (n+" "+ixs[n]+" "+blob.slice(ixs[n]-40,ixs[n]+40)) ;
//			}
//			n = 35;
//			console.log (n+" "+ixs[n]+" "+blob.slice(ixs[n]-2000,ixs[n]+1000)) ;
				 
			
			var yt = $("<div>").html (blob);

//			console.log ("jquery object =>");
//			console.dir (yt);

//			console.dir (yt[0].children);
			
			var el = yt[0].getElementsByClassName ("yt-lockup-title");
//			console.dir (el);
			
			youtubeSearchResults = [];
			
			for (n=0;n<el.length;n++){
				console.log (n+" "+el[n].innerText);
//				console.log (el[n].innerHTML);
				console.log (el[n].firstChild.getAttribute("href"));
				
				var item = [el[n].innerText,el[n].firstChild.getAttribute("href")];

// Youtube channels begin "/user"
				
				if ((item[1].indexOf("doubleclick") == -1)&&(item[1].indexOf("/user") != 0)) youtubeSearchResults.push (item);
				
			}	
			refreshSearchResults ();
			$("#youtubeSearching").hide ();
							

		}
	});		
	
}

function youtubeGo (){
	
	var q = $('#bTubeSearchValue').val();
	$('#bTubeSearchValue').val("");
	
	console.log ("youtubeGo () val=<"+q+">");
	
	var id = getVideoID (q);
	if (id) {
		console.log ("Looks like a Youtube ID - play it");
		return startYoutube (id,function () {
			scrapeYoutube (q)
		});
	}
	else scrapeYoutube (q);
}



/*

https://www.googleapis.com/youtube/v3/search?order=relevance&type=video&maxResults=50&videoCategoryId=10&part=id%2Csnippet&safeSearch=none&q=roxy&key=AIzaSyCIM4EzNqi1in22f4Z3Ru3iYvLaY8tc3bo

*/


var youtubeResult;


function searchYoutube (){
	
	var q = $('#bTubeSearchValue').val();
	
	console.log ("searchYoutube () val=<"+q+">");
	
	var head = "https://www.googleapis.com/youtube/v3/search";
	var tail = "order=relevance&type=video&maxResults=10&videoCategoryId=10&part=id%2Csnippet&safeSearch=none&q="+q+
					"&key=AIzaSyCIM4EzNqi1in22f4Z3Ru3iYvLaY8tc3bo";
	
	$.getJSON(head,tail,function(data){
		
		console.log ("searchYoutube () got reply ");
		console.dir (data);
		
		var items = data.items;
		youtubeResult = data;
		
		var tb = $('#youtubeTable');
		tb.children().remove();
		var l = items.length;
		for (var i=0;i<l;i++){ 
			tb.append('<tr><td><a href="#" onclick="playYoutube('+i+')">'
				+items[i].snippet.title+'</a></td></tr>');
		}
				
	});		
	
}	

function myFilter (item){
	
	console.log ("myFilter");
	console.dir (item);
//	return (item.container=="mp4") && (item.quality=="medium");
	return (item.container=="mp4");
}	

// bTube search


function playYoutube (i){
	
	console.log ("playYoutube ()");
	console.log (youtubeResult.items[i].snippet.title);
	console.log (youtubeResult.items[i].id.videoId);
	
	var options;

	if ($("#videoCheckbox").prop("checked")) options = {filter: myFilter};
//	if ($("#videoCheckbox").prop("checked")) options = {quality: 'lowest'};
	else options = {filter: 'audioonly'};
	
	ytdl ("http://youtube.com/watch?v="+youtubeResult.items[i].id.videoId,options,function (err,url,info){
//	ytdl ("http://youtube.com/watch?v="+youtubeResult.items[i].id.videoId,{filter: 'audioonly'},function (err,url){
//	ytdl ("http://youtube.com/watch?v=kOnde5c7OG8",{filter: 'audioonly'},function (err,url){		
		
		if (err) console.log ("ytdl-core failed "+err);
		else {
			console.log ("ytdl-core returned "+url);
			console.log ("Info=");
			console.dir (info); 
			if ($("#videoCheckbox").prop("checked")) startOmxplayer (url)
			else startFfmpeg (url,info.title,info.video_id);
		}	
	});	
	
	
}

function isBTube (){
	
	return nowPlaying.btube;
	
}	


// Better if I could show status ..locating video, updating history
// I wonder if I can find the ffmpeg url from getinfo - supect I'm doing things twice

function startYoutube (yturl,callback){
	
	console.log ("startYoutube ("+yturl+")");

	$("#youtubeStarting").show ();		

	var options;
	
	
	if (isBTube()) options = {filter: myFilter};
	else options = {filter: 'audioonly'};

	ytdl (yturl,options,function (err,url,info){

		
		if (err) {
			$('#youtubeStarting').hide ();
			console.log ("ytdl-core failed "+err);
			if (callback) callback ();
			else alert ("That didn't work try again");
		}	
		else {
			console.log ("ytdl-core returned "+url); 
			
			console.log ("nowPlaying.btube = "+nowPlaying.btube);
			
			if (nowPlaying.btube) startOmxplayer (url,info.title,info.video_id);			
			else startFfmpeg (url,info.title,info.video_id);

			$('#youtubeStarting').hide ();

			console.log ("Title ",info.title); 
			console.dir (info);
					
			addToYoutubeHistory (info.title,yturl);
			uploadHistory ();
			refreshHistoryList ();
		
		}	
	});		
	
}	

function youtubeStartClick (){
	
	var q = $('#youtubeSearchValue').val();
	
	console.log ("startYoutube () val=<"+q+">");

	startYoutube (q); 
}

/*
function cloudLog (id){

	
	var url = "https://flo3ofzhcc.execute-api.eu-west-2.amazonaws.com/dev/log?youtube="+id;
//	var urlTail = "?youtube="id;
	console.log ("cloudLog url="+url);
	
	$.get (url,function (data) {
		console.log ("cloudLog got reply"+data);
	}).fail (function (){
		console.log ("cloudLog failed");
	});
}
*/

function cloudLog (id){

	var url = "https://flo3ofzhcc.execute-api.eu-west-2.amazonaws.com/dev/log?youtube="+getVideoID (id);
	console.log ("cloudLog url="+url);

	proxyFetch (url,function (err,blob){
		if (err) console.log ("cloudLog error="+err);
		else {
			var reader = new FileReader ();
			reader.onload = function () {
				console.log ("cloudLog reply=" + reader.result);
			};
			reader.readAsText (blob);				
			
		}	
	});		
}


function playYoutubeHistory(index){

	var id = getVideoID(youtubeHistory[index][1]);

//	console.log ("playYoutubeHistory () id = "+id);
	cloudLog (id);

	var urlTail = 'findAndPlay&id='+id+'&time='+new Date ().getTime();		// try cache
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		if (data) console.log ("Cache hit");
		else startYoutube (youtubeHistory[index][1]);		
	});	
}	

function playYoutubeSearchResult(index){

	cloudLog (youtubeSearchResults[index][1]);
	startYoutube (youtubeSearchResults[index][1]);	


}	

function addToYoutubeHistory (title,url){

	var item = [title,url];
	var i;
	
	for (i=0;i<youtubeHistory.length;i++){
		if (youtubeHistory[i][0]===title)
			youtubeHistory.splice (i,1);
	}		
	
	youtubeHistory.unshift (item);
	while (youtubeHistory.length > 20) youtubeHistory.pop ();
}

function uploadHistory (){
	
	var formData = new FormData ();

	formData.append ("history",JSON.stringify(youtubeHistory));

	$.ajax ({
		url: 'b2cgi.fcgi?uploadYoutubeHistory',
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {
			console.log ("uploadHistory OK");
		},
		error: function (jqXHR, textStatus, errorThrown){
			console.log ("uploadHistory Error "+errorThrown);	
		}	
	});	
}

function getHistory (callback){
	
	var urlTail = 'getYoutubeHistory&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		youtubeHistory = data;
		if (callback) callback ();
	});	
};	


function openToneControl (){
	console.log ("openToneControl () bass="+nowPlaying.bass+" treble="+nowPlaying.treble);
	
	refreshEQ ();
	$('#toneModal').modal();			


	$("#bassSlider").val(nowPlaying.bass);
	$("#trebleSlider").val(nowPlaying.treble);

}	

function USBLink (index){
	
	var f = USBResults[index];
	console.log ("USBLink "+f.name);
	if (f.dir){
		USBPaths[USBIndex] += "/"+f.name;
		refreshUSB ();
	}
	else {
		
		var path = USBPaths[USBIndex] + '/' + f.name;
		var urlTail = 'getTagsForPath&path='+path;

		$.getJSON('b2gci.fcgi',urlTail,function(data){
			console.log ("getTagsForPath got reply");
			console.dir (data);

		});
		
	}	
}

function USBImport (index){
	
	var f = USBResults[index];
	var path = USBPaths[USBIndex] + '/' + f.name;

	console.log ("USBImport () path="+path);

	var urlTail = 'USBImport&path='+path;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		console.log ("USBImport got reply");
		console.dir (data);
		if (!data) myAlert ("Busy - please wait");
	});
	
}


function usbA (){
	
	USBIndex = 0;
	refreshUSB ();
}	

function usbC (){
	
	USBIndex = 1;
	refreshUSB ();
}

function usbUp (){

	var i = USBPaths[USBIndex].lastIndexOf ("/");
	if (i>0){
		USBPaths[USBIndex] = USBPaths[USBIndex].substring (0,i);
		refreshUSB ();
	}
}	


function refreshUSB (){


	$("#USBPath").html(USBPaths[USBIndex]);
	
	var urlTail = 'listDir&path='+USBPaths[USBIndex];
//	urlTail += '&time='+new Date ().getTime();			// IE	

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		console.log ("listDir got reply");
		console.dir (data);

		USBResults = data;
		
		var results = $('#USBItems');
		results.children().remove();
		var l = data.length;

		if (l){

			for (var i=0;i<l;i++){
//				menu = '<td><span class="glyphicon glyphicon-option-horizontal"</span></td>';
				menu = '<td onclick="USBImport('+i+')" data-toggle="tooltip" title="Import" ><span class="glyphicon glyphicon-download-alt"</span></td>';
				icon = data[i].dir?"glyphicon-folder-open":"glyphicon-file";			
				results.append('<tr class="mylink"><td><span class="glyphicon '+icon+'" onclick="USBLink('+i+')"></span></td><td class="col-sm-10" onclick="USBLink('+i+')">'+data[i].name+"</td>"+menu+"</tr>");
			}
		}
		else 
			results.append ('<tr><td>Empty</td></tr>');	
			
		var box = $('#USBItemsBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');			
			
			
	});
			
}	

function openUSBPanel (){
	console.log ("openUSBPanel ()");
	$('#usbModal').modal();
	
	refreshUSB ();
}	

function openPodcastPanel (){
	console.log ("openPodcastPanel ()");
	$('#podcastModal').modal();
}

function podcastPlayFunction(){
	
	console.log ("podcastPlayFunction url="+$('#podcastValue').val());
	
	var urlTail = 'podcast&url='+$('#podcastValue').val();
	$.getJSON('b2gci.fcgi',urlTail,function(data){});	

	$('#podcastModal').modal("hide");
		
}	


function toneChange (){
	console.log ("toneChange ()");
	console.log ("Treble = "+$("#trebleSlider").val());		

	var bass = $("#bassSlider").val();
	var treble = $("#trebleSlider").val();

	var urlTail = 'setTone&bass='+bass+'&treble='+treble+'&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){});	

}	

function playlistFilterToggle (){

	console.log ("playlistFilterToggle ()");
	console.log ("state = "+!$("#playlistCheckbox").hasClass ("myGrey"));
	
//	searchFunction ();
	
}


function setAlbumArt (index){

	$.getJSON('b2gci.fcgi',"getArtFromURL&id="+scrapeArtId+"&url="+scrapeArtUrls[index]+"&time="+new Date ().getTime(),function(data){
		$('#albumArtModal').modal("hide");
		listalbumAndArtistFunction (scrapeArtId);
		if (!desktop()) pickPanel (7);		
	});		

	
}	


var scrapeArtUrls = [];
var scrapeArtId;

function artLoaded (index){
	
	var i = $("#albumArtResultsTable img").eq(index)[0];
	var size = i.naturalWidth+" x "+i.naturalHeight;
	$("#artSize"+index).text(size);
	
}	

function bottomLine (){
	
	$("#albumArtBottomLine").show();
	if (scrapeArtUrls.length) $("#albumArtBottomLine").text("Click on image to use as cover art for this album");
	else $("#albumArtBottomLine").text("Nothing found");	
}

function scrapeArtPartTwo (index,results){
	
	var url = "https://musicbrainz.org"+results[index].href;
	
	console.log ("scrapeArtPartTwo () "+url);
	$("#albumArtBottomLine").text("Searching");	
	
	proxyFetchText (url,function (err,blob){
		if (err) {
			$('#artSearching').hide();	
			console.log ("Scrape failed");
			bottomLine ();
		}	
		else {
			
			var yt = $("<div>").html (blob);

//			console.dir (yt);

//			console.log ("find cover-art");
//			console.dir (yt.find(".cover-art"));

//			console.log ("find cover-art a .cover-art-image");
//			console.dir (yt.find(".cover-art a .cover-art-image"));

			var image = yt.find(".cover-art a .cover-art-image").eq(0);

			console.log ("image = "+image.html());

			var href = image.attr('data-large-thumbnail') || image.attr('data-small-thumbnail');
			
			if (!href){
				
				image = yt.find(".cover-art img").eq(0);
				href = image.attr('src');
				
			}

			var tb = $('#albumArtResultsTable');
			
			
			if (href) {
				var i = scrapeArtUrls.length;
				tb.append('<tr ><td class="mylink" onclick="setAlbumArt('+i+')"><img onload="artLoaded('+i+')" width="75px" src="'+href+'"></td><td id="artSize'+i+'"></td></tr>');

//				scrapeArtUrls.push(href.replace("//",""));
				if (href.startsWith("//")) href = "http:"+href;
				scrapeArtUrls.push(href);				
				
			}
			index++;
			if ((index < 5) && (index < results.length)) {
				scrapeArtPartTwo (index,results);
			}
			else {
				$('#artSearching').hide();
				bottomLine ();				
				
			}

		}
	});		
	
	
	
}	


function scrapeArt (q){
	
	console.log ("scrapeArt () val=<"+q+">");
	
	q = q.replace (/  /g," ");
	q = q.replace (/ /g,"+");
	
//	var url = "https://musicbrainz.org/search?query=emeli+sande&type=release&method=indexed";
//	var url = "https://musicbrainz.org/search?query=faithless+sunday+8pm&type=release&method=indexed";
	var url = "https://musicbrainz.org/search?query="+q+"&type=release&method=indexed";
//	var url = "https://www.amazon.co.uk/s/ref=nb_sb_noss_1?url=search-alias%3Dpopular&field-keywords=emeli+sande";
		
	console.log ("URL = "+url);

	
//	$("#youtubeSearching").show ();	
	
	var mbr = [];

	proxyFetchText (url,function (err,blob){
		if (err) console.log ("Scrape failed");
		else {
			
			var n;
			var yt = $("<div>").html (blob);
			var r = yt.find(".tbl tr");
			
// results are in a table - we want first two items - score and link

			for (n=0;n<r.length;n++){
				
				var release = {};
				var $row = $(r[n]);
				release.score = $row.children()[0].innerHTML;

				var $a = $row.find('a');				
				release.href = $a.eq(0).attr('href');						// first link in row
				release.name = $a.eq(0).text();								// name
/*				
				if ((release.score > 80) && release.href) {
					console.log (n+" "+release.score+" "+release.name+" "+release.href);
					mbr.push(release);
				}	
*/
				if ((mbr.length <= 5) && release.href) {
					console.log (n+" "+release.score+" "+release.name+" "+release.href);
					mbr.push(release);
				}


			}	
			console.log ("Total "+mbr.length);

			scrapeArtPartTwo (0,mbr);						

		}
	});		
	
}

function scrapeArt2 (q){
	
	console.log ("scrapeArt () val=<"+q+">");
	
	q = q.replace (/  /g," ");
	q = q.replace (/ /g,"+");
	
	var url = "https://www.amazon.co.uk/s/ref=nb_sb_noss_1?url=search-alias%3Dpopular&field-keywords="+q;
		
	console.log ("URL = "+url);

	
//	$("#youtubeSearching").show ();	
	
	var mbr = [];

	proxyFetchText (url,function (err,blob){
		if (err) console.log ("Scrape failed");
		else {
			
			var n;
			var yt = $("<div>").html (blob);
			var r = yt.find(".s-item-container img");

			var tb = $('#albumArtResultsTable');

			console.log ("Amazon scrape s-item-container count "+r.length);
			
			for (n=0;(n<r.length)&&(scrapeArtUrls.length<5);n++){
				
				var href = r.eq(n).attr("src");
				console.log ("Image url "+href);
				
//				href = href.replace ("https","http");
				
//				var srcset = r.eq(n).attr("srcset");
//				console.log ("srcset[0] "+srcset.split(" ")[0]);
				
				var i = scrapeArtUrls.length;
				tb.append('<tr ><td class="mylink" onclick="setAlbumArt('+i+')"><img onload="artLoaded('+i+')" width="75px" src="'+href+'"></td><td id="artSize'+i+'"></td></tr>');
				if (href.startsWith("//")) href = "http:"+href;
				scrapeArtUrls.push(href);	
				
			}
			$('#artSearching').hide();
			bottomLine ();				

		}
	});		
	
}

function searchItemArt (){
	
	console.log ("searchItemArt");

	$('#searchItemModal').modal("hide");
	
	var tb = $('#albumArtResultsTable');
	tb.children().remove();
	
	var id = selectedSearchItem.id;

	var album = '';
	var name = '';
	
	if (isAlbum(id)){
		album = selectedSearchItem.album;
		var urlTail = 'albumDetails&id='+id+'&time='+new Date ().getTime();			// IE
		$.getJSON('b2gci.fcgi',urlTail,function(data){

			$('#albumArtModal').modal();
			$("#albumArtBottomLine").hide();			
			$('#artSearching').show();
			
			console.log ("artist "+data.artist);
			console.log ("album = "+album);

			$("#albumArtArtist").text(data.artist);
			$("#albumArtAlbum").text(album);

			scrapeArtUrls = [];
			scrapeArtId = id;
	
			scrapeArt (data.artist+" "+album);

		
		});	
	}
	else alert ("Albums Only");
		
	
}		

function searchItemArt2 (){
	
	console.log ("searchItemArt2");

	$('#searchItemModal').modal("hide");
	
	var tb = $('#albumArtResultsTable');
	tb.children().remove();
	
	var id = selectedSearchItem.id;

	var album = '';
	var name = '';
	
	if (isAlbum(id)){
		album = selectedSearchItem.album;
		var urlTail = 'albumDetails&id='+id+'&time='+new Date ().getTime();			// IE
		$.getJSON('b2gci.fcgi',urlTail,function(data){

			$('#albumArtModal').modal();
			$("#albumArtBottomLine").hide();				
			$('#artSearching').show();
			
			console.log ("artist "+data.artist);
			console.log ("album = "+album);

			$("#albumArtArtist").text(data.artist);
			$("#albumArtAlbum").text(album);

			scrapeArtUrls = [];
			scrapeArtId = id;
	
			scrapeArt2 (data.artist+" "+album);

		
		});	
	}
	else alert ("Albums Only");
		
	
}

function blockProgressSliderUpdates (){

	clearTimeout (bpsuTimer);
	enableProgressSliderUpdates = false;
	bpsuTimer = setTimeout (function () {enableProgressSliderUpdates = true;},2500);
	
}	

function progressChange (){
//	console.log ("progressChange ()");
//	console.log ("Progress = "+$("#progressSlider").val());		

	var pos = $("#progressSlider").val();

	var urlTail = 'seek&pos='+pos+'&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	blockProgressSliderUpdates ();

//	displayTimeLeft (nowPlaying.duration-nowPlaying.duration*pos/1000,nowPlaying.duration);	
	displayTimeLeft2 (nowPlaying.duration*pos/1000,nowPlaying.duration);	
}	

function progressInput (){
	console.log ("progressInput ()");
//	console.log ("Progress = "+$("#progressSlider").val());		

	var pos = $("#progressSlider").val();

	console.log ("calculated time "+nowPlaying.duration*pos/1000);
	
	blockProgressSliderUpdates ();
	
//	displayTimeLeft (nowPlaying.duration-nowPlaying.duration*pos/1000,nowPlaying.duration);	
	displayTimeLeft2 (nowPlaying.duration*pos/1000,nowPlaying.duration);		

}	

function displayTimeLeft (timeLeft,duration){
	
	
//	console.log ("displayTimeLeft () timeLeft="+timeLeft+" duration=",duration);
	
	var p = duration - timeLeft;
	var pm = Math.floor(p / 60);
	var ps = Math.round(p % 60);
	var pss = "0"+ps;

	var m = Math.floor(timeLeft / 60);
	var s = Math.round(timeLeft % 60);
	var ss = "0"+s;
	$('#seekTimeLeft').html ("Time: "+pm+":"+pss.substr(-2)+'<span class="pull-right">'+m+":"+ss.substr(-2)+'</span>');

}

function displayTimeLeft2 (timeIntoTrack,duration){
	
	
//	console.log ("displayTimeLeft2 () timeIntoTrack="+timeIntoTrack+" duration=",duration);
	
	var p = timeIntoTrack;
	var pm = Math.floor(p / 60);
	var ps = Math.round(p % 60);
	var pss = "0"+ps;

	var tl = duration-timeIntoTrack;
	if (tl < 0) tl = 0;

	var m = Math.floor((tl) / 60);
	var s = Math.round((tl) % 60);
	var ss = "0"+s;
	$('#seekTimeLeft').html ("Time: "+pm+":"+pss.substr(-2)+'<span class="pull-right">'+m+":"+ss.substr(-2)+'</span>');

}


function openbTubeDebugPanel (){
	console.log ("openbTubeDebugPanel ()");
	$('#bTubeDebugModal').modal();
}

function deleteP3 (){

	console.log ("deleteP3 ()");
	
	var urlTail = 'bTubeDebugs&command=deleteP3&time='+new Date ().getTime();			// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	$('#bTubeDebugModal').modal("hide");	
}	

function quitProgram (){

	console.log ("quitProgram ()");
	
	var urlTail = 'bTubeDebugs&command=quit&time='+new Date ().getTime();			// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	$('#bTubeDebugModal').modal("hide");	
}

function reboot (){

	console.log ("reboot ()");
	
	var urlTail = 'bTubeDebugs&command=reboot&time='+new Date ().getTime();			// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	$('#bTubeDebugModal').modal("hide");	
}



function nextFolderUpload (){
	
	var name, artist, album;
	
	
	for (;folderUploadEnable && currentUpload<uploadFiles.length;currentUpload++){
		
		name = uploadFiles[currentUpload].name;
		if (okToUpload (name)){
			
			console.log ("NextFolderUpload () OKtoUpload");
			console.dir (uploadFiles[currentUpload]);
			
			var path = uploadFiles[currentUpload].webkitRelativePath;
//			console.log (path);

			var folders = path.split('/');
			if (folders.length > 2){
				album = folders [folders.length - 2];
				artist = folders [folders.length - 3];
			}
			else if (folders.length == 2){
				album = folders[0].replace(/&/g,"_");
				artist = "Unknown";
				$('#unknownWarning').show ();				
			}
			else {
				album = "Unknown";
				artist = "Unknown";
				$('#unknownWarning').show ();
			}			
//			console.log ("Artist="+artist+" Album="+album);			

			var urlTail = 'fileExists&artist='+encodeURIComponent(artist)
							+'&album='+encodeURIComponent(album)
							+'&name='+encodeURIComponent(name)+'&time='+new Date ().getTime();			// IE
							
			$.getJSON('b2gci.fcgi',urlTail,function(exists){
				if (exists) {
					
					console.log ("skipping "+name);
					
					currentUpload++;
					uploadTry = 1;
					if (folderUploadEnable && (currentUpload < uploadFiles.length)){
						bulkUploadProgress (0);
						nextFolderUpload ();
					}
					else {
						folderUploadEnable = false;
						$('#folderUploading').hide ();							
					}					
				}
				else {


//************************************************************

			var formData = new FormData ();

			formData.append (album,uploadFiles[currentUpload],name);

			$.ajax ({
				xhr: function () {
					var xhr = new window.XMLHttpRequest ();
					xhr.upload.addEventListener("progress", function (evt){
						if (evt.lengthComputable){
							bulkUploadProgress (Math.round(100*evt.loaded/evt.total));
						}	
					},false);	
					return xhr;	
				},	
				url: 'b2cgi.fcgi?upload&artist='+encodeURIComponent(artist),
				type: 'POST',
				data: formData,
				cache: false,
				dataType: 'json',
				processData: false,
				contentType: false,
				success: function (data, textStatus, jqXHR) {

					checkUpload (function (status){
						if (status) {
							currentUpload++;
							uploadTry = 1;
							if (folderUploadEnable && (currentUpload < uploadFiles.length)){
								bulkUploadProgress (0);
								nextFolderUpload ();
							}
							else  {
								$('#folderUploading').hide ();				
								searchFunction ();					// refresh		
								listalbumAndArtistFunction (selectedAlbum);
								refreshNowPlaying ();
								folderUploadEnable = false;				
							}
						}
						else uploadOver ();
					});	
				},
				error: function (jqXHR, textStatus, errorThrown){
			
					checkUpload (function (status){
						if (status) {
							if (folderUploadEnable && (uploadTry < 3)){
								uploadTry++;
								bulkUploadProgress (0);
								nextFolderUpload ();
							}
							else {
								folderUploadEnable = false;
								$('#folderUploading').hide ();														
								alert ("Upload error: "+textStatus+" file = "+uploadFiles[currentUpload].name);
							}
						}	
						else uploadOver ();
					});		
				}
					
			});

//************************************************************

					
				}
					
			}).fail (function (jqxhr, textStatus, error){
			
					console.log ("fileExists Failed - fastcgi tied up probably");
					if (folderUploadEnable && (uploadTry < 5)){
						uploadTry++;
						bulkUploadProgress (0);
						setTimeout (nextFolderUpload,3000);
					}	
					else {
						$('#folderUploading').hide ();
						folderUploadEnable = false;														
						alert ("Upload error: "+textStatus+" file = "+uploadFiles[currentUpload].name);					
					}
				
			});	

			break;
			
		}	

	}
	
	if (currentUpload >= uploadFiles.length) uploadOver ();
	
	return;
		
}

function uploadOver (){
	
	$('#folderUploading').hide ();				
	searchFunction ();		
	listalbumAndArtistFunction (selectedAlbum);
	refreshNowPlaying ();
	folderUploadEnable = false;	
	
}	


function okToUpload (name){
	
	if (name.toLowerCase().indexOf (".jpg") != -1) return true;
	if (name.toLowerCase().indexOf (".wav") != -1) return true;
	if (name.toLowerCase().indexOf (".mp3") != -1) return true;
	if (name.toLowerCase().indexOf (".flac") != -1) return true;		
	if (name.toLowerCase().indexOf (".m4a") != -1) return true;
	return false;
}	

/*
function folderUploadOnChange (e){

	console.log ("folderUploadOnChange ()");
	console.dir (e.files);
	getSpace (function (space){

		freeSpace = space;
		$('#unknownWarning').hide ();

		uploadFiles = e.files;

		var f = $('#bulkForm');
		f.children().remove();
		f.append('<input id="folderUpload" type="file" class="form-control" placeholder="Folder" webkitdirectory mozdirectory onchange="folderUploadOnChange(this)">');

		currentUpload = 0;
		folderUploadEnable = true;
		$('#folderUploading').show ();
		folderUploadCount = 0;
		bulkUploadProgress (0);			
		nextFolderUpload ();
	});
}	
*/

function folderUploadOnChange (e){

	console.log ("folderUploadOnChange ()");
	console.dir (e.files);
	checkUpload (function (result){

		$('#unknownWarning').hide ();

		uploadFiles = e.files;

		var f = $('#bulkForm');
		f.children().remove();
		f.append('<input id="folderUpload" type="file" class="form-control" placeholder="Folder" webkitdirectory mozdirectory onchange="folderUploadOnChange(this)">');

		currentUpload = 0;
		folderUploadEnable = true;
		$('#folderUploading').show ();
		folderUploadCount = 0;
		bulkUploadProgress (0);			
		nextFolderUpload ();
	});
}


function folderUploadCancel (){

	folderUploadEnable = false;
	
}

function uploadSelect (){
	
//	console.log ("uploadSelect () checked = "+$("#bulkOption").prop("checked"));
	if ($("#bulkOption").prop("checked")) {
		$("#bulkDiv").show ();
		$("#fileDiv").hide ();
	}
	else {
		$("#bulkDiv").hide ();
		$("#fileDiv").show ();
	}

}	

function truncate (s){
	
	if (s.length > 20) return s.substring (0,20)+'...';
	else return s;
}	

function bulkUploadProgress (pc){

	var n = currentUpload+1;
	var name = truncate(uploadFiles[currentUpload].name);
	
	$('#folderUploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length+" "+pc+"% "+name);
	
}

function makeEQSlider (band,level,text){
	
	return ('<input type="range" min="0" max="100" value="'+level+'" class="eqslider" id="eq'+band+'" name="eq'+band+'">'+
				'<label for="eq'+band+'">'+text+'</label>');
}	

var freqs = ["31Hz","62Hz","125Hz","250Hz","500Hz","1kHz","2kHz","4kHz","8kHz","16kHz"];

function refreshEQ (){

	console.log ("refreshEQ ");
	
	var urlTail = 'getEQ';
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		console.log ("refreshEQ");
		console.dir (data);
		
		var s = $('#sliders');
		s.children().remove();
		var n;
		for (n=0;n<data.length;n++){
			s.append (makeEQSlider (n,data[n],freqs[n]));		
		}	
		
	 $(".eqslider").on ("input", eqChange);
	 $(".eqslider").on ("change", eqChange);		
		
	});	
	
}

function eqChange (){
	

	var band = this.name.slice(2);
	var level = this.value;
	
	console.log ("eqChange () band "+band+" value="+level);
//	console.dir (this);	
	var urlTail = 'setEQ&band='+band+'&level='+level;
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
	});	

	
}	

function equaliserFlat (){
	
	console.log ("equaliserFlat ()");
	for (n=0;n<10;n++){
		$("#eq"+n).prop("value",50);
		var urlTail = 'setEQ&band='+n+'&level=50';
		$.getJSON('b2gci.fcgi',urlTail,function(data){});			
	}
}	



			
</script>


	

</body>
</html>
