<!DOCTYPE html>
<!--/*! home | index.html v23.02.01 | (c) 2019 | b2.io */-->
<html lang="en">
<head>
  <title>Brennan B2</title>
  <link rel="shortcut icon" type="image/png" href="b2appicon.png">
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"> -->
  <link rel="stylesheet" type="text/css" href="css/bootstrap-3.3.5.min.css">
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
  <script src="js/jquery-1.11.3.min.js"></script>
  <!--  
  <script src="http://code.jquery.com/ui/1.8.21/jquery-ui.min.js"></script> 
  <script src="js/jquery.ui.touch-punch.min.js"></script> 
  -->  
  <!-- <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script> -->
  <script src="js/bootstrap-3.3.5.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/perfect-scrollbar.min.css">  
  <script src="js/perfect-scrollbar.jquery.js"></script>
  <!-- smoothie charting removed v23.02.01 -->
  <!-- <script src="js/smoothie.js"></script> -->
  <script src="bundle.js"></script>
 
  <link rel="apple-touch-icon" sizes="180x180" href="b2appicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  
 <script>
	 
//var panels = [];	 
var selectedPanelForMobile = 0;
var selectedSubPanel = 0;
var selectedSearchSubPanel = 0;
var selectedSearchItem;
var targetPlaylist = 0;
var lastPanels = [];
var debugTimer;
var bluetoothTimer;
var uploadEnabled;
var searchResultsHaveFocus;
var lastGuestPlaylist;
var youtubeHistory = [];
var youtubeHistoryDeletionIndex;
var youtubeSearchResults = [];
var vTunerSearchResults = [];
var vTunerItemResults = [];
var selectedPlaylistItem;
	 
$(function() {

	nowPlaying = {};
	
	setInterval (statusFunction,500);

	$('.iconToggle').on('click',function(){
		icon = $(this).find("span");
		icon.toggleClass("myGrey");
//		console.log (icon.hasClass("myGrey"));
		searchFunction ();
	});
	
	lastRandom = true;
	$('#randomIcon').toggleClass("myGrey",false);
	lastSorted = true;
	$('#alphaIcon').toggleClass("myGrey",false);
	
	$('.transportButton').on('click',function(event){
		$(this).blur();
		$.get('b2cgi.fcgi',$(this).attr('value')+"&"+new Date ().getTime(),function(data){
			// ignore response to ajax get
		});
	});	

	$('#SearchContainer').perfectScrollbar ();
	$('#playlistContainer').perfectScrollbar ();	
	$('#AlbumTracksBox').perfectScrollbar ();
	$('#ArtistAlbumsBox').perfectScrollbar ({minScrollbarLength: 20});
	$('#presetsBox').perfectScrollbar ();

	
	$('#SearchContainer').on('ps-y-reach-end',searchMore);	
	
//	panels[0] = $('#nowPlayingPanel');
//	panels[1] = $('#panel1');
//	panels[2] = $('#panel2');
//	panels[3] = $('#ArtistAlbumsBox');
//	panels[4] = $('#AlbumTracksBox');
//	selectPanel (0);


	listPlaylistsFunction ();			// populate the list of playlists
										// will also select the first and display

	listalbumAndArtistFunction (1000000);	
//	listArtistFunction (3000000);	
	listPresetsFunction ();

	 $("#slider-1").on ("input", function() {
		$( "#volume" ).text( this.value );
		var t = "vol"+this.value+"&"+new Date ().getTime();
		$.get('b2cgi.fcgi',t,function(data){			// send volxx to fcgi
		});
	});
	
	 $("#slider-1").on ("change", function() {			// for IE
		$( "#volume" ).text( this.value );
		var t = "vol"+this.value+"&"+new Date ().getTime();
		$.get('b2cgi.fcgi',t,function(data){			// send volxx to fcgi
		});
	});

	$("#slider-1").on ("mouseenter", function() {		// to stop status updates causing jitter
		 mouseOverSlider = true;
	}).on ("mouseleave", function() {
		 mouseOverSlider = false;
	});

	 $("#trebleSlider").on ("input", toneChange);
	 $("#trebleSlider").on ("change", toneChange);
	 $("#bassSlider").on ("input", toneChange);
	 $("#bassSlider").on ("change", toneChange);

	/* remove play music chart v23.02.01 */
	// smoothie = new SmoothieChart({maxValue:100,minValue:0});
	// var canvas = document.getElementById("mycanvas");
	// canvas.width = $('#canvasBox').width();
	// smoothie.streamTo (canvas,500);
	// vuLine1 = new TimeSeries();
	// smoothie.addTimeSeries(vuLine1);

	$('#CDDBPanel').hide();
	$('#uploading').hide ();
	
	$('#vTunerBox').perfectScrollbar ();	
	$('#vTunerSearchBox').perfectScrollbar ();	
	$('#YoutubeSearchResultsBox').perfectScrollbar ();	
	$('#YoutubeHistoryBox').perfectScrollbar ();


/*	
//	$('a[href="#VTunerPanel"]').on('shown.bs.tab',startVtuner);
	$('a[href="#VTunerPanel"]').on('shown.bs.tab',function (e) {
//	$('a[data-toggle="tab"]').on('shown.bs.tab',function (e) {
		console.log ("vTuner Selected");
		vTunerInit ();
	});	
*/
	
	lastWidth = window.innerWidth;
	
	adjustHeights ();
	selectPlaylistSubPanel (0);
	searchFunction ();					// populate list of matches
		
	selectedSource = 0;
	selectedDest = 0;
	selectedMode = 0;	
	
	if (getCookie("uiMode")=="") setCookie ("uiMode","normal",365);
	
	$("#webMode").prop("checked",getCookie("uiMode")=="mobile");
	
	$("#webModeAuto").prop("checked",getCookie ("uiMode")=="normal");	
	$("#webModeMobile").prop("checked",getCookie ("uiMode")=="mobile");
	$("#webModeDesktop").prop("checked",getCookie ("uiMode")=="desktop");	
	
	
//	$("#selectedPanel").focus ();	
//	document.getElementById ("selectedPanel").focus ();

	$('.ps-scrollbar-y').attr('tabindex',-1);


	$('#SearchPanel').keydown (searchKeyHandler);
	searchResultsHaveFocus = false;
	
	$("#youtubeSearching").hide ();		
	$("#youtubeStarting").hide ();
	
});
</script>  
 
<style type="text/css">
  
.well {
	margin-bottom: 10px;
}
.ScrollBox {
	position: relative;
	height: 10em;
	overflow-y: hidden;
	overflow-x: hidden;
}

.SearchScrollBox {
	position: relative;
	height: 12em;
	overflow-y: hidden;
	overflow-x: hidden;
}

.vTunerScrollBox {
	position: relative;
	height: 10em;
	overflow-y: hidden;
	overflow-x: hidden;
}

.ArtistScrollBox {
	position: relative;
/*	height: 12em;	*/
	overflow-y: hidden;
	overflow-x: hidden;
}

.panelContentOld {
	margin-top: 10px;
	padding: 10px;
	border: 2px solid #3C4144;
	border-radius: 4px;
	
}

.panelContent {
	margin-top: 10px;
	padding-top: 10px;
/*	border-top: 4px solid #003366; */
	border-top: 4px solid #3C4144; 

}

.YoutubeScrollBox {
	position: relative;
	height: 24em;
	overflow-y: scroll;
	margin: 10px;
	padding: 5px;
/*	
	overflow-y: hidden;
	overflow-x: hidden;
*/	
}

#YoutubeHistoryBox {
	position: relative;
	padding: 0px;
}

#YoutubeSearchResultsBox {
	position: relative;
	padding: 0px;
}

.fit {
	height: 20px;
}	

#ArtistAlbumsBox {
	position: relative;	
}	

#AlbumTracksBox {
	position: relative;	
}	

#albumImage {

	max-height: 30px;
	margin-top: -5px;	
}	

.panel {

	margin-bottom: 0px;
}	

.panel-body {

	padding: 8px;
}

#mixText {
	margin-top: 15px;
	margin-left: 10px;
}		

#debugText {
	font-family: monospace;
	height: 600px;
	overflow-y: scroll;
	overflow-x: hidden;	
}

#settingsBody p {
	margin-bottom: 0px;
}
#settingsBody {
	margin-bottom: 10px;
}

.npInline {
	display: inline-block;

}	

@media screen and (min-width: 990px){

	.ScrollBox {
		position: relative;
		height: 20em;
		overflow-y: hidden;
		overflow-x: hidden;
	}

	.SearchScrollBox {
		position: relative;
		height: 48em;
		overflow-y: hidden;
		overflow-x: hidden;
	}

	.vTunerScrollBox {
		position: relative;
		height: 20em;
		overflow-y: hidden;
		overflow-x: hidden;
	}

	.ArtistScrollBox {
		position: relative;
/*		height: 23em;	*/
		overflow-y: hidden;
		overflow-x: hidden;
	}

}


div[class^="col"]{padding-left:5px; padding-right: 5px}

@media (max-width: 990px){

		div[class^="col"]{padding-left:0px; padding-right: 0px}
		.container-fluid{padding-left:0px; padding-right:0px}
		.panel {margin-bottom:0px;}
		.panel {border:0px}
		.panel-body {padding-top:5px; padding-bottom: 5px}
		.well {margin-bottom:0px}
		.well-sm {padding-top: 0px; padding-bottom: 5px}		
}	

.container-fluid {
	max-width: 1400px;
}	

.myGrey {
	color: #888;
}

.mylink {
	cursor: pointer;
}

/*
ul.nav-pills {
	margin-bottom: 0.6em;
}	
*/

.scrollBoxHeader {
	margin-bottom: 0.3em;
}

.topBorder {
	border-style: solid;
	border-width: 2px 0px 0px 0px;
	border-colour: white;
}

#cdbox img {
	max-width:100%;
	max-height:100%;	
}

#canvasBox {
	margin: 10px 0px 0px 0px;
}

@font-face {
	font-family: 'icomoon';
	src:url('fonts/icomoon.woff');
}

.icon-radioMast:before {
	font-family: icomoon;
	content: "\e600";
}

#volumeSlider {
	margin: 1em;
}				

.navbar-right {
	margin-right: 0px;
} 

.btn-group-right {
	margin-top: 6px;
	margin-right: 6px;
}

.nomargin {
	margin: 0px;
}	

.spaceForScrollbar {
	padding-right: 32px !important;
}	

.youtube>td {
	padding: 4px !important;
}	

.youtube>tr {
	padding-right: 10px !important;
}	

.leftjustified {
	text-align: left;
}	
		
</style> 


</head>
<body onresize="resize()">

 
<div class="container-fluid">

<!-- handset UI -->

			<div id="handsetNav" class="row">
				<div class="well well-sm">
				<div class="col-md-4">
				<div class="btn-group">
					<a tabindex="-1" class ="navbar-brand" href="#" aria-hidden="true">Brennan B2</a>
				</div>	
				<div class="btn-group pull-right btn-group-right">

					<a id="selectedPanel" tabindex="0" href="#" class="btn btn-default dropdown-toggle" 
						data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" aria-label="Main Navigation - Now Playing Selected">
							Now Playing <span class="caret"></span></a>
							
					<ul class="dropdown-menu" role="menu">
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(0)">Now Playing</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(1)">Search</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(2)">vTuner</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(3)">Playlists</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(4)">CD</a></li>												
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(5)">Upload</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(6)">Presets</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(7)">Album</a></li>
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(8)">Artist</a></li>						
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(9)">Youtube</a></li>	
						<li role="presentation" class="divider"></li>
						<li role="presentation"><a href="#" role="menuitem" onclick="pickPanel(10)">Settings</a></li>	
					</ul>
					<a tabindex="-1" href="#" role="button" class="btn btn-default" onclick="panelBackFunction()">Back</a>					
				</div>
				</div>
				</div>												
			</div>


 <div id="ColumnOne" class="col-md-4">



	<div id="nowPlayingWell" class="well well-sm" ondragover="allowDrop(event)" ondrop="dropSpeaker(event)">

	
<!--	<a class="col-sm-2 btn btn-default" href="#" title="Random On Off" onclick="randomToggle()"><span id="randomIcon" class="glyphicon glyphicon-random" ></span></a>-->			


		<ul tabindex="-1" id="t1" class="nav nav-pills nav-stacked scrollBoxHeader">
			<li id="t2"><a class="col-sm-10" id="t3"><span class="text-muted">Source </span><span id="sourceHeader">Hard Disk</span></a>
				<a id="settingsButton" tabindex="-1" class="col-sm-2 btn btn-default" href="#" title="Settings & Status" role="button" onclick="openSettingsModal()"><span class="glyphicon glyphicon-cog" ></span></a>			
			</li>	
		</ul>
		

		<div class="panelContent" id="nowPlayingPanel">

			<div class="panel panel-default" data-toggle="tooltip" title="Drag items here to Play">

<!--
				<div class="panel-body" id="nowPlayingBody">
	 
				</div>
-->

				<div class="panel-body">
					<div class="npInline col-sm-8" id="nowPlayingBody"></div>
					<div class="npInline col-sm-4" id="nowPlayingArt"><img src="noimage.jpg" width="100%"></div>
				</div>
<!--
				<div class="panel-body">
					<div class="npInline" id="nowPlayingBody"></div>
					<div class="npInline" id="nowPlayingArt"></div>
				</div>
-->
				
			</div>	
	 

 
			<div class="btn-group btn-group-justified">
				<a href="#" class="btn btn-default" data-toggle="tooltip" title="Tone Control" onclick="openToneControl ()"><span class="glyphicon glyphicon-music"></span></a>				
				<a class="btn btn-default btn-block" href="#" data-toggle="tooltip" title="Random Play On/Off" onclick="randomToggle()"><span id="randomIcon" class="glyphicon glyphicon-random" ></span></a>
				<a href="#" class="transportButton btn btn-default" title="Back button" value='back'><span class="glyphicon glyphicon-backward"></span></a>
				<a href="#" class="transportButton btn btn-default" title="Play Stop button" value='play' id="playbutton"><span class="glyphicon glyphicon-play"></span></a>
				<a href="#" class="transportButton btn btn-default" title="Next button" value='next'><span class="glyphicon glyphicon-forward"></span></a>
			</div> 
 
			<div id=canvasBox>
				<canvas id="mycanvas" width="100%" height="60"></canvas>
			</div>	  

			<div class="panel panel-default" data-toggle="tooltip" title="Drag items here to Play">
				<div id="volumeSlider">    
<!--					<input type="range" name="slider-1" id="slider-1" class="danielstern" min="0" max="64" value="32">-->
					<input type="range" title="Volume" name="slider-1" id="slider-1" class="danielstern" min="0" max="64" value="32">
				</div> 
			</div>	
						
		</div>	
 
	</div>




  <div class="well well-sm">

 <div id="playlistTabs" class="btn-group btn-group-justified">

	 <a id='playlistTab' class="btn btn-default" onclick="selectPlaylistSubPanel(0)">Playlists</a>
	 <a id='CDTab' class="btn btn-default" onclick="selectPlaylistSubPanel(1)">CD</a>
	 <a id='PresetsTab' class="btn btn-default" onclick="selectPlaylistSubPanel(2)">Presets</a>
	 <a id='UploadTab' class="btn btn-default" onclick="selectPlaylistSubPanel(3)">Upload</a>	 
 </div>


 <div class="tab-content" id="panel1">

<!-- Playlists -->


	<div id="playlistPanel" class="panelContent">

		<div class="scrollBoxHeader">
			<div id="playlistButtons" class="btn-group">
				<a tabindex="-1" class="btn btn-default dropdown-toggle" title="Select playlist" id="menu1" data-toggle="dropdown" href="#" draggable="true" ondragstart="dragPlaylist(event)">Playlist
					<span class="caret"></span></a>
<!--				<a tabindex="-1" class="btn btn-default" href="#" data-toggle="tooltip" title="Play this playlist" onclick="playPlaylist ()">Play</a>-->
				<a tabindex="-1" class="btn btn-default" href="#" data-toggle="tooltip" title="Rename this playlist" onclick="renamePlaylist ()">Rename</a>
				<a tabindex="-1" class="btn btn-default" href="#" data-toggle="tooltip" title="Create a New Playlist" onclick="createPlaylist ()">New</a>
				<a tabindex="-1" class="btn btn-default" href="#" data-toggle="tooltip" title="Add or Subtract Playlists" onclick="mixPlaylist ()">Mix</a>
<!--				<a tabindex="-1" class="btn btn-default" href="#" ondragover="allowDrop(event)" ondrop="dropBin(event)" data-toggle="tooltip" title="Drag playlist items here to remove from playlist"><span class="glyphicon glyphicon-trash" ></span></a>-->
				<a tabindex="-1" class="btn btn-default iconToggle" href="#" data-toggle="tooltip" title="Search Only Current Playlist" onclick="playlistFilterToggle()"><span class="glyphicon glyphicon-list myGrey" id='playlistCheckbox'></span></a>

				<ul class="dropdown-menu" id="playlistDropdownUl" role="menu">
					<li><a href="#">Red</a></li>
				</ul>
			</div>      
		</div>

  
 		<div class="ScrollBox" id="playlistContainer">
			<table class="table table-hover">

				<tbody id="playlistTbody">
					<tr>
						<td>Empty</td>
					</tr>
				</tbody>
			</table>  
		</div> 
		
 	</div>
 
 
 <!-- CD -->
 

	<div id="CDPanel" class="panelContent">


		<div id="cdTitleBar" class="panel panel-default">
			<div class="panel-heading">
				<div class="btn-group pull-right">
					<a href="#" class="btn btn-default" onclick="ripFunction()" data-toggle="tooltip" title="Rip CD"><span class="glyphicon glyphicon-save"></a>
					<a href="#" class="btn btn-default transportButton" value='eject'><span class="glyphicon glyphicon-eject"></a>		
					<a href="#" class="btn btn-default" onclick="getArtFunction()" data-toggle="tooltip" title="Get Album Art">Art</a>

				</div>
				<h4 id="cdstatus">status</h4>				
			</div>
		</div>

        
		<div class="scrollBoxHeader" id="CDDBPanel">
			<div class="btn-group">
				<a class="btn btn-default dropdown-toggle" id="menu2" data-toggle="dropdown" href="#">CDDB
					<span class="caret"></span></a>
				<ul class="dropdown-menu" id="CDDBDropdownUl">
					<li><a href="#">Dark Side of The Moon</a></li>
				</ul>
			</div>      
		</div>        
        
        
		<div id="cdbox">  
		</div>
 
	</div>
 
 
 <!-- Upload -->
 
 	<div id="UploadPanel" class="panelContent">
 
  	<div>
		<div>

			<div>
				<div>
					<div class="form-group">
						<input id="uploadAlbum" type="text" class="form-control" placeholder="Type album name here">
					</div>
					<div class="form-group">
						<input id="uploadArtist" type="text" class="form-control" placeholder="Type artist here">
					</div>	
					<div class="form-group">
						<input id="uploadFileSelect" type="file" class="form-control" multiple/>
					</div>
					<div id="uploading">
						<img src="ajax-loader.gif"><span id="uploadProgress">&nbsp&nbsp&nbspSending Files</span>
					</div>
				</div>
				<div>
					<button type="button" class="btn btn-default" onclick="uploadCancelFunction()">Cancel</button>		  
					<button type="button" class="btn btn-default" onclick="uploadFunction()">Send to B2</button>
				</div>
			</div>
		</div>
	</div>
  
  
  
  
  
  
 
	</div>
 
 
  <!-- Presets -->
 
 	<div id="PresetsPanel" class="panelContent">

	<div class="ScrollBox collapse in" id="presetsBox">  
		<table class="table table-hover">
			<tbody id="presets"></tbody>
		</table> 
	</div> 

	</div>

  </div>


  </div>
  
 </div>


<!-- Rename Modal -->
	<div id="myModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

    <!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
<!--        <button type="button" class="close" data-dismiss="modal">&times;</button>-->
					<h4 id="renameTitle" class="modal-title">Rename Track</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<input id="renameValue" type="text" class="form-control" value="Initial Track Name">
					</div>
					<div id="renameArtist" class="form-group">
						<label for="renameSecondValue">Artist</label>  
						<input id="renameSecondValue" type="text" class="form-control" value="Parent Artist">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
					<button type="button" class="btn btn-default" onclick="renameOKFunction()">OK</button>
				</div>
			</div>
		</div>
	</div>


<!-- Playlist Mix Modal -->
	<div id="mixModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<h4 id="mixTitle" class="modal-title">Combine Playlists</h4>
				</div>
				<div class="modal-body">

					<div class="btn-group">
						<a class="btn btn-default dropdown-toggle" id="mixMenu1" data-toggle="dropdown" href="#">Add
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="mixModeDropdownUl" role="menu">
							<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickMode(0)">Append</a></li>						
							<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickMode(1)">Subtract</a></li>						
							<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickMode(2)">Merge</a></li>
						</ul>
					</div>
					

					<div class="btn-group">
						<a class="btn btn-default dropdown-toggle" id="mixMenu2" data-toggle="dropdown" href="#">Red
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="mixSourceDropdownUl">
							<li><a href="#">Red</a></li>
							<li><a href="#">Orange</a></li>
						</ul>
					</div>

					
					<div id="mixText">to Green</div>

					<div>
					<div class="btn-group">
						<a class="btn btn-default dropdown-toggle" id="mixMenu3" data-toggle="dropdown" href="#">Red
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="mixDestDropdownUl">
							<li><a href="#">Red</a></li>
							<li><a href="#">Orange</a></li>
						</ul>
					</div>
					</div>


				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
					<button type="button" class="btn btn-default" onclick="mixOKFunction()">OK</button>
				</div>
			</div>
		</div>
	</div>
	
<!-- New Playlist Modal -->
	<div id="newPlaylistModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Create a New Playlist</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<input id="newPlaylistValue" type="text" class="form-control" placeholder="Playlist Name">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
					<button type="button" class="btn btn-default" onclick="newPlaylistOKFunction()">OK</button>
				</div>
			</div>
		</div>
	</div>	
	
<!-- Search Item Modal -->
	<div id="searchItemModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p id="searchItemTitle" class="modal-title">Search Item</p>
				</div>
				<div class="modal-body">
					<button type="button" class="btn btn-default btn-block" onclick="searchItemDeleteButton()" >Delete</button>	
					<button type="button" class="btn btn-default btn-block" onclick="searchItemAddButton()" >Add To Playlist</button>
					<button type="button" class="btn btn-default btn-block" onclick="searchItemRenameButton()" >Rename</button>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
<!--					<button type="button" class="btn btn-default">OK</button>-->
				</div>
			</div>
		</div>
	</div>	

<!-- Playlist Item Modal -->
	<div id="playlistItemModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p id="playlistItemTitle" class="modal-title">Playlist Item</p>
				</div>
				<div class="modal-body">
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemDeleteButton()" >Delete</button>	
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemStartButton()" >Move to start</button>
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemEndButton()" >Move to end</button>
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemUpButton()" >Move up</button>
					<button type="button" class="btn btn-default btn-block" onclick="playlistItemDownButton()" >Move down</button>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Finished</button>		  
<!--					<button type="button" class="btn btn-default">OK</button>-->
				</div>
			</div>
		</div>
	</div>	

<!-- vTuner Search Item Menu Modal -->
	<div id="vTunerSearchMenuModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p id="vTunerSearchMenuTitle" class="modal-title">Search Item</p>
				</div>
				<div class="modal-body" id="vTunerSearchMenuBody">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>	

<!-- vTuner Item Menu Modal -->
	<div id="vTunerItemMenuModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p id="vTunerItemMenuTitle" class="modal-title">Search Item</p>
				</div>
				<div class="modal-body" id="vTunerItemMenuBody">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>	

<!-- Tone Control Modal -->
	<div id="toneModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p class="modal-title">Tone Control</p>
				</div>
				<div class="modal-body">
					<h3>Bass</h3>
					<input type="range" title="Bass" name="bassSlider" id="bassSlider" min="-6" max="6" value="0">					
					<h3>Treble</h3>
					<input type="range" title="Treble" name="trebleSlider" id="trebleSlider" min="-6" max="6" value="0">	
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>		  
				</div>
			</div>
		</div>
	</div>	

<!-- Are You Sure Modal -->
	<div id="areYouSureModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Delete</h4></br>					
					<p id="areYouSureTitle" class="modal-title">Name</p></br>
					<h4 class="modal-title">Are You Sure?</h4>
				</div>
				<div class="modal-body">
					<button type="button" class="btn btn-default btn-block" onclick="deleteConfirmed ()">Delete</button>	
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>

<!-- General Are You Sure Modal -->
	<div id="generalAreYouSureModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p id="generalAreYouSureTitle" class="modal-title">Name</p></br>
					<h4 class="modal-title">Are You Sure?</h4>
				</div>
				<div class="modal-body">
					<button type="button" class="btn btn-default btn-block" onclick="areYouSureAction()">Delete</button>	
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>


	<div id="guestModeModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<p class="modal-title">Guest Mode!</p>
				</div>
				<div class="modal-body">
					<p>Sorry can't make changes in Guest Mode</p>					
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>		  
				</div>
			</div>
		</div>
	</div>

<!-- Alert Modal -->
	<div id="alertModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Alert</h4>
				</div>
				<div class="modal-body">
					<p id="alertModalText" class="modal-title">Text</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>		  
				</div>
			</div>
		</div>
	</div>


<!-- Add To Playlist Modal -->
	<div id="addToPlaylistModal" class="modal" role="dialog">
		<div class="modal-dialog modal-sm">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Add to Playlist</h4></br>

				</div>
				<div class="modal-body">
					<p class="text-muted">Add</p>
					<p id="addToPlaylistTitle" class="modal-title">Name</p></br>
					<p class="text-muted">To playlist</p>
					<div class="btn-group">
						<a class="btn btn-default btn-block dropdown-toggle" id="addToPlaylistMenu" data-toggle="dropdown" href="#">Red
							<span class="caret"></span></a>
						<ul class="dropdown-menu" id="addToPlaylistDropdownUl">
							<li><a href="#">Red</a></li>
							<li><a href="#">Orange</a></li>
						</ul>
					</div>


				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-default" onclick="addToPlaylistOK ()">OK</button>							  
				</div>
			</div>
		</div>
	</div>




 <div id="ColumnTwo" class="col-md-4">

 <div class="well well-sm id="middleWell">	 
	 
	<div id="searchTabs" class="btn-group btn-group-justified">

		<a id='SearchTab' class="btn btn-default" onclick="selectSearchSubPanel(0)">Search</a>
		<a id='VTunerTab' class="btn btn-default" onclick="selectSearchSubPanel(1)">vTuner</a>
		<a id='YoutubeTab' class="btn btn-default" onclick="selectSearchSubPanel(2)" data-toggle="tooltip" title="Experimental" >Youtube*</a>
 
	</div>	 	 
	 

 <div class="tab-content" id="panel2">


<!-- Search -->


	<div id="SearchPanel" class="panelContent tab-pane">	 
	
		<div id="searchButtons" class="input-group scrollBoxHeader">
			<div>
<!--				<input type="text" id="searchInput" class="form-control" size="6" placeholder="Search B2" onkeyup="searchFunction()">-->
			<input type="text" id="searchInput" class="form-control" size="6" placeholder="Search B2" onkeyup="searchFunction()">

		
				
			</div>
			<div class="input-group-btn">
<!--				<a tabindex="-1" class="btn btn-default iconToggle" href="#" data-toggle="tooltip" title="Search Only Current Playlist"><span class="glyphicon glyphicon-list myGrey" id='playlistCheckbox'></span></a>-->
				<a tabindex="-1" class="btn btn-default iconToggle" href="#" title="Artists toggle"><span class="glyphicon glyphicon-user" id='artistCheckbox'></span></a>
				<a tabindex="-1" class="btn btn-default iconToggle" href="#" title="Albums toggle"><span class="glyphicon glyphicon-cd" id='albumCheckbox'></span></a>
				<a tabindex="-1" class="btn btn-default iconToggle" href="#" title="Tracks toggle"><span class="glyphicon glyphicon-music" id='trackCheckbox'></span></a>	
				<a tabindex="-1" class="btn btn-default iconToggle" href="#" title="Radio Stations toggle"><span class="icon-radioMast" id='radioCheckbox'></span></a>   
			</div> 

		</div>




		<div class="SearchScrollBox" id="SearchContainer">  
			<table class="table table-hover">
				<tbody id="Results"></tbody>
			</table> 
		</div>  
		
	</div>
	
<!-- vTuner -->

	<div id="VTunerPanel" class="panelContent tab-pane">	

		<div class="scrollBoxHeader">
			<div id="vTunerButtons" class="btn-group">
				<a href="#" data-toggle="tooltip" title="Go Back" class="btn btn-default" onclick="vTunerGoBack ()">Back</a>
				<a href="#" data-toggle="tooltip" title="World" class="btn btn-default" onclick="vTunerInit ()">Top</a>

			</div>      
		</div>


		<div class="vTunerScrollBox" id="vTunerBox">  
			<table class="table table-hover">
				<tbody id="vTunerTable" role="list" aria-label="vTuner categories"></tbody>
			</table> 
		</div>  
		
		<div style="height:10px;"></div>

		<div class="input-group scrollBoxHeader">
			<input type="text" id="vTunerSearchInput" class="form-control" size="6" placeholder="Search vTuner" onkeydown = "if (event.keyCode == 13) vTunerSearch ()">
			<div class="input-group-btn">
				<a class="btn btn-default" onclick="vTunerSearch ()" href="#"><span class="glyphicon glyphicon-search"></span></a>
			</div>				
		</div>
		
		<div class="vTunerScrollBox" id="vTunerSearchBox">  
			<table class="table table-hover">
				<tbody id="vTunerMatches"></tbody>
			</table> 
		</div>  
	</div>
	
	
<!-- Youtube -->

	<div id="YoutubePanel" class="panelContent tab-pane">	

		<div class="input-group scrollBoxHeader" id="youtubeSearchBar">
			<div>
				<input id="bTubeSearchValue" onkeydown = "if (event.keyCode == 13) youtubeGo ()" type="text" class="form-control" placeholder="Text search or Youtube url or id">
			</div>
			<div class="input-group-btn">
					<button type="button" class="btn btn-default" onclick="youtubeGo()">
						<span class="glyphicon glyphicon-search"></span>
					</button>
			</div> 

		</div>

				<div class="panel panel-default" >
					<div class="panel-heading" id="youtubeSearchHeading">Search results <span id="youtubeSearching"> <img class="fit" src="ajax-loader.gif"></span></div>
					<div class="panel-body vTunerScrollBox" id="YoutubeSearchResultsBox">
						<table class="table table-hover">
							<tbody id="youtubeSearchResultsTable"></tbody>
						</table> 
							
					</div>				
				</div>

				<div class="panel panel-default" >
					<div class="panel-heading">History <span id="youtubeStarting"> <img class="fit" src="ajax-loader.gif"></span></div>
					<div class="panel-body  vTunerScrollBox" id="YoutubeHistoryBox">
						<table class="table table-hover" >
							<tbody id="youtubeHistoryTable"></tbody>
						</table>
					</div> 
				</div>


		
	</div>	
	
	
	
</div>		
		

 </div>
 
 
 </div>


 
 <div class="col-md-4">

	<div id="ArtistWell" class="well well-sm">	 
	  
<!-- Artist -->


		<div id="ArtistPanel">	 

			<ul class="nav nav-pills nav-stacked scrollBoxHeader" id="artistHeader">
				<li><a><span class="text-muted">Artist </span><span id="artistname">None Selected</span></a>
				</li>	
			</ul>

			<div class="panelContent ArtistScrollBox">
				<nav id="ArtistAlbumsBox">  
					<table class="table table-hover">
						<tbody id="ArtistAlbums"></tbody>
					</table>
				</nav> 
			</div> 
		</div>
	</div> 
	
	<div id="AlbumWell" class="well well-sm">	 
	  
<!-- Album -->

		<div id="AlbumPanel">	 

			<ul class="nav nav-pills nav-stacked scrollBoxHeader" id="albumHeader" onClick="clickArt()" ondragover="allowDrop(event)" ondrop="dropArt(event)" onpaste="pasteArt(event)" data-toggle="tooltip" title="Drag or Paste Artwork here
or click to open upload panel">
				<li>
					<a><span class="text-muted">Album </span><span id="albumname">None Selected</span><img id="albumImage" class="pull-right"></a>

					
<!--					<a class="col-sm-10"><span class="text-muted">Album </span><span id="albumname">None Selected</span></a>-->
					

				</li>	
			</ul>
			
			<div class="panelContent ArtistScrollBox">
				<nav id="AlbumTracksBox">  
					<table class="table table-hover">
						<tbody id="AlbumTracks"></tbody>
					</table> 
				</nav>	
			</div>
	
		</div>
	</div>	
	
</div>


<!-- Debug Modal -->
	<div id="debugModal" class="modal" role="dialog">
		<div class="modal-dialog modal-lg">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Debug</h4></br>
				</div>
				<div class="modal-body">

					<div id="debugText">

					</div>


				</div>
				<div class="modal-footer">
					
<!--
					<div class="btn-group">
						<a class="btn btn-default dropdown-toggle" title="Logging Mode" id="loggingMenu" data-toggle="dropdown" href="#">Normal <span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="#" onclick="setLogging('Normal')">Normal</a></li>
							<li><a href="#" onclick="setLogging('File')">File</a></li>
							<li><a href="#" onclick="setLogging('TV Off')">TV Off</a></li>
						</ul>
					</div>
-->					
					
<!--					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>-->
					<button type="button" class="btn btn-default" onclick="clearDebugModal()">Clear</button>
					<button type="button" class="btn btn-default" onclick="closeDebugModal()">Close</button>					
<!--					<button type="button" class="btn btn-default" onclick="refreshDebug()">Refresh</button>-->
				</div>
			</div>
		</div>
	</div>

<!-- Settings & Status Modal -->
	<div id="settingsModal" class="modal" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Settings & Status</h4></br>
				</div>
				<div class="modal-body">
					<div id="settingsBody">

					</div>

					<table class="table">
						<tbody>

<!--							<tr>
								<td>
									<a class="btn btn-default btn-block" href="#" data-toggle="tooltip" title="Random Play On/Off" onclick="randomToggle()"><span id="randomIcon" class="glyphicon glyphicon-random" ></span></a>
								</td>
								<td class="col-sm-10" >Random On/Off</td>
							</tr>
-->
							<tr>
								<td>
									<a class="btn btn-default btn-block" href="#" data-toggle="tooltip" title="Alpha Sort On/Off" onclick="alphaToggle()"><span id="alphaIcon" class="glyphicon glyphicon-sort-by-alphabet" ></span></a>
								</td>
								<td class="col-sm-10" >Alphanumeric Sorting On/Off</td>
							</tr>						

							<tr>
								<td>
									<div class="btn-group">
										<a class="btn btn-default dropdown-toggle" title="Compression Mode" id="compressionMenu" data-toggle="dropdown" href="#">FLAC <span class="caret"></span></a>
										<ul class="dropdown-menu">
											<li><a href="#" onclick="setCompression('FLAC')">FLAC</a></li>
											<li><a href="#" onclick="setCompression('MP3')">MP3</a></li>
											<li><a href="#" onclick="setCompression('None')">None</a></li>							
										</ul>
									</div>									
								</td>
								<td class="col-sm-10" >Compression Mode</td>
							</tr>

							<tr>
								<td>
									<div class="btn-group">
										<a class="btn btn-default dropdown-toggle" title="Segue Mode" id="segueMenu" data-toggle="dropdown" href="#">Off <span class="caret"></span></a>
										<ul class="dropdown-menu">
											<li><a href="#" onclick="setSegue('Off')">Off</a></li>
											<li><a href="#" onclick="setSegue('On')">On</a></li>
											<li><a href="#" onclick="setSegue('Short')">Short</a></li>							
										</ul>
									</div>									
								</td>
								<td class="col-sm-10" >Segue Mode</td>
							</tr>

							<tr>
								<td>
									<a class="btn btn-default btn-block" href="#" data-toggle="tooltip" title="Scan Disk" onclick="scanDisk()">Scan</a>
								</td>
								<td class="col-sm-10" >Scan Disk</td>
							</tr>
<!--							
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="webMode" onclick="webModeClick()"> Force mobile mode - for screen readers
										</label>
									</div>
								</td>
							</tr>
-->
							<tr>
								<td colspan="2">
									<div class="radio">
										<label><input onclick="webModeClick()" type="radio" id="webModeAuto" name="webMode" value="normal" checked>Automatic</label>
										<label><input onclick="webModeClick()" type="radio" id="webModeMobile" name="webMode" value="mobile" >Force Mobile</label>
										<label><input onclick="webModeClick()" type="radio" id="webModeDesktop" name="webMode" value="desktop" >Force Desktop</label>

									</div>
								</td>
							</tr>


							<tr>
								<td class="col-sm-3">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="guestMode" onclick="guestModeClick()"> Guest Mode
										</label>
									</div>
								</td>
								<td class="col-sm-9">
									<div class="btn-group">
										<a class="btn btn-default dropdown-toggle" id="guestMenu" data-toggle="dropdown" href="#">Red
											<span class="caret"></span></a>
										<ul class="dropdown-menu" id="guestDropdownUl">
											<li><a href="#">Red</a></li>
											<li><a href="#">Orange</a></li>
										</ul>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="tvUi" onclick="tvUiClick()"> Enable TV UI
										</label>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="hdmi" onclick="HDMIClick()"> Audio on HDMI (TV)
										</label>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="vCache" onclick="vCacheClick()"> Enable Youtube Cache
										</label>
									</div>
								</td>
							</tr>
							
							<tr>
								<td>Background</td>
								<td id="backgroundText" class="col-sm-10" ></td>
							</tr>
							
						</tbody>
					</table> 


				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
<!--					<button type="button" class="btn btn-default" onclick="refreshSettings ()">Refresh</button>-->
<!--					<button type="button" class="btn btn-default" onclick="artTest ()">Art Test</button>-->
					<button type="button" class="btn btn-default" data-toggle="tooltip" title="B2 Debug Window" onclick="openDebugModal ()"><span class="glyphicon glyphicon-wrench" ></span></button>
					<button type="button" class="btn btn-default" data-toggle="tooltip" title="Bluetooth" onclick="openBluetoothModal ()"><span>Bluetooth</span></button>
					<button type="button" class="btn btn-default" data-toggle="tooltip" title="B2 Image Viewer" onclick="openJBV ()"><span class="glyphicon glyphicon-camera" ></span></button>
<!--					<button type="button" class="btn btn-default" data-toggle="tooltip" title="Youtube" onclick="openBTube ()"><span class="glyphicon glyphicon-film" ></span></button>-->
				</div>
			</div>
		</div>
	</div>

</div>



<!-- Bluetooth Modal -->
	<div id="bluetoothModal" class="modal" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Bluetooth  <span id="bluetoothBusy"><img src="ajax-loader.gif"></span></h4></br>
				</div>
				<div class="modal-body">
					<div id="bluetoothBody">

					</div>
					<a class="btn btn-default" href="#" data-toggle="tooltip" title="Update Paired Devices" onclick="listDevices()">Refresh Paired Devices</a>
					<a class="btn btn-default" href="#" data-toggle="tooltip" title="Scan" onclick="scanBluetooth()">Scan Bluetooth</a>
					<a class="btn btn-default" href="#" data-toggle="tooltip" title="Reset" onclick="resetBluetooth1()">Reset Bluetooth</a>
					<div class="checkbox"><label>
						<input id="tandemBox" type="checkbox" onclick="tandemClick()">Bluetooth and wired speakers together
					</label></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" onclick="closeBluetoothModal ()">Close</button>
				</div>
			</div>
		</div>
	</div>


</div>





<script>
	
var playlists;
var selectedPlaylist;
var selectedAlbum;
var selectedAlbumName;
var selectedArtistName;
var playlist;
var albumTracks;
var artistAlbums;
var nowPlaying;
var renameID;
var renameOldName;
var renameOldArtist;
var lastDiscid;
var lastCDLoaded;

/* var smoothie; */
/* var vuLine1;  */

var cddb;
var selectedcddb;
var currentUpload;
var uploadTry;
var uploadArtist;
var uploadAlbum;
var uploadFiles;
var lastVolume;
var mouseOverSlider = false;
var lastWidth;
var	th = 990;
var searchOffset;
var selectedSource;
var selectedDest;
var selectedMode;
var lastRandom;
var lastSorted;
var lastBackground;
var lastCompression;
var lastSegue;
var lastLogging;
var lastTvUi;
var lastHDMI;
var lastvCache;
var lastBluetoothStatus;
var lastGuest;

function isTrack (id){
	return ((id >= 2000000)&&(id < 3000000));
}

function isAlbum (id){	
	return ((id >= 1000000)&&(id < 2000000));
}

function isArtist (id){	
	return ((id >= 3000000)&&(id < 4000000));
}

function isPlaylist (id){	
	return ((id >= 4000000)&&(id < 5000000));
}

function isRadio (id){	
	return ((id >= 5000000)&&(id < 6000000));
}

function isVideo (id){	
	return ((id >= 8000000)&&(id < 9000000));
}

function isPlaylistIndex (id){
	return (id < 1000000);
}

function playlistToID (index){
	return 4000000+index;
}	

function trackIcon () {return '<span class="glyphicon glyphicon-music"></span>'};
function artistIcon () {return '<span class="glyphicon glyphicon-user"></span>'};
function albumIcon () {return '<span class="glyphicon glyphicon-cd"></span>'};

function getIcon (id){
	if (isTrack(id)) return trackIcon();
	if (isArtist(id)) return artistIcon();
	if (isPlaylist(id)) return '<span class="glyphicon glyphicon-th-list"></span>';
	if (isAlbum(id)) return albumIcon();
	if (isRadio(id)) return ' <span class="icon-radioMast"></span> '
	if (isVideo(id)) return ' <span class="glyphicon glyphicon-film"></span> '
	return '<span class="glyphicon glyphicon-exclamation-sign"></span>';		
}	
	
		


function refreshPlaylistsFunction () {
	var urlTail = 'listplaylists&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		playlists = data;
		var ul = $('#playlistDropdownUl');
		ul.children().remove();
		var l = data.length;
		for (var i=0;i<l;i++){ 
			ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickPlaylist('+i+')">'
				+data[i].name+' ('+data[i].length+')</a></li>');
		}
		if (selectedPlaylist >= data.length) selectedPlaylist = 0;
		pickPlaylist (selectedPlaylist);				
	});	
};



function listPlaylistsFunction () {

	selectedPlaylist = 0;
	refreshPlaylistsFunction ();
	
};


function playlistItem (list,i){

/*
	return '<tr><td  class="mylink" onclick="playlistItemClick(event)" ondblclick="playlistItemRename('+i+')" ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')" draggable="true" ondragstart="dragPlaylistItem(event)">'
				+getIcon(list[i].id)+' '+stripClass(list[i].name)+'</td></tr>';	
		
*/

	return $('<tr class="mylink"><td><span class="glyphicon glyphicon-play" onclick="playPlaylistItemFunction('+i+')"</span></td>'+
				'<td class="col-sm-10" onclick="playlistItemClick(event)" ondblclick="playlistItemRename('+i+')" ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')" draggable="true" ondragstart="dragPlaylistItem(event)">'
				+getIcon(list[i].id)+' '+stripClass(list[i].name)+'</td>'+
				'<td><span class="glyphicon glyphicon-option-horizontal" onclick="playlistItemFunction('+i+')"</span></td>'+
				'</tr>');

}

function listPlaylistFunction (index) {
	id = index+4000000;

	var urlTail = 'listplaylist&id='+id+" &"+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		var tbody = $('#playlistTbody');
		tbody.children().remove();
		playlist = data;
		var l = data.length;


		for (var i=0;i<l;i++){ 
/*
			tbody.append('<tr><td  class="mylink" onclick="playlistItemClick(event)" ondblclick="playlistItemRename('+i+')" ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')" draggable="true" ondragstart="dragPlaylistItem(event)">'
				+getIcon(data[i].id)+' '+stripClass(data[i].name)+'</td></tr>');
*/				
			tbody.append(playlistItem(data,i));
			
		}	
		tbody.append('<tr><td></td><td  ondragover="allowDrop(event)" ondrop="playlistDrop(event,'+i+')" ondragenter="playlistDragenter(event,'+i+')" ondragleave="playlistDragleave(event,'+i+')">'
			+'--end--</td><td></td></tr>');

		box = $('#playlistContainer');
		box.scrollTop(0);	
		box.perfectScrollbar ('update');
		
	});	
};


function playPlaylistItemFunction (index){
	
	console.log ("playPlaylistItemFunction () id="+playlist[index].id);

//	command = 'playID&'+playlist[index].id+'&' + new Date ().getTime()
//	$.get('b2cgi.fcgi',command,function(data){});
	
	var pid = selectedPlaylist+4000000;
	var command = 'startPlaylist&playlist='+pid+'&id='+playlist[index].id+'&time='+ new Date ().getTime();		// IE;
	$.get('b2cgi.fcgi',command,function(data){});

		
}		

function pickPlaylist (i){
	
	if ((lastGuest==1)&&(lastGuestPlaylist > 0)&&(i != lastGuestPlaylist-1)) {
		$('#guestModeModal').modal();			
		return;
	}
	
	selectedPlaylist = i;
	
	$("#menu1").html(playlists[i].name+' <span class="caret"></span>');
	listPlaylistFunction (i);
	
	
	if (!$("#playlistCheckbox").hasClass ("myGrey")) searchFunction ();	

}

function playlistItemFunction (index){

	console.log ("playlistItemFunction ("+index+")");

	selectedPlaylistItem = index;
	
	var name = playlist[index].name;
	var id = playlist[index].id;
		
	$('#playlistItemTitle').html(getIcon(id)+' '+name);	
	$('#playlistItemModal').modal();	
}

function playlistItemDeleteButton (){
	
	playlistIndex = selectedPlaylistItem;
	console.log ("Removing playlist "+selectedPlaylist+" item "+playlistIndex);
	command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+playlistIndex+'&' + new Date ().getTime();
	$.get('b2cgi.fcgi',command,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();				
	});
	$('#playlistItemModal').modal("hide");		
}

function playlistItemStartButton (){
	
	playlistMove (selectedPlaylistItem,0);
	selectedPlaylistItem = 0;
	
}	
	
function playlistItemEndButton (){
	
	playlistMove (selectedPlaylistItem,playlist.length);
	selectedPlaylistItem = playlist.length-1;
	
}

function playlistItemUpButton (){
	
	if (selectedPlaylistItem > 0){
		playlistMove (selectedPlaylistItem,selectedPlaylistItem-1);
		selectedPlaylistItem--;
	}	
	
}

function playlistItemDownButton (){
	
	if (selectedPlaylistItem < playlist.length){
		playlistMove (selectedPlaylistItem,selectedPlaylistItem+1);
		selectedPlaylistItem++;
	}	

}


function allowDrop (ev) {
	ev.preventDefault();
}

function dragPlaylistItem (ev){
	i = ev.target.parentElement.rowIndex;
	ev.dataTransfer.setData ("text",""+i);
}


function playlistItemClick (ev){
	i = ev.target.parentElement.rowIndex;	
	id = playlist[i].id;
	console.log ("playlistItemClick "	+ id);
	if (isAlbum(id)) listalbumAndArtistFunction (id);
	else if (isTrack (id)) listTrackFunction (id);	
	else if (isArtist (id)) listArtistAndFirstAlbum (id,true);
}

function dropSpeaker (ev){
	ev.preventDefault();
	i = ev.dataTransfer.getData ("text");
	console.log ("Dropped item i="+i);	
	
	if (isPlaylistIndex(i)) id = playlist[i].id;
	else id = i;
	
//	alert ("Play id="+id);
	command = 'playID&'+id+'&' + new Date ().getTime()
	$.get('b2cgi.fcgi',command,function(data){});	
}

function searchFunction (stay){
	
//	console.log ("searchFunction () visible = "+$('#SearchContainer').is(":visible"));
	
	console.log ("searchFunction () state = "+(!$("#playlistCheckbox").hasClass ("myGrey")));	
	
	if (!$('#SearchContainer').is(":visible")) return;
	
	var t = document.getElementById("searchInput");
	
	
	if (t.value.toLowerCase() == "treble") {
		openToneControl ();
		return;
	}	
			
	
	var urlTail = 'search';
	searchOffset = 0;
	if ($("#artistCheckbox").hasClass ("myGrey")) urlTail += '&artists=N';
	if ($("#albumCheckbox").hasClass ("myGrey")) urlTail += '&albums=N';
	if ($("#trackCheckbox").hasClass ("myGrey")) urlTail += '&tracks=N';
	if ($("#radioCheckbox").hasClass ("myGrey")) urlTail += '&radio=N';	
	if ((lastGuest==1)&&(lastGuestPlaylist!=0)) urlTail += '&playlist='+(lastGuestPlaylist-1);
	else if (!$("#playlistCheckbox").hasClass ("myGrey")) urlTail += '&playlist='+selectedPlaylist;
		
	urlTail += '&offset='+searchOffset;
	urlTail += '&count='+100;

	urlTail += '&time='+new Date ().getTime();			// IE
	
	urlTail += '&string='+t.value
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
//		console.log ("Got search results length = "+data.length);
		
		matches = data;
		var results = $('#Results');
		results.children().remove();
		var l = data.length;
		for (var i=0;i<l;i++) 
			results.append(makeSearchResult (i,data[i]));

		box = $('#SearchContainer');
		if (!stay) box.scrollTop(0);	
		box.perfectScrollbar ('update');		
			
	});	
}		

function searchMore (){

//	alert ("searchMore ()");
	
	console.log ("searchMore () length = "+$('#Results').children ().length);

	if (!$('#SearchContainer').is(":visible")) return;
	
//	if (!panels[2].is(":visible")) return;
//	if (!$("#SearchPanel").hasClass ("active")) return;	
	
	if (!$('#Results').children ().length) {
		$('#SearchContainer').scrollTop(0);		
		return;	
	}
	
	var t = document.getElementById("searchInput");
	var urlTail = 'search';
	searchOffset += 100;
	if ($("#artistCheckbox").hasClass ("myGrey")) urlTail += '&artists=N';
	if ($("#albumCheckbox").hasClass ("myGrey")) urlTail += '&albums=N';
	if ($("#trackCheckbox").hasClass ("myGrey")) urlTail += '&tracks=N';
	if ($("#radioCheckbox").hasClass ("myGrey")) urlTail += '&radio=N';
	if ((lastGuest==1)&&(lastGuestPlaylist!=0)) urlTail += '&playlist='+(lastGuestPlaylist-1);		
	else if (!$("#playlistCheckbox").hasClass ("myGrey")) urlTail += '&playlist='+selectedPlaylist;
	
	urlTail += '&offset='+searchOffset;
	urlTail += '&count='+100;

	urlTail += '&time='+new Date ().getTime();			// IE
	
	urlTail += '&string='+t.value
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
//		console.log ("Got search results length = "+data.length);
		if (data.length){
			var results = $('#Results');
			var l = data.length;
			for (var i=0;i<l;i++) {
				results.append(makeSearchResult (matches.length,data[i]));
				matches.push(data[i]);
			}
			box = $('#SearchContainer');
			box.perfectScrollbar ('update');
		}
		else {
			searchOffset -= 100;
		}	
			
	});	
	
	

}

function makeSearchResult (i,n){
	
	var menu;
	var t;
	var id = n.id;
	var name = '';
	var ariaName = '';
	
	if (isTrack(id)) {
		name = n.track;
		ariaName = 'Track: '+name;
	}	
	else if (isAlbum(id)) {
		name = stripClass(n.album);
		ariaName = 'Album: '+name;
	}	
	else if (isArtist(id)) {
		name = n.artist;
		ariaName = 'Artist: '+name;		
	}	
	else if (isRadio(id)) {
		name = n.radio;
		ariaName = 'Radio: '+name;		
	}	
	else if (isVideo(id)) {
		name = n.video;
		ariaName = 'Video: '+name;		
	}
	
	if (searchResultsHaveFocus) t = 'tabindex="0"';
	else t = 'tabindex="-1"';
	
	if (isRadio(id)) menu = '<td></td>';
	else if (desktop ()) menu = '<td><span class="glyphicon glyphicon-option-horizontal" onclick="searchItemFunction('+i+')"</span></td>';
	else menu = '<td class="spaceForScrollbar"><span class="glyphicon glyphicon-option-horizontal" onclick="searchItemFunction('+i+')"</span></td>';
	
	return $('<tr '+t+' class="mylink" aria-label="'+ariaName+'"><td><span class="glyphicon glyphicon-play" onclick="playTestFunction('+i
				+')"</span></td><td class="col-sm-10" draggable="true" ondragstart="dragSearchItem(event)" ondblclick="searchItemRename(event,'+i
				+')" onclick="searchItemClick(event)">'+getIcon(id)+' '+name
				+'</td>'+
				menu+
				'</tr>');
};

function dragSearchItem (ev){
	i = ev.target.parentElement.rowIndex;
	ev.dataTransfer.setData ("text",""+matches[i].id);
	console.log ("drag "+matches[i].id);
}

function dragPlaylist (ev){
//	i = ev.target.parentElement.rowIndex;
	ev.dataTransfer.setData ("text",""+(selectedPlaylist+4000000));
	console.log ("dragPlaylist index = 	"+selectedPlaylist+4000000);
}

function playPlaylist (){
	command = 'playID&'+ (selectedPlaylist+4000000);
	$.get('b2cgi.fcgi',command,function(data){})	
}

function dragvTunerSearchItem (ev){
	i = ev.target.parentElement.rowIndex;
	i += 5200000;
	ev.dataTransfer.setData ("text",""+i);
	console.log ("drag "+i);
}

function dragvTunerItem (ev){
	console.log ("dragvTunerItem "+ev.target.parentElement);
	var i = ev.target.parentElement.rowIndex;
	console.log ("dragvTunerItem ("+i+")");
	i += 5100000;
	ev.dataTransfer.setData ("text",""+i);
	console.log ("drag "+i);
}

function dragPreset (ev){
	i = ev.target.parentElement.rowIndex;
	i += 6000000;
	ev.dataTransfer.setData ("text",""+i);
	console.log ("drag "+i);
}


function playAlbumTrack (index){

	id = albumTracks[index].id;
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});
		
}	

function makeAlbumItem (i){
	
	var menu;
	
	if (desktop ()) menu = '<td><span class="glyphicon glyphicon-option-horizontal" onclick="albumItemFunction('+i+')"</span></td>';
	else menu = '<td class="spaceForScrollbar"><span class="glyphicon glyphicon-option-horizontal" onclick="albumItemFunction('+i+')"</span></td>';

	var el = $('<tr class="mylink"><td><span onclick="playAlbumTrack('+i+')" class="glyphicon glyphicon-play"></span></td><td class="col-sm-10" draggable="true" ondragstart="dragAlbumTrack(event)" onclick="albumTrackRename('+i+')">'+
							albumTracks[i].name+'</td>'+menu+'</tr>');	
	return el;
	
}	



function listalbumAndArtistFunctionRaw (id,inSitu){
	
	selectedAlbum = id;
	

	var urlTail = 'listalbum&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		albumTracks = data;
		var results = $('#AlbumTracks');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			results.append(makeAlbumItem(i));
		}



	});

	if (!inSitu){								// don't scroll to top if item changed
		box = $('#AlbumTracksBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
	}	
	
//	console.log ("albumDetails");
	
	displayArt (id);	
	
	var urlTail = 'albumDetails&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
//	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log ("Album details "+data.name);
		selectedAlbumName = data.name;
		$('#albumname').text(stripClass(data.name));		
	});	
	
	urlTail = 'getParent&id='+id+" &"+new Date ().getTime();	// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log ("Reply ID = "+data.id);
		listArtistFunction (data.id);		
	});
}

function listalbumAndArtistFunction (id){
	listalbumAndArtistFunctionRaw (id,false);
}

function listalbumAndArtistInSitu(id){
	listalbumAndArtistFunctionRaw (id,true);
}	



function listalbumFunction (id){
	
	selectedAlbum = id;
	
	var urlTail = 'listalbum&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		albumTracks = data;
		var results = $('#AlbumTracks');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
//			var el = $('<tr class="mylink"><td><span onclick="playAlbumTrack('+i+')" class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragAlbumTrack(event)" ondblclick="albumTrackRename('+i+')">'+data[i].name+"</td></tr>");
			results.append(makeAlbumItem(i));

		}



	});

	box = $('#AlbumTracksBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');	
	
	console.log ("albumDetails");
	
	displayArt (id);
	
	var urlTail = 'albumDetails&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		console.log ("Album details "+data.name);
		selectedAlbumName = data.name;		
		$('#albumname').text(stripClass(data.name));		
	});	
	
}




function searchItemClick (ev){
	i = ev.target.parentElement.rowIndex;	
	id = matches[i].id;
	console.log ("searchItemClick "	+ id);
	if (isAlbum(id)) {
		listalbumAndArtistFunction (id);
		activateAlbumTab ();
	}	
	else if (isArtist(id)){
//		listArtistFunction (id);
		listArtistAndFirstAlbum (id,true);		
		activateArtistTab ();
	}	
	else if (isTrack (id)) {
		listTrackFunction (id);
		activateAlbumTab ();
	}		
}	

function dragAlbumTrack (ev){
	i = ev.target.parentElement.rowIndex;
	console.log ("dragAlbumTrack () i= "+i);
	ev.dataTransfer.setData ("text",""+albumTracks[i].id);

}

function playArtistAlbum (index){

	id = artistAlbums[index].id;
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});	
}

function listArtistAndFirstAlbum (id,listAlbumFlag){
	
//	console.log ("listArtistFunction ("+id+")");
	var urlTail = 'listartist&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
//	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		artistAlbums = data;
		var results = $('#ArtistAlbums');
		results.children().remove();
		var l = data.length;
//		console.log ("listArtistsFunction () ajax reply length "+l);

		for (var i=0;i<l;i++){

			if (desktop ()) menu = '<td><span class="glyphicon glyphicon-option-horizontal" onclick="artistItemFunction('+i+')"</span></td>';
			else menu = '<td class="spaceForScrollbar"><span class="glyphicon glyphicon-option-horizontal" onclick="artistItemFunction('+i+')"</span></td>';

			results.append('<tr class="mylink"><td><span class="glyphicon glyphicon-play" onclick="playArtistAlbum('+i+')"></span></td><td class="col-sm-10" ondblclick="artistItemRename('+i+') " draggable="true" ondragstart="dragArtistAlbum(event)" onclick="artistAlbumClick(event)">'+stripClass(data[i].name)+"</td>"+menu+"</tr>");
		}

		box = $('#ArtistAlbumsBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');

		if (listAlbumFlag) listalbumFunction (artistAlbums[0].id);	
	});	


	
//	console.log ("artistDetails");
	var urlTail = 'artistDetails&id='+id;
	urlTail += '&time='+new Date ().getTime();			// IE	
//	console.log ("urlTail="+urlTail);
	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log ("Artist details "+data.name);
		selectedArtistName = data.name;
		$('#artistname').text(data.name);		
	});	
	
}

function listArtistFunction (id){

	listArtistAndFirstAlbum (id,false);
}	



function artistAlbumClick (ev){
	i = ev.target.parentElement.rowIndex;	
	id = artistAlbums[i].id;
//	console.log ("artistAlbumClick "+ id);
	if (isAlbum(id)) listalbumFunction (id);
	activateAlbumTab ();	
}

function artistItemRename (index){

	openRenameWindow (artistAlbums[index].id,artistAlbums[index].name);

}

function dragArtistAlbum (ev){
	i = ev.target.parentElement.rowIndex;
	console.log ("dragArtistAlbum () i= "+i);
	ev.dataTransfer.setData ("text",""+artistAlbums[i].id);

}

function dragNowPlayingTrack (ev){
	ev.dataTransfer.setData ("text",""+nowPlaying['trackid']);
	console.log ("dragNowPlayingTrack ()" + nowPlaying['trackid']);
}	

function dragNowPlayingAlbum (ev){
	ev.dataTransfer.setData ("text",""+nowPlaying['albumid']);
	console.log ("dragNowPlayingTrack ()" + nowPlaying['albumid']);
}

function dragNowPlayingArtist (ev){
	ev.dataTransfer.setData ("text",""+nowPlaying['artistid']);
	console.log ("dragNowPlayingTrack ()" + nowPlaying['artistid']);
}


function changed (newvalue,oldvalue){

	return ((typeof oldvalue === "undefined")||(newvalue !== oldvalue));

}	

function refreshNowPlaying () {
	
	nowPlaying = {};
	
}	

function statusFunction () {
	
	var playlist;
	
	var urlTail = 'status&' + new Date ().getTime();
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		var ps;
		var t = $('#playbutton');
		
		var change = false;			// window may have resized

		if (changed(data['playing'],nowPlaying['playing'])){
		
			if (data['playing'] == 0) {
				t.children().remove();
				t.append('<span class="glyphicon glyphicon-play"></span>');
			}				
			else {
				t.children().remove();
				t.append('<span class="glyphicon glyphicon-pause"></span>');			
			}
		
		}
	
		if ((data['source'] != nowPlaying['source'])||changed(data['playing'],nowPlaying['playing'])||
				(data['playlist'] != nowPlaying['playlist'])||
				((data['source'] == 'Internet Radio') && data.playing)){		

//			change = true;			// doesn't resize

			if (data['playing'] == 0) ps = ' Paused ';
			else ps = ' Playing ';
			
			playlist = data['playlist']||"";
			
			var f = $('#sourceHeader');
			
			if ((data['source'] == 'Internet Radio') && data.playing) f.text (data.radioStatus);
			else if ((data['source'] == 'Web Browser')) {
				f.text (data['source']+" "+data['track']+ps);
			}	
			else f.text (data['source']+" "+playlist+ps);
			
			if (!((data['source'] == 'Hard Disk')||
				(data['source'] == 'SD Card')||
				(data['source'] == 'Youtube')||
				(data['source'] == 'Internet Radio'))) clearCurrentArt ();			
			
		}
		
		var b = $('#nowPlayingBody');
	
//		console.log ("statusFunction () "+data['source']);
//		console.dir (data);
	
		if ((data['source'] == 'Hard Disk')||(data['source'] == 'SD Card')){
			if (data['track'] != nowPlaying['track']){

				change = true;

				displayCurrentArt ();

				b.html('<h6 class="mylink" draggable="true" ondragstart="dragNowPlayingTrack (event)" onclick="nowPlayingTrackClick()">'+trackIcon ()+' '+data['track']+'</h6>'+
					'<h6 class="mylink" draggable="true" ondragstart="dragNowPlayingArtist (event)" onclick="nowPlayingArtistClick()"><span class="glyphicon glyphicon-user"></span> '+data['artist']+
					'</h6><h6 class="mylink" draggable="true" ondragstart="dragNowPlayingAlbum (event)" onclick="nowPlayingAlbumClick()"><span class="glyphicon glyphicon-cd"></span> '+data['album']+'</h6>');
			}		
		}
		else if (data['source'] == 'Internet Radio'){
			if (data['station'] != nowPlaying['station']){
				console.log ("internet radio changed "+data['station']+" != "+nowPlaying['station']);
				change = true;
				b.html('<h4>'+data['station']+'</h4>');
				if (data['logo']) displayRadioLogo (data['logo']);
				else clearCurrentArt ();				
			}	
		}	
		else if (data['source'] == 'Bluetooth'){
			if (data['btstatus'] != nowPlaying['btstatus']){			
				change = true;
				b.html('<h4>'+data['btstatus']+'</h4>');
				clearCurrentArt ();	
			}	
		}
		else if (data['source'] == 'CD Player'){
			if (data['track'] != nowPlaying['track']){
				change = true;
				b.html('<h4>'+data['track']+'</h4>');		
				clearCurrentArt ();					
			}	
		}
		else if (data['source'] == 'Youtube'){
			if (data['track'] != nowPlaying['track']){
				displayCurrentArt ();				
				change = true;
				b.html('<h4>'+data['track']+'</h4>');
			}	
		}
		else {
			console.log ("This displays track by default"+data['source']);
			if (data['track'] != nowPlaying['track']){
				change = true;
				b.html('<h4>'+data['track']+'</h4>');
			}	
		}	

		
		if (data.volume != lastVolume){
			if (!mouseOverSlider){
				$("#slider-1").val (data.volume);
				lastVolume = data.volume;
			}	
		}
		
		if (change) adjustHeights ();

		if (data.cddbmatches != nowPlaying.cddbmatches){
//			console.log ("########## cddbmatches changed = "+data.cddbmatches);
			listCDDBFunction ();
		}	
		
			
		nowPlaying = data;
		
		// var vu = data['vu'];
		// var t = new Date().getTime();
		// vuLine1.append (t+0,vu[4]);			
		// vuLine1.append (t+100,vu[3]);
		// vuLine1.append (t+200,vu[2]);
		// vuLine1.append (t+300,vu[1]);
		// vuLine1.append (t+400,vu[0]);						
		
		$('#cdstatus').text(data.cdstatus);
		if (lastCDLoaded != data.cdloaded){
//			console.log ("cdloaded = "+data.cdloaded);
			if (data.cdloaded) activateCDTab ();
			lastCDLoaded = data.cdloaded;
			if (!data.cdloaded) $('#cdbox').html ('<div></div>');
		}	

		if (lastDiscid != data.discid) {
//			console.log ("discid = ",data.discid);
			lastDiscid = data.discid;		
//			doAlbumArt (data.discid);
		}

		if (lastRandom != !!parseInt(data.random)) {
//			console.log ("random = ",parseInt(data.random));
			lastRandom = !!parseInt(data.random);		
			$('#randomIcon').toggleClass("myGrey",!lastRandom);
		}

		if (lastSorted != !!parseInt(data.sorted)) {
			lastSorted = !!parseInt(data.sorted);		
			$('#alphaIcon').toggleClass("myGrey",!lastSorted);
		}
		
		if (lastBackground != data.background) {
			lastBackground = data.background;		
			$("#backgroundText").html(data.background);			
		}
		
		if (lastCompression != data.compression) {
			lastCompression = data.compression;
			setCompressionText (data.compression);
		}	
				
		if (lastSegue != data.segue) {
			lastSegue = data.segue;
			setSegueText (data.segue);
		}

		if (lastLogging != data.logging) {
			lastLogging = data.logging;
			setLoggingText (data.logging);
		}
		if (lastTvUi != data.tvui) {
			lastTvUi = data.tvui;
			$("#tvUi").prop("checked",data.tvui==1);
		}
		if (lastHDMI != data.hdmi) {
			lastHDMI = data.hdmi;
			$("#hdmi").prop("checked",data.hdmi==1);
		}
		if (lastvCache != data.vCache) {
			lastvCache = data.vCache;
			$("#vCache").prop("checked",data.vCache==1);
		}
		if (lastGuestPlaylist != data.guestPlaylist) {
			console.log ("incoming Guest Mode changed="+data.guestPlaylist);
			lastGuestPlaylist = data.guestPlaylist;
		}
		if (lastGuest != data.guest) {
			lastGuest = data.guest;
			$("#guestMode").prop("checked",data.guest==1);
			if (lastGuest == 1) {
				searchFunction ();
				if (lastGuestPlaylist > 0) {
					selectedPlaylist = lastGuestPlaylist-1;
					refreshPlaylistsFunction ();			
				}	
			}
		}
		
		if (data.forceWebRefresh){
			console.log ("forceWebRefresh");
			refreshPlaylistsFunction ();			
		}	
		
	});	
};

function doAlbumArt (discid){

	if (discid != ""){
		url = 'http://musicbrainz.org/ws/2/discid/'+discid;
		urlTail = 'fmt=json';
	
		console.log ("Musicbrainz request "+url+' '+urlTail);
	
		$.getJSON(url,urlTail,function(data){
			var n,l;
			var releases;
			var release;
		
			console.log ("Musicbrainz reply= ",data);
			releases = data.releases;
			l = releases.length;
			for (n=0;n<l;n++) {
				release = releases[n];
				console.log ("Release "+n+" = "+release.title);
				console.log ("id "+n+" = "+release['id']);
				console.log ("front "+n+" = "+release['cover-art-archive']['front']);
					
				if (release['cover-art-archive']['front']){
					
					url = 'http://coverartarchive.org/release/'+release['id']+"/front-500";
					console.log ("Querying coverartarchive.org "+url);
						
					$('#cdbox').html ('<img src="http://coverartarchive.org/release/'+release['id']+'/front-500">');

					$.getJSON('b2gci.fcgi',"artURL&url="+url+"&time="+new Date ().getTime(),function(data){});	
						
					break;
				}	
			}	
	
		});			
	}
}	

function getArtFunction(){

	$.getJSON('b2gci.fcgi',"getDiscid&time="+new Date ().getTime(),function(data){
		console.log ("Discid = "+data);
		doAlbumArt (data);		
	});		
	
}


function nowPlayingAlbumClick (){
	id = nowPlaying['albumid'];
	console.log ("nowPlayingAlbumClick "+ id);
	if (isAlbum(id)) listalbumAndArtistFunction (id);
}

function nowPlayingArtistClick (){
	id = nowPlaying['artistid'];
	console.log ("nowPlayingArtistClick "+ id);
	if (isArtist(id)) listArtistFunction (id);
}

function listTrackFunction (id){
	var urlTail = 'getParent&id='+id+" &"+new Date ().getTime();	// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		console.log ("Reply ID = "+data.id);
		listalbumAndArtistFunction (data.id);		
	});
}

function nowPlayingTrackClick (){
	id = nowPlaying['trackid'];
	console.log ("nowPlayingTrackClick "+ id);
	listTrackFunction (id);
}


function playlistDragenter (ev,index){
		ev.preventDefault();
//		console.log ("playlistDragenter "+index);
		var tbody = $('#playlistTbody');
		tbody.children().eq(index).addClass("topBorder");		
}	

function playlistDragleave (ev,index){
		ev.preventDefault();
//		console.log ("playlistDragleave "+index);
		var tbody = $('#playlistTbody');
		tbody.children().eq(index).removeClass("topBorder");
}


function playlistMove (from,to){
	
	var id;
		
	if (to == from) return;
	id = playlist[from].id;
	console.log ("playlistMove "+selectedPlaylist+" from "+from+" to "+to);

	command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+from+'&time='+new Date ().getTime();			// IE
	$.get('b2cgi.fcgi',command,function(data){
//		if (from < to) to--;
			
		console.log ("Now adding id "+id+" back to index "+to);

		urlTail = 'addIdToPlaylist&id='+id+'&playlist='+selectedPlaylist+'&index='+to+'&time='+new Date ().getTime();			// IE;
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			listPlaylistFunction (selectedPlaylist);
			refreshPlaylistsFunction ();
		});
	});
			
}



function playlistDrop (ev,index){
	
		var fromPlaylist;
		var id;
		
		ev.preventDefault();
		console.log ("playlistDrop "+index);
		
		if (lastGuest==1) {
			$('#guestModeModal').modal();			
			return;
		}		
		
		var tbody = $('#playlistTbody');
		tbody.children().eq(index).removeClass("topBorder");

		i = ev.dataTransfer.getData ("text");
		if (isPlaylistIndex(i)){
			fromPlaylist = 1;
			id = playlist[i].id;
			playlistIndex = i;
		}
		else {
			fromPlaylist = 0;
			id = i;
			playlistIndex = 0;
		}
		
//		console.log ("playlist[0].id=",playlist[0].id);
//		console.log ("playlist[1].id=",playlist[1].id);
//		console.log ("fromPlaylist="+fromPlaylist+" id="+id+" playlistIndex "+playlistIndex);
		

		if (fromPlaylist) {
			if (index == playlistIndex) return;
			console.log ("Removing playlist "+selectedPlaylist+" item "+playlistIndex);
			command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+playlistIndex+'&time='+new Date ().getTime();			// IE
			$.get('b2cgi.fcgi',command,function(data){

				if (index > playlistIndex) index--;
				
				console.log ("Now adding id "+id+" back to index "+index);

				urlTail = 'addIdToPlaylist&id='+id+'&playlist='+selectedPlaylist+'&index='+index+'&time='+new Date ().getTime();			// IE;
				$.getJSON('b2gci.fcgi',urlTail,function(data){
					listPlaylistFunction (selectedPlaylist);
					refreshPlaylistsFunction ();
				});
			});
		}
		else {
			urlTail = 'addIdToPlaylist&id='+id+'&playlist='+selectedPlaylist+'&index='+index+'&time='+new Date ().getTime();			// IE;
			$.getJSON('b2gci.fcgi',urlTail,function(data){
				listPlaylistFunction (selectedPlaylist);
				refreshPlaylistsFunction ();
			});
		}
			
}	


function openRenameWindow (id,name){
	
	console.log ("openRenameWindow ("+id+","+name+")");


	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
	
	console.log ("CD Status ="+nowPlaying.cdstatus);
	
	if (nowPlaying.cdstatus.toLowerCase().search("rip")>=0){
		
		alert ("Not while Ripping");
		return;
		
	}	
		
	
	
	renameID = id;
	renameOldName = name;

	var title;
	if (isTrack(id)) title = "Rename Track";
	else if (isAlbum(id)) title = "Rename Album";
	else if (isArtist(id)) title = "Rename Artist";	
	else if (isPlaylist(id)) title = "Rename Playlist";

	$('#myModal').modal();
	$('#renameTitle').text(title);
	$('#renameValue').val(name);
	$('#renameValue').focus();
	
	$('#renameValue').off ("keydown");
	$('#renameSecondValue').off ("keydown");
	
	$('#renameValue').keydown (function(event){
		if ((event.keyCode == 13)||event.code == 10){
			renameOKFunction ();
			return false;
		}
	});
	$('#renameSecondValue').keydown (function(event){
		if ((event.keyCode == 13)||event.code == 10){
			renameOKFunction ();
			return false;
		}
	});
	
	if (isAlbum(id)){
		$('#renameArtist').show ();
		var urlTail = 'albumDetails&id='+id+'&time='+new Date ().getTime();			// IE
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			console.log ("Album details "+data.artist);
			renameOldArtist = data.artist;
			$('#renameSecondValue').val(data.artist);		
		});	
	}
	else {
	
		$('#renameArtist').hide ();
	}	
}

function albumTrackRename (index){

	openRenameWindow (albumTracks[index].id,albumTracks[index].name);

}	

function renameOKFunction (){

	var urlTail;
	var newName;
	var artistChanged;
	
	console.log ("renameOKFunction ()");
	$('#myModal').modal("hide");

	newName = $('#renameValue').val();
	console.log ("Newname = "+newName);
	
	artistChanged = (isAlbum(renameID) && (renameOldArtist != $('#renameSecondValue').val()));
	
	if (newName != renameOldName){
		
		urlTail = 'renameID&id='+renameID+'&time='+new Date ().getTime()+'&name='+	encodeURIComponent(newName);		// IE	
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			if (!artistChanged){
				searchFunction (true);					// refresh		
				listalbumAndArtistInSitu (selectedAlbum);
				listPlaylistFunction (selectedPlaylist);
				refreshPlaylistsFunction ();
			}	
		});	
	}
	
	if (artistChanged){
		newName = $('#renameSecondValue').val();		

		console.log ("Artist changed = "+newName);
			
		urlTail = 'moveID&id='+renameID+'&time='+new Date ().getTime()+'&name='+	encodeURIComponent(newName);	// IE		
		$.getJSON('b2gci.fcgi',urlTail,function(data){
			searchFunction (true);					// refresh		
			listalbumAndArtistInSitu (selectedAlbum);
			listPlaylistFunction (selectedPlaylist);
		});	
	}
	

}


function searchItemRename (ev,index){

	ev.preventDefault();

	var name;
	var id = matches[index].id

//	console.log ("searchItemRename event="+ev); 
	
	if (isTrack(id)) name = matches[index].track;
	else if (isAlbum(id)) name = matches[index].album;
	else if (isArtist(id)) name = matches[index].artist;
	else return;
	
	openRenameWindow (id,name);

}	

function playlistItemRename (index){

	openRenameWindow (playlist[index].id,playlist[index].name);

}

function dropBin (ev){
	ev.preventDefault();
	i = ev.dataTransfer.getData ("text");
	console.log ("Dropped item i="+i);
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}	
	
	if (isPlaylistIndex(i)){
		playlistIndex = i;
		console.log ("Removing playlist "+selectedPlaylist+" item "+playlistIndex);
		command = 'deletePlaylistIndex&playlist='+selectedPlaylist+'&index='+playlistIndex+'&' + new Date ().getTime();
		$.get('b2cgi.fcgi',command,function(data){
				listPlaylistFunction (selectedPlaylist);
				refreshPlaylistsFunction ();				
		});
	}
}

function ripFunction (){
	console.log ("ripFunction ()");
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
		
	command = 'rip&index='+selectedcddb+'&' + new Date ().getTime();
	$.get('b2cgi.fcgi',command,function(data){
			
	});
}	

function listCDDBFunction () {
//	console.log ("listcddbFunction ()");
	command = 'getCDDB&' + new Date ().getTime();				// IE
	$.getJSON('b2gci.fcgi',command,function(data){
//		console.log ("getCDDB replied "+data);
		cddb = data;
		var ul = $('#CDDBDropdownUl');
		ul.children().remove();
		var l = data.length;
		
		if (l){
			$('#CDDBPanel').show();
			for (var i=0;i<l;i++){ 
				ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickCddb('+i+')">'
					+data[i].album+'</br><h6><strong>'+data[i].artist+'</strong></h6></a></li>');
			}		
			selectedcddb = 0;
			pickCddb (0);
		}
		else $('#CDDBPanel').hide(); 
					
	});	
};

function pickCddb (i){

	selectedcddb = i;
	
	$("#menu2").html(cddb[i].album+' <span class="caret"></span>');
}	

function playTestFunction (index){
	var id = matches[index].id
//	alert ("playTestFunction "+id);
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});		
}		



function nextUpload (){
	
	var formData = new FormData ();

//	formData.append (uploadAlbum,uploadFiles[currentUpload],uploadFiles[currentUpload].name);

	var name = uploadFiles[currentUpload].name;
	if (name.toUpperCase ().indexOf (".JPG") > 0) name = "coverart.jpg";
	else if (name.toUpperCase ().indexOf (".PNG") > 0) name = "coverart.png";	

	formData.append (uploadAlbum,uploadFiles[currentUpload],name);

	$.ajax ({
		url: 'b2cgi.fcgi?upload&artist='+uploadArtist,
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {

//			console.log ("Upload success currentUpload = "+currentUpload);
//			console.log ("data= "+data);
//			console.log ("textStatus = "+textStatus);

			currentUpload++;
			uploadTry = 1;
			if (uploadEnabled && (currentUpload < uploadFiles.length)){
				var n = currentUpload+1;
				$('#uploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length);		
				nextUpload ();
			}
			else  {
				$('#uploading').hide ();				
				searchFunction ();					// refresh		
				listalbumAndArtistFunction (selectedAlbum);
				refreshNowPlaying ();				
			}	
		},
		error: function (jqXHR, textStatus, errorThrown){
			
				if (uploadEnabled && (uploadTry < 3)){
					uploadTry++;
					var n = currentUpload+1;
					$('#uploadProgress').html ('&nbsp&nbsp&nbspRetrying '+n+' of '+uploadFiles.length);					
					nextUpload ();
				}
				else {	
					$('#uploadModal').modal("hide");
					alert ("Upload error: "+textStatus+" file = "+uploadFiles[currentUpload].name);
				}	
			}
		});	
}

// This version used for Art upload doesn't reset search window 

function uploadOne (){
	
	var formData = new FormData ();

	formData.append (uploadAlbum,uploadFiles[currentUpload],uploadFiles[currentUpload].name);

	$.ajax ({
		url: 'b2cgi.fcgi?upload&artist='+uploadArtist,
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {
			$('#uploading').hide ();				
			listalbumAndArtistFunction (selectedAlbum);				
		},
		error: function (jqXHR, textStatus, errorThrown){
			
				if (uploadEnabled && (uploadTry < 3)){
					uploadTry++;
					var n = currentUpload+1;
					$('#uploadProgress').html ('&nbsp&nbsp&nbspRetrying '+n+' of '+uploadFiles.length);					
					uploadOne ();
				}
				else {	
					$('#uploadModal').modal("hide");
					alert ("Upload error: "+textStatus+" file = "+uploadFiles[currentUpload].name);
				}	

		}	
	});	
}


function uploadFunction (){

	uploadArtist = $('#uploadArtist').val();
	uploadAlbum = $('#uploadAlbum').val();
	uploadFiles = $('#uploadFileSelect').prop('files');

	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}

	if (uploadArtist && uploadAlbum && uploadFiles.length){

		currentUpload = 0;
		uploadTry = 1;
		var n = currentUpload+1;

		$('#uploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length);		
		$('#uploading').show ();
		
		uploadEnabled = true;		
		
		nextUpload ();

	}
	else myAlert ("You need to specify Album, Artists and Choose Files");
}

function uploadCancelFunction (){

		uploadEnabled = false;
	
}	


function openArtistPanel (){
		$('#artistButton').replaceWith ('<span id="artistButton" class="glyphicon glyphicon-minus-sign"></span>');
		$('#AlbumTracksBox').collapse ("show");
}	

function closeArtistPanel (){
		$('#artistButton').replaceWith ('<span id="artistButton" class="glyphicon glyphicon-plus-sign"></span>');
		$('#AlbumTracksBox').collapse ("hide");
}

function showHideArtistPanel (){
	
		var glyph = $('#artistButton').attr("class");
		
		console.log ("showHideArtistPanel "+glyph+" "+glyph.indexOf ("plus"));		
		
		if (glyph.indexOf ("plus") == -1) closeArtistPanel ();
		else openArtistPanel ();

}	


function openPresetsPanel (){
		$('#presetsButton').replaceWith ('<span id="presetsButton" class="glyphicon glyphicon-minus-sign"></span>');
		$('#presetsBox').collapse ("show");
}	

function closePresetsPanel (){
		$('#presetsButton').replaceWith ('<span id="presetsButton" class="glyphicon glyphicon-plus-sign"></span>');
		$('#presetsBox').collapse ("hide");
}


function listPresetsFunction (){
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#presets');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<tr class="mylink" onclick="playPreset('+i+')"><td><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragPreset(event)" ondblclick="presetEdit('+i+')" ondragover="allowDrop(event)" ondrop="presetDrop(event,'+i+')" class="mylink">['+i+'] '+data[i].name+"</td></tr>");
			results.append(el);
		}
		
		box = $('#presetsBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');		
		

	});
	
}

function playPreset (index){

	id = index += 6000000;	
	command = 'playID&'+id
	$.get('b2cgi.fcgi',command,function(data){});	
}	


function presetDrop (ev,preset){
	
	ev.preventDefault();	

	id = ev.dataTransfer.getData ("text");
	
//	console.log ("presetDrop () preset = "+preset+" id = "+id);
	
	var urlTail = 'setPresetFromID&id='+id+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});	

	
}


function vTunerGoBack (){

	var loading = $('#vTunerTable');
	loading.children().remove();
	loading.append ('<div><img src="ajax-loader.gif"></div>');

	
	var urlTail = 'vTunerBack&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		
		var vTunerLinks = $('#vTunerTable');
		vTunerLinks.children().remove();

		for (var i=0;i<data.length;i++){
//			vTunerLinks.append('<tr><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick(event)" class="mylink">'+data[i]+"</td></tr>");
//			vTunerLinks.append('<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink"><a href="#" alt="'+data[i].name+'">'+data[i].name+"</a></td></tr>");
			vTunerLinks.append(makevTunerItem (i,data[i]));
		}

		var box = $('#vTunerBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
				
	});	
}
	

function vTunerSearch (){

	var t = document.getElementById("vTunerSearchInput");
	var urlTail = 'vTunerSearch&time='+ new Date ().getTime()+'&string='+t.value;	// IE

//	console.log ("Search urltail ="+urlTail);

	var loading = $('#vTunerMatches');
	loading.children().remove();
	loading.append ('<div><img src="ajax-loader.gif"></div>');
	
	var box = $('#vTunerSearchBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');

	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		
//		console.log ("vTunerSearch result = "+data);

		vTunerSearchResults = data;

		var vTunerLinks = $('#vTunerMatches');
		vTunerLinks.children().remove();

		for (var i=0;i<data.length;i++){

			var menu = '<td><span class="mylink glyphicon glyphicon-option-horizontal" onclick="vTunerSearchItemMenu('+i+')"</span></td>';
			var link = 'class="mylink" onclick="vTunerSearchItemClick('+i+')"';

//			vTunerLinks.append('<tr class="mylink" onclick="vTunerSearchItemClick('+i+')"><td><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragvTunerSearchItem(event)">'+data[i]+"</td></tr>");

			vTunerLinks.append('<tr><td '+link+'><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragvTunerSearchItem(event)">'+data[i]+"</td>"+menu+"</tr>");


		}
		var box = $('#vTunerSearchBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');		
				
	});		
}

function vTunerSearchItemMenu (index){
	
	$('#vTunerSearchMenuModal').modal();
	$('#vTunerSearchMenuTitle').html("Move "+vTunerSearchResults[index]+"<br />To Preset");
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#vTunerSearchMenuBody');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<button type="button" class="btn btn-default btn-block leftjustified" onclick="vTunerSearchPresetAdd('+index+','+i+')" >['+i+'] '+data[i].name+'</button>');
			results.append(el);
		}

	});	
		
}	

function vTunerItemMenu (index){
	
	$('#vTunerItemMenuModal').modal();
	$('#vTunerItemMenuTitle').html("Move "+vTunerItemResults[index].name+"<br />To Preset");
	
//	console.log ("listPresetsFunction ()");
	var urlTail = 'getPresets&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
		var results = $('#vTunerItemMenuBody');
		results.children().remove();
		var l = data.length;
				
		for (var i=0;i<l;i++){
			var el = $('<button type="button" class="btn btn-default btn-block leftjustified" onclick="vTunerItemPresetAdd('+index+','+i+')" >['+i+'] '+data[i].name+'</button>');
			results.append(el);
		}

	});	
		
}	


function vTunerItemPresetAdd (index,preset){
	
	console.log ("vTunerItemPresetAdd ("+index+","+preset+")");
	console.log (vTunerItemResults[index]);
	
	index += 5100000;
	var urlTail = 'setPresetFromID&id='+index+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});	

	$('#vTunerItemMenuModal').modal("hide");
	selectPlaylistSubPanel(2);

}

function vTunerSearchPresetAdd (index,preset){
	
	console.log ("vTunerSearchPresetAdd ("+index+","+preset+")");
	console.log (vTunerSearchResults[index]);
	
	index += 5200000;
	var urlTail = 'setPresetFromID&id='+index+'&preset='+preset+'&time='+ new Date ().getTime();		// IE

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPresetsFunction ();
	});	

	$('#vTunerSearchMenuModal').modal("hide");
	selectPlaylistSubPanel(2);

}

function vTunerSearchItemClick (i){

	console.log ("vTunerSearchItemClick index="+i);
	
	var urlTail = 'vTunerPlaySearchItem&index='+i+'&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		
		console.log ("vTunerPlaySearchItem result = "+data);

	});	
}


function makevTunerItem (i,data){

	if (data.flag){
		var menu = '<td><span class="mylink glyphicon glyphicon-option-horizontal" onclick="vTunerItemMenu('+i+')"</span></td>';
		var link = 'class="mylink" onclick="vTunerItemClick('+i+')"';
		return '<tr><td '+link+'><span class="glyphicon glyphicon-play"></span></td><td class="col-sm-11" draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink">'+data.name+"</td>"+menu+"</tr>";	
	}	
	else 
		return '<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink">'+data.name+"</td></tr>";	
	
}


function vTunerInit () {

//	console.log ("vTunerInit ()");


	var vTunerLinks = $('#vTunerTable');
	vTunerLinks.children().remove();
	vTunerLinks.append ('<div><img src="ajax-loader.gif"></div>');
	
	var urlTail = 'vTunerTop&' + new Date ().getTime();			// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){			
		
//		console.log ("vTunerTop result = "+data);
		vTunerLinks.children().remove();
		vTunerItemResults = data;


		for (var i=0;i<data.length;i++){

//			vTunerLinks.append('<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink"><a href="#" alt="'+data[i].name+'">'+data[i].name+"</a></td></tr>");
			vTunerLinks.append(makevTunerItem (i,data[i]));


		}

//		console.log ("First Item = "+vTunerLinks.children()[0]);
		vTunerLinks.children().eq(0).focus();
				
		var box = $('#vTunerBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
				
	});
	
}


function vTunerItemClick (index){
//function vTunerItemClick (ev){
//	index = ev.target.parentElement.rowIndex;	
	console.log ("vTunerItemClick "+ index);

	var loading = $('#vTunerTable');
	loading.children().remove();
	loading.append ('<div><img src="ajax-loader.gif"></div>');

	var box = $('#vTunerBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');

	
	var urlTail = 'vTunerLink&index='+index+'&time='+ new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){	


		vTunerItemResults = data;		
//		console.log ("vTunerLink result = "+data);

		var vTunerLinks = $('#vTunerTable');
		vTunerLinks.children().remove();

		for (var i=0;i<data.length;i++){
//			vTunerLinks.append('<tr><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick(event)" class="mylink">'+data[i]+"</td></tr>");
//			vTunerLinks.append('<tr role="listitem"><td draggable="true" ondragstart="dragvTunerItem(event)" onclick="vTunerItemClick('+i+')" class="mylink"><a href="#" alt="'+data[i].name+'">'+data[i].name+"</a></td></tr>");
			vTunerLinks.append(makevTunerItem (i,data[i]));
		}

		vTunerLinks.children().eq(0).focus();

		var box = $('#vTunerBox');
		box.scrollTop(0);
		box.perfectScrollbar ('update');
				
	});	
}



function activateCDTab (){
/*	
	$('#playlistTab').removeClass("active");	
	$('#PresetsTab').removeClass("active");
	$('#UploadTab').removeClass("active");	
	$('#CDTab').addClass("active");
	
	$('#playlistPanel').removeClass("in active");	
	$('#PresetsPanel').removeClass("in active");
	$('#UploadPanel').removeClass("in active");	
	$('#CDPanel').addClass("in active");
*/
	selectPlaylistSubPanel (1);
}	


function activateAlbumTab (){

/*
	$('#ArtistTab').removeClass("active");	
	$('#AlbumTab').addClass("active");
	
	$('#ArtistPanel').removeClass("in active");	
	$('#AlbumPanel').addClass("in active");
*/
	pickPanel (7);
	
}	

function activateArtistTab (){
/*	
	$('#AlbumTab').removeClass("active");	
	$('#ArtistTab').addClass("active");
	
	$('#AlbumPanel').removeClass("in active");	
	$('#ArtistPanel').addClass("in active");
*/
	pickPanel (8);
	
}


function startVTuner (){
	
	console.log ("startVTuner ()");
	
}	

function adjustPanels (){



	if ((window.innerWidth > th) && (lastWidth <= th)){
		selectPanel (0);
	}	
	if ((window.innerWidth < th) && (lastWidth >= th)){
		selectPanel (0);
	}	
	lastWidth = window.innerWidth;
}	
		

function resize (){
	
	var canvas = document.getElementById("mycanvas");
	canvas.width = $('#canvasBox').width();
//	adjustPanels ();
	
	box = $('#SearchContainer');
	box.scrollTop(0);	
	box.perfectScrollbar ('update');
	
	adjustHeights ();		
}	


/*
function albumPanelClicked (){
	
	togglePanel (4);

}	

function nowPlayingClicked (event){

	togglePanel (0);

}

function selectPanel (panel){

	if (window.innerWidth > th){
		for (n=0;n<5;n++){
			panels[n].slideDown();
		}
	}
	else {	
		for (n=0;n<5;n++){
			if (n == panel) panels[n].slideDown();
			else panels[n].slideUp();
		}
	}
	
}

function togglePanel (panel){
	
	console.log ("togglePanel "+panel);

	if (window.innerWidth > th){
		for (n=0;n<5;n++){
			panels[n].slideDown();
		}
	}
	else {	
		for (n=0;n<5;n++){
			if (n == panel) panels[n].slideToggle();
			else panels[n].slideUp();
		}
	}
	
}
*/

function stripClass (name){
	
//	return name.replace (/\[[A-Z]*\]/,"");
	return name;

}	

// vpbm returns the vertical padding, border and margin of a container
// selector should look like a css selector "#middleWell" or ".well"

function vpbm (selector){

	var el = $(selector);
	return el.outerHeight(true)-el.height();
}

function adjustHeights (){

//	console.log ("adjustHeights");
	
	var wh = $(window).height();						// browser window height


	mobileModeSwitch ();
	selectPanelForMobile ();

	var desk = desktop ();

	if (desk){

		if (wh < 700) wh = 700;

/*		
		console.log (".btn-group[] length =" + $(".btn-group").length);
		$(".btn-group").each (function (index){
			console.log (index + " " + $(this).outerHeight (true));
		});	
*/	
		var woh = vpbm (".well");							// well overhead
		var th = $("#SearchTab").outerHeight(true);			// tab height
		var bbh = $("#searchButtons").outerHeight(true);	// button bar height
		var poh = vpbm (".panelContent");					// panelContent overhead
		var soh = vpbm ("#SearchContainer");				// searchContainer overhead

		var srch = wh-woh-th-bbh-poh-soh;

//	console.log ("wh "+wh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh+" soh "+soh);
//	console.log ("div height = "+srch);

		$('#SearchContainer').height(srch);

		bbh = $("#vTunerButtons").outerHeight(true);		// button bar height	
		var vth = wh-woh-th-bbh-poh-soh;		
	
		$('#vTunerBox').height((vth-bbh-10)/2);				// 10 px space between two sections
		$('#vTunerSearchBox').height((vth-bbh-10)/2);

		var sbh = $('#youtubeSearchBar').outerHeight(true);
		var ph = $('#youtubeSearchHeading').outerHeight(true);

		console.log ("wh "+wh+" woh "+woh+" th "+th+" sbh "+sbh+" poh "+poh+" ph "+ph);

		var yth = wh-woh-th-sbh-poh;						// window - well overhead - tab height - search bar - panel overhead 
		console.log ("div height = "+yth);

		var ytph = ((yth-2)/2) - ph; 
		console.log ("ytph = "+ytph);

		$('#YoutubeSearchResultsBox').height(ytph);				// 2 px space between two sections
		$('#YoutubeHistoryBox').height(ytph);

		var npwh = $("#nowPlayingWell").outerHeight(true);		// now playing well height
		bbh = $("#playlistButtons").outerHeight(true);		// button bar height
		
		$('#playlistContainer').height(wh-npwh-woh-th-bbh-poh-soh);
		$('#presetsBox').height(wh-npwh-woh-th-poh-soh);
		
		$('#CDPanel').height(wh-npwh-woh-th-poh-soh);
		
		var ih = $('#CDPanel').height()-$('#cdTitleBar').outerHeight()-$('#CDDBPanel').outerHeight();
		var iw = $('#CDPanel').width();

		var is = ih > iw? iw : ih;
		$('#cdbox').height(is);

//	console.log ("wh "+wh+" npwh "+npwh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh);
//	console.log ("div height = "+(wh-npwh-woh-th-poh-soh));

		var arhh = $("#artistHeader").outerHeight(true);			// artist header
		$('#ArtistAlbumsBox').height((wh+10)/2-woh-arhh-poh);		// 10 = final margin

		var alhh = $("#albumHeader").outerHeight(true);				// album header
		$('#AlbumTracksBox').height((wh+10)/2-woh-alhh-poh);	

//	console.log ("wh "+wh+" woh "+woh+" alhh "+alhh+" poh "+poh);
//	console.log ("div height = "+(wh/2-woh-alhh-poh));

	}
	else {

		var mbnh = $('#handsetNav').outerHeight(true);		// mobile nav bar height

		var woh = vpbm (".well");							// well overhead
		var th = $("#SearchTab").outerHeight(true);			// tab height
		var bbh = $(".btn-group").outerHeight(true);		// button bar height
		var poh = vpbm (".panelContent");					// panelContent overhead
		var soh = vpbm ("#SearchContainer");				// searchContainer overhead

		var srch = wh-woh-th-bbh-poh-soh;
		srch -= mbnh;

//	console.log ("wh "+wh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh+" soh "+soh);
//	console.log ("div height = "+srch);

		$('#SearchContainer').height(srch);

		$('#vTunerBox').height((srch-bbh-10)/2);				// 10 px space between two sections
		$('#vTunerSearchBox').height((srch-bbh-10)/2);

//		$('#YoutubeSearchResultsBox').height((srch-bbh-10)/2);				// 10 px space between two sections
//		$('#YoutubeHistoryBox').height((srch-bbh-10)/2);

		var npwh = $("#nowPlayingWell").outerHeight(true);		// now playing well height

//		console.log ("nowPlaying Well height "+npwh);


		var sbh = $('#youtubeSearchBar').outerHeight(true);
		var ph = $('#youtubeSearchHeading').outerHeight(true);

		console.log ("wh "+wh+" woh "+woh+" th "+th+" sbh "+sbh+" poh "+poh+" ph "+ph+" mbnh "+mbnh);

		var yth = wh-woh-th-sbh-poh-mbnh;						// window - well overhead - tab height - search bar - panel overhead 
		console.log ("div height = "+yth);

		var ytph = ((yth-2)/2) - ph; 
		console.log ("ytph = "+ytph);

		$('#YoutubeSearchResultsBox').height(ytph);				// 2 px space between two sections
		$('#YoutubeHistoryBox').height(ytph);

		
		var temp = wh-woh-th-bbh-poh-soh;
		console.log ("presetsBox.height = "+temp);
		$('#presetsBox').height(temp);
		
		var temp = wh-woh-th-bbh-poh-soh - mbnh;
		console.log ("playlistContainer.height = "+temp);
		$('#playlistContainer').height(temp);
		
		$('#CDPanel').height(wh-npwh-woh-th-poh-soh);
		
//		console.log ("Available height = "+$('#CDPanel').height());
//		console.log ("Available width = "+$('#CDPanel').width());
//		console.log ("Title height = "+$('#cdTitleBar').outerHeight());
//		console.log ("CDDB height = "+$('#CDDBPanel').outerHeight());
		
		var ih = $('#CDPanel').height()-$('#cdTitleBar').outerHeight()-$('#CDDBPanel').outerHeight();
		var iw = $('#CDPanel').width();

		var is = ih > iw? iw : ih;
		$('#cdbox').height(is);		
		

//	console.log ("wh "+wh+" npwh "+npwh+" woh "+woh+" th "+th+" bbh "+bbh+" poh "+poh);
//	console.log ("div height = "+(wh-npwh-woh-th-poh-soh));

		var arhh = $("#artistHeader").outerHeight(true);			// artist header
//		$('#ArtistAlbumsBox').height((wh+10)/2-woh-arhh-poh);		// 10 = final margin
		$('#ArtistAlbumsBox').height(srch);					
		
		var alhh = $("#albumHeader").outerHeight(true);				// album header
//		$('#AlbumTracksBox').height((wh+10)/2-woh-alhh-poh);	
		$('#AlbumTracksBox').height(srch);

//	console.log ("wh "+wh+" woh "+woh+" alhh "+alhh+" poh "+poh);
//	console.log ("div height = "+(wh/2-woh-alhh-poh));

	}

}

// switches between mobile display and desktop display

function desktop (){
	
//	return $(window).width () >= 975;

//	return ((getCookie("uiMode")!="mobile")&& ($(window).width () >= 975));

	console.log ("desktop () cookie = "+getCookie("uiMode"));

	if (getCookie("uiMode")=="desktop") return true;
	if (getCookie("uiMode")=="mobile") return false;	
	return $(window).width () >= 600;

}	

function mobileModeSwitch () {

	if (desktop ()){							// desktop mode
		$('#handsetNav').hide();
		$('#playlistTabs').show();
		$('#searchTabs').show();
		$('#settingsButton').show();		
	}
	else {										// mobile mode
		$('#handsetNav').show();
		$('#playlistTabs').hide();		
		$('#searchTabs').hide();
		$('#settingsButton').hide();	
	}	
}


function selectPanelForMobile (){
	
	var desk = desktop ();

	if ((selectedPanelForMobile == 0)||desk) $('#nowPlayingWell').show ();
	else $('#nowPlayingWell').hide ();
	
	if (desk){
		$('#ColumnOne').show ();
		$('#ColumnTwo').show ();		

		if (selectedSearchSubPanel== 0) $('#SearchPanel').show ();
		else $('#SearchPanel').hide ();

		if (selectedSearchSubPanel== 1) $('#VTunerPanel').show ();
		else $('#VTunerPanel').hide ();

		if ((selectedSubPanel == 0)) $('#playlistPanel').show ();
		else $('#playlistPanel').hide ();

		if ((selectedSubPanel == 1)) $('#CDPanel').show ();
		else $('#CDPanel').hide ();

		if ((selectedSubPanel == 2)) $('#PresetsPanel').show ();
		else $('#PresetsPanel').hide ();
			
		if ((selectedSubPanel == 3)) $('#UploadPanel').show ();
		else $('#UploadPanel').hide ();

	}
	else {
	
		if (selectedPanelForMobile == 1) $('#SearchPanel').show ();
		else $('#SearchPanel').hide ();

		if (selectedPanelForMobile == 2) $('#VTunerPanel').show ();
		else $('#VTunerPanel').hide ();

		if (selectedPanelForMobile == 9) $('#YoutubePanel').show ();
		else $('#YoutubePanel').hide ();
		
		if ((selectedPanelForMobile == 0)||
			(selectedPanelForMobile == 3)||
			(selectedPanelForMobile == 4)||
			(selectedPanelForMobile == 5)||
			(selectedPanelForMobile == 6)){
				$('#ColumnOne').show ();
		}
		else 		
				$('#ColumnOne').hide ();													

		if ((selectedPanelForMobile == 1)||
			(selectedPanelForMobile == 2)||
			(selectedPanelForMobile == 9)){
				$('#ColumnTwo').show ();
		}
		else 		
				$('#ColumnTwo').hide ();


		if ((selectedPanelForMobile == 3)) $('#playlistPanel').show ();
		else $('#playlistPanel').hide ();

		if ((selectedPanelForMobile == 4)) $('#CDPanel').show ();
		else $('#CDPanel').hide ();
	
		if ((selectedPanelForMobile == 5)) $('#UploadPanel').show ();
		else $('#UploadPanel').hide ();

		if ((selectedPanelForMobile == 6)) $('#PresetsPanel').show ();
		else $('#PresetsPanel').hide ();

		
	}	
		
	if ((selectedPanelForMobile == 7)||desk) $('#AlbumWell').show ();
	else $('#AlbumWell').hide ();

	if ((selectedPanelForMobile == 8)||desk) $('#ArtistWell').show ();
	else $('#ArtistWell').hide ();	
}	


function selectPlaylistSubPanel (index){

	selectedSubPanel = index;
	if (index == 0) $('#playlistPanel').show ();
	else $('#playlistPanel').hide ();
	
	if (index == 1) $('#CDPanel').show ();
	else $('#CDPanel').hide ();
	
	if (index == 2) $('#PresetsPanel').show ();
	else $('#PresetsPanel').hide ();
	
	if (index == 3) $('#UploadPanel').show ();
	else $('#UploadPanel').hide ();

	adjustHeights ();
	
}

function selectSearchSubPanel (index){
	
	selectedSearchSubPanel = index;

	if (index == 0) {
		$('#SearchPanel').show ();
//		searchFunction ();
	}	
	else $('#SearchPanel').hide ();
	
	if (index == 1) {
		$('#VTunerPanel').show ();
		vTunerInit ();
	}	
	else $('#VTunerPanel').hide ();
	
	if (index == 2) {
		$('#YoutubePanel').show ();
		getHistory (refreshHistoryList);	
	}
	else $('#YoutubePanel').hide ();
	
	adjustHeights ();
}


// onclick function for main navigation


function panelBackFunction(){
	
//	console.log ("history length ",lastPanels.length," first item ",lastPanels[0]);

	if (lastPanels.length >= 1){
		
		pickPanel (lastPanels.pop());
		lastPanels.pop();
		
	}	
	
}	




var panelNames = ["Now Playing","Search","vTuner","Playlists","CD","Upload"," Presets","Album","Artist","Youtube","Settings"];

function pickPanel (index){

//	console.log ("pickPanel "+index);

	if (index == 10) {
		openSettingsModal();
		return;
	}	
	
	lastPanels.push(selectedPanelForMobile);
	
	selectedPanelForMobile = index;
	selectPanelForMobile ();

	if (index == 1)	searchFunction ();
	if (index == 2) vTunerInit ();
	if (index == 9) {
//		adjustHeights ();
		getHistory (refreshHistoryList);
	}	

	$("#selectedPanel").html(panelNames[index]+' <span class="caret"></span>');
	$('#selectedPanel').attr ("aria-label","Main Navigation "+panelNames[index]+" selected");	

}	



function renamePlaylist (){

	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}
	openRenameWindow (playlistToID (selectedPlaylist),playlists[selectedPlaylist].name);

}	

function pickSource (i){
	
	selectedSource = i;
	if (i >= playlists.length) $("#mixMenu2").html('All Music <span class="caret"></span>');
	else $("#mixMenu2").html(playlists[i].name+' <span class="caret"></span>');
	mixText ();	
}

function pickDest (i){
	
	selectedDest = i;
	$("#mixMenu3").html(playlists[i].name+' <span class="caret"></span>');
	mixText ();	
}

function pickMode (i){
	
	selectedMode = i;
	
	var text;
	
	if (selectedMode == 0) text = "Append";
	else if (selectedMode == 1) text = "Subtract";
	else if (selectedMode == 2) text = "Merge";
	
	$("#mixMenu1").html(text+' <span class="caret"></span>');
	
	mixText ();
}

function mixText (){


	var text;
	
	if (selectedMode == 0) text = "to ";
	else if (selectedMode == 1) text = "from ";
	else if (selectedMode == 2) text = "with ";
	
//	text += playlists[selectedPlaylist].name;
	$("#mixText").text(text);
}	

function mixPlaylist (){


	var ul = $('#mixSourceDropdownUl');
	ul.children().remove();
	var l = playlists.length;
	
	pickMode (selectedMode);
	
	for (var i=0;i<l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickSource('+i+')">'+
			playlists[i].name+' ('+playlists[i].length+')</a></li>');
	}
	ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickSource('+i+')">All Music</a></li>');
	pickSource (selectedSource);
	

	ul = $('#mixDestDropdownUl');
	ul.children().remove();
	
	for (var i=0;i<l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickDest('+i+')">'+
			playlists[i].name+' ('+playlists[i].length+')</a></li>');
	}
	pickDest (selectedDest);	
	

	$('#mixModal').modal();
	
}
		
function mixOKFunction (){
	
	urlTail = 'mixPlaylists&mode='+selectedMode+'&source='+selectedSource+'&dest='+selectedDest+'&time='+ new Date ().getTime();		// IE;
	
	console.log (urlTail);
	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();
		
		$('#mixModal').modal("hide");
		
	});
	
		
	
}

function createPlaylist (){
	
	$('#newPlaylistValue').val("");
	$('#newPlaylistValue').focus();		
	$('#newPlaylistModal').modal();
	
}

function newPlaylistOKFunction (){

	var newName = $('#newPlaylistValue').val();
	console.log ("newPlaylistOKFunction () "+newName);
	
	var urlTail = 'newPlaylist&time='+ new Date ().getTime()+'&name='+	encodeURIComponent(newName);
			
	console.log (urlTail);
	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();
		
		$('#newPlaylistModal').modal("hide");
		
	});	
}			

function searchItemFunction (index){

	console.log ("searchItemFunction ("+index+")");
	
	selectedSearchItem = matches[index];
	var id = selectedSearchItem.id;

	var name = '';
	if (isTrack(id)) name = selectedSearchItem.track;
	else if (isAlbum(id)) name = selectedSearchItem.album;
	else if (isArtist(id)) name = selectedSearchItem.artist;
	else if (isRadio(id)) name = selectedSearchItem.radio;
	else if (isVideo(id)) name = selectedSearchItem.video;
		
	$('#searchItemTitle').html(getIcon(id)+' '+name);	
	
	$('#areYouSureTitle').html(getIcon(id)+' '+name);
	$('#addToPlaylistTitle').html(getIcon(id)+' '+name);
	
	$('#searchItemModal').modal();	
	
}

function albumItemFunction (index){

	console.log ("albumItemFunction ("+index+")");

	selectedSearchItem = albumTracks[index];

	var id = albumTracks[index].id;
	var name = albumTracks[index].name;

	selectedSearchItem.track = name;	
	
	console.log ("id="+id);		
	console.log ("name="+name);

	$('#searchItemTitle').html(getIcon(id)+' '+name);	
	
	$('#areYouSureTitle').html(getIcon(id)+' '+name);
	$('#addToPlaylistTitle').html(getIcon(id)+' '+name);
	
	$('#searchItemModal').modal();

	
}	
	
function artistItemFunction (index){

	console.log ("artistItemFunction ("+index+")");

	selectedSearchItem = artistAlbums[index];

	var id = artistAlbums[index].id;
	var name = artistAlbums[index].name;

	selectedSearchItem.album = name;	
	
	console.log ("id="+id);		
	console.log ("name="+name);

	$('#searchItemTitle').html(getIcon(id)+' '+name);	
	
	$('#areYouSureTitle').html(getIcon(id)+' '+name);
	$('#addToPlaylistTitle').html(getIcon(id)+' '+name);
	
	$('#searchItemModal').modal();

	
}


function searchItemDeleteButton (){

	$('#searchItemModal').modal("hide");
		
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}		
	$('#areYouSureModal').modal();		
}	
	
function searchItemAddButton (){

	$('#searchItemModal').modal("hide");

	pickAddTarget (targetPlaylist);
	
	var ul = $('#addToPlaylistDropdownUl');
	ul.children().remove();
	var l = playlists.length;
		
	for (var i=0;i<l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickAddTarget('+i+')">'+
			playlists[i].name+' ('+playlists[i].length+')</a></li>');
	}	
	
	
	$('#addToPlaylistModal').modal();		
}

function searchItemRenameButton (){

	var id = selectedSearchItem.id;

	var name = '';
	if (isTrack(id)) name = selectedSearchItem.track;
	else if (isAlbum(id)) name = selectedSearchItem.album;
	else if (isArtist(id)) name = selectedSearchItem.artist;
	else if (isRadio(id)) name = selectedSearchItem.radio;
		
	$('#searchItemModal').modal("hide");

	openRenameWindow (id,name);
	
}	


function deleteConfirmed (){
	
	console.log ("deleteConfirmed () id = "+selectedSearchItem.id);
	
	$('#areYouSureModal').modal("hide");
		
	var urlTail = 'deleteID&id='+selectedSearchItem.id+'&time='+ new Date ().getTime();		// IE;			
	
	console.log ("tail = "+urlTail);
	
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		searchFunction (true);					// refresh		
		listalbumAndArtistInSitu (selectedAlbum);
//		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();				
	});		
	
}	

function pickAddTarget (index){
	
	targetPlaylist = index;
	$("#addToPlaylistMenu").html(playlists[index].name+' <span class="caret"></span>');

}

function addToPlaylistOK (){

	console.log ("addToPlaylistOK () id = "+selectedSearchItem.id+" playlist = "+targetPlaylist);

	$('#addToPlaylistModal').modal("hide");

	urlTail = 'addIdToPlaylist&id='+selectedSearchItem.id+'&playlist='+targetPlaylist+'&index='+playlists[targetPlaylist].length+'&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		listPlaylistFunction (selectedPlaylist);
		refreshPlaylistsFunction ();
	});	
		
}		

function randomToggle (){

	var r;
	
	console.log ("randomToggle ()");
	
	$('#randomIcon').toggleClass("myGrey");
	
	if ($('#randomIcon').hasClass("myGrey")) r=0;
	else r=1;
	
	var urlTail = 'setRandom&random='+r+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
	});		
	
	
}	

function alphaToggle (){

	var r;
	
	console.log ("alphaToggle ()");
	
	$('#alphaIcon').toggleClass("myGrey");
	
	if ($('#alphaIcon').hasClass("myGrey")) r=0;
	else r=1;
	
	var urlTail = 'setSorted&sorted='+r+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
	});		
	
	
}	


function openDebugModal (){

	$("#settingsModal").modal('hide');		
	$("#debugModal").modal();
	refreshDebug ();
	debugTimer = setInterval (refreshDebug,500);
	
}

function closeDebugModal (){
	
	console.log ("closeDebugModal ()");
	clearInterval (debugTimer);
	$("#debugModal").modal('hide');	
}

function refreshDebug (){

//	console.log ("refreshDebug ()");
	
	var urlTail = 'getWebDebug&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log (data);
		
		text = $("#debugText");
		var l = data.length;
		
		while (data.length){
			var p = data.shift();
			console.log ("Debug> "+p);
//			text.append ("<p>"+p+"</p>");
			text.append ("<p></p>");
			text.children().last().text(p); 
		}
		while (text.children().length > 200){
			text.children().first().remove();
		}
		if (l) {
			refreshDebug ();
			var top = document.getElementById("debugText").scrollHeight;
			text.scrollTop (top);
		}	

	});
	
}	

function clearDebugModal (){

	var text = $("#debugText");	
	text.children().remove();	
	var top = document.getElementById("debugText").scrollHeight;
	text.scrollTop (top)	
}	


function openSettingsModal (){
	
	$("#settingsModal").modal();
	refreshSettings ();

}

function pickGuest (i){
	
	lastGuestPlaylist = i;
	if (i == 0) $("#guestMenu").html('All Music <span class="caret"></span>');
	else $("#guestMenu").html(playlists[i-1].name+' <span class="caret"></span>');
	
	guestModeClick ();	

}

function refreshSettings (){

//	console.log ("refreshSettings ()");
	
	var urlTail = 'getWebInfo&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){
//		console.log (data);
		
		var b = $('#settingsBody');
		b.children().remove();
		b.append('<p>Software '+data.version+'</p>');
		b.append('<p>'+data.tracks+' tracks in '+data.albums+' albums '+data.artists+' artists</p>');
		b.append('<p>'+data.wavs+' WAV '+data.flacs+' FLAC '+data.mp3s+' MP3 '+data.aacs+' AAC</p>');
		b.append('<p>Capacity '+data.capacity+'G Used '+data.used+'Gb</p>');

	});
	
	
	var ul = $('#guestDropdownUl');
	ul.children().remove();
	var l = playlists.length;

	ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickGuest(0)">All Music</a></li>');	
	for (var i=1;i<=l;i++){ 
		ul.append('<li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="pickGuest('+i+')">'+
			playlists[i-1].name+' ('+playlists[i-1].length+')</a></li>');
	}

	
	pickGuest (lastGuestPlaylist);
}

function dropArt (ev){

	ev.preventDefault();

	console.log ("count = "+ev.dataTransfer.files.length);
	console.log ("first = "+ev.dataTransfer.files[0].name);
	console.log ("selectedAlbumName = "+selectedAlbumName);
	console.log ("selectedArtistName = "+selectedArtistName);
	
	selectPlaylistSubPanel(3);

	uploadArtist = selectedArtistName;
	uploadAlbum = selectedAlbumName;
	uploadFiles = ev.dataTransfer.files;
	
	$('#uploadArtist').val(selectedArtistName);
	$('#uploadAlbum').val(selectedAlbumName);

	if (uploadArtist && uploadAlbum && uploadFiles.length){

		currentUpload = 0;
		uploadTry = 1;
		var n = currentUpload+1;

		$('#uploadProgress').html ('&nbsp&nbsp&nbspSending '+n+' of '+uploadFiles.length);		
		$('#uploading').show ();
		
		uploadEnabled = true;		
		
		uploadOne ();

	}

}

function clickArt (){
	
	console.log ("clickArt ()");
	console.log ("selectedAlbumName = "+selectedAlbumName);
	console.log ("selectedArtistName = "+selectedArtistName);
	
	selectPlaylistSubPanel(3);

	uploadArtist = selectedArtistName;
	uploadAlbum = selectedAlbumName;
	
	$('#uploadArtist').val(selectedArtistName);
	$('#uploadAlbum').val(selectedAlbumName);

}	

function displayArt (id){
	
	
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?getAlbumArt&id="+id+"&time="+ new Date ().getTime());
	xhr.responseType = "blob";
	xhr.onload = function (){	
		
//		console.log ("getAlbumArt replied");
		
		var	imageUrl;
			
		if (this.response.size){
//			console.log ("Reply size = "+this.response.size);
			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (this.response);
		}
		else imageUrl = "noimage.jpg";
		
		img = $("#albumImage");
		img.attr ("src",imageUrl);

	};	
	xhr.send ();	
	
}

function displayRadioLogo (url){
	
	console.log ("displayRadioLogo () "+url);

	var text = $('#nowPlayingBody');
	var art = $('#nowPlayingArt');

	art.children().remove();

	text.addClass ("col-sm-8");
	art.addClass ("col-sm-4");
	art.append ('<img src="'+url+'" width="100%">');
}


function displayCurrentArt (){
	
	console.log ("displayCurrentArt ()");

	var text = $('#nowPlayingBody');
	var art = $('#nowPlayingArt');

	text.removeClass("col-sm-8");
	art.removeClass("col-sm-4");
	art.children().remove();
			
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?getCurrentArt&time="+ new Date ().getTime());
	xhr.responseType = "blob";

	xhr.onload = function (){
		
		console.log ("getCurrentArt replied");
		
		var	imageUrl;
			
		if (this.response.size){

//			console.log ("Reply size = "+this.response.size);

			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (this.response);
			
			text.addClass ("col-sm-8");
			art.addClass ("col-sm-4");
			art.append ('<img src="'+imageUrl+'" width="100%">');
			
		}
 
	};
	xhr.send ();
	
}

function clearCurrentArt (){
	
	console.log ("clearCurrentArt ()");

	var text = $('#nowPlayingBody');
	var art = $('#nowPlayingArt');

	text.removeClass("col-sm-8");
	art.removeClass("col-sm-4");
	art.children().remove();
	
}



function setCompressionText (mode){
	
//	console.log ("setCompressionText "+mode);
	
	$("#compressionMenu").html(mode +' <span class="caret"></span>');
	
}	

function setCompression (mode){

	setCompressionText (mode);	

	var urlTail = 'setCompression&mode='+mode+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}

function setSegueText (mode){
	
	$("#segueMenu").html(mode +' <span class="caret"></span>');
	
}	

function setSegue (mode){

	setSegueText (mode);	

	var urlTail = 'setSegue&mode='+mode+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}

function scanDisk (){


//	console.log ("scanDisk ()");

	var urlTail = 'scanDisk&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}


function setLoggingText (mode){
	
//	console.log ("setLoggingText "+mode);
	
	$("#loggingMenu").html(mode +' <span class="caret"></span>');
	
}	

function setLogging (mode){


	setLoggingText (mode);

	var urlTail = 'setLogging&mode='+mode+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}


function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function webModeClick (){
	
//	console.log ("webModeClick () state="+$("#webMode").prop("checked"));

//	if ($("#webMode").prop("checked")) setCookie ("uiMode","mobile",365);	
//	else setCookie ("uiMode","normal",365);

	if ($("#webModeAuto").prop("checked")) setCookie ("uiMode","normal",365);	
	if ($("#webModeMobile").prop("checked")) setCookie ("uiMode","mobile",365);
	if ($("#webModeDesktop").prop("checked")) setCookie ("uiMode","desktop",365);
	
	adjustHeights ();	
	
}	

function tvUiClick (){
	
	
	if ($("#tvUi").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'tvui&mode='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){

		
	});		
	
}

function guestModeClick (){
	
	console.log ("guest mode clicked");
	
	if ($("#guestMode").prop("checked")) lastGuest = 1;
	else lastGuest = 0;	
	
	var urlTail = 'guest&mode='+lastGuest+'&playlist='+lastGuestPlaylist+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){

		
	});
	
	searchFunction ();
	
	if (lastGuest == 1){
		
		if (lastGuestPlaylist > 0) {
			selectedPlaylist = lastGuestPlaylist-1;
			refreshPlaylistsFunction ();			
		}	
			
	}
}


function HDMIClick (){
	
	console.log ("HDMIClick ()");
	
	if ($("#hdmi").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'hdmi&mode='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});		
	
}

function vCacheClick (){
	
	console.log ("vCacheClick ()");
	
	if ($("#vCache").prop("checked")) e = 1;
	else e = 0;	
	
	var urlTail = 'vCache&mode='+e+'&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});		
	
}



function pasteArt (ev){

	var type;
	
	console.log ("pasteArt ()");
	var items = (event.clipboardData || event.originalEvent.clipboardData).items;
	console.log (JSON.stringify(items));
	for (index in items){
		item = items[index]
//		console.log ("Kind["+index+"]="+item.kind);
		if (item.kind === "file"){
	
			console.log ("File found type="+item.type);
			
			if (item.type.indexOf ("png")>=0) type = "png";
			else if (item.type.indexOf ("jpg")>=0) type = "jpg";
			else continue;
			
			var blob = item.getAsFile();
			
/*			
			var reader = new FileReader ();
			reader.onload = function (event){
				console.log ("Reader.onload ()"+event.target.result)
			};
			reader.readAsDataURL (blob);
*/

			var urlCreator = window.URL || window.webkitURL;
			imageUrl = urlCreator.createObjectURL (blob);			
			console.log ("imageUrl"+imageUrl);

			img = $("#albumImage");
			img.attr ("src",imageUrl);	
			
			uploadBlob (blob,type);		
			
		}		
	}	
}	

function uploadBlob (blob,type){
	
	var formData = new FormData ();

	formData.append (selectedAlbumName,blob,"coverArt."+type);

	$.ajax ({
		url: 'b2cgi.fcgi?upload&artist='+selectedArtistName,
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {

			console.log ("Upload success");
		
			},
		error: function (jqXHR, textStatus, errorThrown){

			console.log ("Upload failed");
	
			}
		});	
}


function refreshBluetooth (){
	
	var urlTail = 'getBluetoothStatus&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){

		var n;
		var s = JSON.stringify(data);
		console.log ("Bluetooth status = "+s);

		if (data.bluetoothScanning == "true") $('#bluetoothBusy').show ();				
		else $('#bluetoothBusy').hide ();
		
		if (JSON.stringify(lastBluetoothStatus) != s){
			lastBluetoothStatus = data;
			var btb = $('#bluetoothBody');
			btb.children().remove();
//			btb.append ('<p>'+JSON.stringify(data)+'</p>');
			if (data.dongle == "true") 	btb.append ('<p>Dongle present</p>');
			else btb.append ('<p>No Dongle</p>');
			btb.append ('<p>'+data.pairedDevices.length+' Paired Devices</p>');			
			
			if (data.pairedDevices.length > 0){
				
				btb.append ('<div class="well"></div>');
				var w = btb.children().last();
				
				for (n=0;n<data.pairedDevices.length;n++){
					if (data.outputDevice == data.pairedDevices[n].deviceName) icon = '<span class="glyphicon glyphicon-volume-up"></span>';
					else if (data.inputDevice == data.pairedDevices[n].deviceName) icon = '<span class="glyphicon glyphicon-phone"></span>';
					else icon = '';
					
					var output = "";
//					if (data.pairedDevices[n].deviceClass == "audio") output = '<a class="btn btn-default btn-xs" onclick="clickPaired('+n+')">'+button+'</a>';

					if (data.pairedDevices[n].deviceClass == "audio") {
					
						if (data.outputDevice == data.pairedDevices[n].deviceName){
							output = '<div class="nomargin checkbox"><label><input type="checkbox" checked="true" onclick="clickPaired('+n+')">Output</label></div>';
						}	
						else { 	
							output = '<div class="nomargin checkbox"><label><input type="checkbox" onclick="clickPaired('+n+')">Output</label></div>';
						}	
					}
					w.append ('<div><div class="row">'+
								'<div class="col-xs-1">'+icon+'</div>'+
								'<div class="col-xs-7"><p class="mylink" onclick="clickPaired('+n+')">'+data.pairedDevices[n].deviceName+'</p></div>'+
								'<div class="col-xs-2">'+output+'</div>'+								
								'<div class="col-xs-2"><a class="btn btn-default btn-xs" onclick="clickForget('+n+')">Unpair</a></div>'+
								'</div></div>'
								);				
				}
			}
/*			
			if (data.outputDevice != "") btb.append ('<p>Connected Output Device: '+data.outputDevice+'</p>')
			if (data.inputDevice != "") btb.append ('<p>Connected Input Device: '+data.inputDevice+'</p>')
*/
				

			if (data.scannedDevices.length){
				btb.append ('<p>Last scan found '+data.scannedDevices.length+' Devices</p>');			

				btb.append ('<div class="well"></div>');
				w = btb.children().last();
							
				for (n=0;n<data.scannedDevices.length;n++){

					var button = isPaired (n,data)?'':'<a class="btn btn-default btn-xs" onclick="clickScanned('+n+')">Pair</a>';
	
					w.append ('<div><div class="row">'+
								'<div class="col-xs-1"></div>'+
								'<div class="col-xs-9"><p class="mylink" onclick="clickScanned('+n+')">'+data.scannedDevices[n].deviceName+'</p></div>'+
								'<div class="col-xs-2">'+button+'</div>'+
								'</div></div>'
								);	
				}
			}

			$("#tandemBox").prop("checked",data.tandem=="true");			
			
		}			

	});	
	
}

function isPaired (i,data){
	
	var n;
	
	for (n=0;n<data.pairedDevices.length;n++){
		if (data.scannedDevices[i].deviceName == data.pairedDevices[n].deviceName) return true;
	}	
	return false;
}	

function openBluetoothModal (){

//	console.log ("openBluetoothModal ()");
	
	$('#bluetoothBusy').hide ();	
	$("#settingsModal").modal('hide');		
	$("#bluetoothModal").modal();
	
	listDevices ();
	
	refreshBluetooth ();
	bluetoothTimer = setInterval (refreshBluetooth,500);	
}

function closeBluetoothModal (){
	
//	console.log ("closeBluetoothModal ()");
	clearInterval (bluetoothTimer);
	$("#bluetoothModal").modal('hide');	
}

function listDevices (){

	console.log ("List Devices");

	var urlTail = 'listDevices&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
}	

function scanBluetooth (){

	console.log ("scanBluetooth");

	$('#bluetoothBusy').show ();

	var urlTail = 'scanBluetooth&time='+ new Date ().getTime();		// IE;

	$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	lastBluetoothStatus = undefined;	
	
}

function clickPaired (index){
	
	console.log ("clickPaired ("+index+")");
	
	var data = lastBluetoothStatus;

	if (data.outputDevice == data.pairedDevices[index].deviceName){			// connected

		var urlTail = 'disconnectBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
		$.getJSON('b2gci.fcgi',urlTail,function(data){});
	
	}
	else {

		var urlTail = 'connectBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
		$.getJSON('b2gci.fcgi',urlTail,function(data){});
		
	}	
}	

function clickForget (index){

	console.log ("clickForget ("+index+")");

	$('#bluetoothBusy').show ();

	var urlTail = 'unpairBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
	
			listDevices ();
			
	});
	
}	

function clickScanned (index){
	
	console.log ("clickScanned ("+index+")");

	$('#bluetoothBusy').show ();
	
	var urlTail = 'pairBluetooth&index='+index+'&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
			listDevices ();
		
	});

}	

function resetBluetooth2 (){

	console.log ("resetBluetooth2 ()");

	$('#generalAreYouSureModal').modal('hide');	
	
	var urlTail = 'resetBluetooth&time='+ new Date ().getTime();		// IE;
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		
			listDevices ();
		
	});

	
}	

function areYouSure (text,action){
	
	if (lastGuest==1) {
		$('#guestModeModal').modal();			
		return;
	}	
	areYouSureAction = action;
	$('#generalAreYouSureModal').modal();
	$('#generalAreYouSureTitle').html(text);
}

function myAlert (text){
	$('#alertModal').modal();
	$('#alertModalText').html(text)	
}	

function resetBluetooth1 (){

	clearInterval (bluetoothTimer);
	$("#bluetoothModal").modal('hide');	

	areYouSure ("Delete pairings and reboot",resetBluetooth2);

}	

function tandemClick (){

	var urlTail;
	
	console.log ("tandemClick checked="+$("#tandemBox").prop("checked"));
	
	if ($("#tandemBox").prop("checked")) urlTail = 'bluetoothTandem&mode=1&time='+ new Date ().getTime();
	else urlTail = 'bluetoothTandem&mode=0&time='+ new Date ().getTime();
	$.getJSON('b2gci.fcgi',urlTail,function(data){});	
	
}	

function searchKeyHandler (event){

	console.log ("searchKeyHandler () key = "+event.keyCode);

	var children = $('#Results').children();

	if (document.activeElement.getAttribute('id')=='searchInput'){	
		if (event.keyCode == 13){
			console.log ("enabling focus on search results");
			searchResultsHaveFocus = true;
			children.attr("tabindex",0);
			children.eq(0).focus();
		}	
	}
	else {
		if ((event.keyCode == 27)||(event.keyCode == 37)){			// ESC or LEFT
			console.log ("clearing focus on search results");	
			searchResultsHaveFocus = false;
			$('#searchInput').focus();
			children.attr("tabindex",-1);
			
		}
		else if (event.keyCode == 13){

			var row = children.index(document.activeElement);
			playTestFunction (row);
			$('#searchInput').focus();
			children.attr("tabindex",-1);
		}	
		else if (event.keyCode == 38){

			var row = children.index(document.activeElement);
			if (row) row--;
			children.eq(row).focus();
		}
		else if (event.keyCode == 40){

			var row = children.index(document.activeElement);
			if (row < (children.length - 1)) row++;
			children.eq(row).focus();
		}
		
	}		
	
}	

function openJBV (){

		var win = window.open ("jbv.html",'_blank');
		wind.focus();
}	


function refreshHistoryList (){
	var tb = $('#youtubeHistoryTable');
	tb.children().remove();
	var l = youtubeHistory.length;
	for (var i=0;i<l;i++){ 
/*		
		tb.append('<tr><td><a href="#" onclick="playYoutubeHistory('+i+')">'
			+youtubeHistory[i][0]+'</a></td></tr>');
*/
		tb.append (makeYoutubeItem(youtubeHistory[i][0],youtubeHistory[i][1],"playYoutubeHistory",i,true));
	}
	var box = $('#YoutubeHistoryBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');		
}	


// WARNING temporary - use ytdl
var idRegex = /[a-zA-Z0-9-_]{11}/;
function getVideoID (link) {
  var r;
  if (r = idRegex.exec(link)) {
    return r;
  }
  return null;
};


function deleteYoutubeHistoryItem (){

	console.log ("deleteYoutubeHistoryItem ()");
	youtubeHistory.splice (youtubeHistoryDeletionIndex,1);
	uploadHistory ();
	refreshHistoryList ();
	$('#generalAreYouSureModal').modal('hide');				
}	


function youtubeItemMenu (index){

	youtubeHistoryDeletionIndex = index;
	areYouSure ("Delete "+youtubeHistory[index][0],deleteYoutubeHistoryItem);

}

function makeYoutubeItem (text,url,onclick,index,showMenu){

		var img = "";
		var id = getVideoID (url);
		if (id) img = '<img width="100%" src = "https://i.ytimg.com/vi/'+id+'/default.jpg">';
		if (showMenu){
			var trash = '<td class="mylink col-sm-1" onclick="youtubeItemMenu('+index+')"><span id="randomIcon" class="glyphicon glyphicon-trash" ></span></td>';
			var tdClass = '<td class="col-sm-8" onclick="'+onclick+'('+index+')">';
		}
		else {
			var trash = '';
			var tdClass = '<td class="col-sm-9" onclick="'+onclick+'('+index+')">';			
		}		
		
//		console.log ("img = "+img);
		
		return 	'<tr class="mylink youtube"><td class="col-sm-3" onclick="'+onclick+'('+index+')">'+img+'</td>'+
					tdClass+text+'</td>'+trash+'</tr>';
	
}	


function refreshSearchResults (){
	var tb = $('#youtubeSearchResultsTable');
	tb.children().remove();
	var l = youtubeSearchResults.length;
	for (var i=0;i<l;i++){ 

		tb.append (makeYoutubeItem(youtubeSearchResults[i][0],youtubeSearchResults[i][1],"playYoutubeSearchResult",i,false));
			
	}
	var box = $('#YoutubeSearchResultsBox');
	box.scrollTop(0);
	box.perfectScrollbar ('update');	
	
	
}	


function proxyFetch (url,callback){
	
	
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?proxyFetch&url="+url);
	xhr.responseType = "blob";
	xhr.onload = function (){	
		if (this.response.size){
			console.log ("proxyFetch Reply size = "+this.response.size);
			return callback (0,this.response);
		}
		else return (new Error ("proxyFetch no reply"));
	};	
	xhr.send ();	
}

function proxyFetchText (url,callback){
	
	
	var xhr = new XMLHttpRequest ();
	xhr.open ("GET","b2gci.fcgi?proxyFetch&url="+url);
	xhr.responseType = "blob";
	xhr.onload = function (){	
		if (this.response.size){
			console.log ("proxyFetchText Reply size = "+this.response.size);
			
			var reader = new FileReader ();
			reader.onload = function () {
//				console.log ("Head of blob = "+reader.result.slice(0,100));
				callback (0,reader.result);
			};
			reader.readAsText (this.response);				

		}
		else return (new Error ("proxyFetchText no reply"));
	};	
	xhr.send ();	
}



function startFfmpeg (url,title,id){
	

	var urlTail = 'ffmpeg&id='+id+'&title='+title+'&url='+url;
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
}

function startOmxplayer (url,title,id){
	

	var urlTail = 'omxplayer&id='+id+'&title='+title+'&url='+url;
	$.getJSON('b2gci.fcgi',urlTail,function(data){});
}


function allIndexOf (str, toSearch){
	var indices = [];
	for (var pos = str.indexOf (toSearch); pos !== -1; pos = str.indexOf (toSearch, pos+1)){
		indices.push(pos);
	}
	return indices;
}		

function scrapeYoutube (q){
	
	console.log ("scrapeYoutube () val=<"+q+">");
	
	var url = "https://www.youtube.com/results?search_query="+q.replace(" ","+");
	
	console.log ("URL = "+url);
	
	$("#youtubeSearching").show ();	
	

	proxyFetchText (url,function (err,blob){
		if (err) console.log ("Scrape failed");
		else {
			
			var n;
			
//			console.log ("Scrape reply "+blob);
	
//			var ixs = allIndexOf (blob,"oxy");
//			console.log ("#indexes of roxy = "+ixs.length);
//			for (var n=0;(n < ixs.length);n++){
//				console.log (n+" "+ixs[n]+" "+blob.slice(ixs[n]-40,ixs[n]+40)) ;
//			}
//			n = 35;
//			console.log (n+" "+ixs[n]+" "+blob.slice(ixs[n]-2000,ixs[n]+1000)) ;
				 
			
			var yt = $("<div>").html (blob);

//			console.log ("jquery object =>");
//			console.dir (yt);

//			console.dir (yt[0].children);
			
			var el = yt[0].getElementsByClassName ("yt-lockup-title");
//			console.dir (el);
			
			youtubeSearchResults = [];
			
			for (n=0;n<el.length;n++){
				console.log (n+" "+el[n].innerText);
//				console.log (el[n].innerHTML);
				console.log (el[n].firstChild.getAttribute("href"));
				
				var item = [el[n].innerText,el[n].firstChild.getAttribute("href")];

// Youtube channels begin "/user"
				
				if ((item[1].indexOf("doubleclick") == -1)&&(item[1].indexOf("/user") != 0)) youtubeSearchResults.push (item);
				
			}	
			refreshSearchResults ();
			$("#youtubeSearching").hide ();
							

		}
	});		
	
}

function youtubeGo (){
	
	var q = $('#bTubeSearchValue').val();
	$('#bTubeSearchValue').val("");
	
	console.log ("youtubeGo () val=<"+q+">");
	
	var id = getVideoID (q);
	if (id) {
		console.log ("Looks like a Youtube ID - play it");
		return startYoutube (id,function () {
			scrapeYoutube (q)
		});
	}
	else scrapeYoutube (q);
}



/*

https://www.googleapis.com/youtube/v3/search?order=relevance&type=video&maxResults=50&videoCategoryId=10&part=id%2Csnippet&safeSearch=none&q=roxy&key=AIzaSyCIM4EzNqi1in22f4Z3Ru3iYvLaY8tc3bo

*/


var youtubeResult;


function searchYoutube (){
	
	var q = $('#bTubeSearchValue').val();
	
	console.log ("searchYoutube () val=<"+q+">");
	
	var head = "https://www.googleapis.com/youtube/v3/search";
	var tail = "order=relevance&type=video&maxResults=10&videoCategoryId=10&part=id%2Csnippet&safeSearch=none&q="+q+
					"&key=AIzaSyCIM4EzNqi1in22f4Z3Ru3iYvLaY8tc3bo";
	
	$.getJSON(head,tail,function(data){
		
		console.log ("searchYoutube () got reply ");
		console.dir (data);
		
		var items = data.items;
		youtubeResult = data;
		
		var tb = $('#youtubeTable');
		tb.children().remove();
		var l = items.length;
		for (var i=0;i<l;i++){ 
			tb.append('<tr><td><a href="#" onclick="playYoutube('+i+')">'
				+items[i].snippet.title+'</a></td></tr>');
		}
				
	});		
	
}	

function myFilter (item){
	
	console.log ("myFilter");
	console.dir (item);
//	return (item.container=="mp4") && (item.quality=="medium");
	return (item.container=="mp4");
}	

// bTube search


function playYoutube (i){
	
	console.log ("playYoutube ()");
	console.log (youtubeResult.items[i].snippet.title);
	console.log (youtubeResult.items[i].id.videoId);
	
	var options;

	if ($("#videoCheckbox").prop("checked")) options = {filter: myFilter};
//	if ($("#videoCheckbox").prop("checked")) options = {quality: 'lowest'};
	else options = {filter: 'audioonly'};
	
	ytdl ("http://youtube.com/watch?v="+youtubeResult.items[i].id.videoId,options,function (err,url,info){
//	ytdl ("http://youtube.com/watch?v="+youtubeResult.items[i].id.videoId,{filter: 'audioonly'},function (err,url){
//	ytdl ("http://youtube.com/watch?v=kOnde5c7OG8",{filter: 'audioonly'},function (err,url){		
		
		if (err) console.log ("ytdl-core failed "+err);
		else {
			console.log ("ytdl-core returned "+url);
			console.log ("Info=");
			console.dir (info); 
			if ($("#videoCheckbox").prop("checked")) startOmxplayer (url)
			else startFfmpeg (url,info.title,info.video_id);
		}	
	});	
	
	
}

function isBTube (){
	
	return nowPlaying.btube;
	
}	


// Better if I could show status ..locating video, updating history
// I wonder if I can find the ffmpeg url from getinfo - supect I'm doing things twice

function startYoutube (yturl,callback){
	
	console.log ("startYoutube ("+yturl+")");

	$("#youtubeStarting").show ();		

	var options;
	
	
	if (isBTube()) options = {filter: myFilter};
	else options = {filter: 'audioonly'};

	ytdl (yturl,options,function (err,url,info){

		
		if (err) {
			$('#youtubeStarting').hide ();
			console.log ("ytdl-core failed "+err);
			if (callback) callback ();
			else alert ("That didn't work try again");
		}	
		else {
			console.log ("ytdl-core returned "+url); 
			
			console.log ("nowPlaying.btube = "+nowPlaying.btube);
			
			if (nowPlaying.btube) startOmxplayer (url,info.title,info.video_id);			
			else startFfmpeg (url,info.title,info.video_id);

			$('#youtubeStarting').hide ();

			console.log ("Title ",info.title); 
			console.dir (info);
					
			addToYoutubeHistory (info.title,yturl);
			uploadHistory ();
			refreshHistoryList ();
		
		}	
	});		
	
}	

function youtubeStartClick (){
	
	var q = $('#youtubeSearchValue').val();
	
	console.log ("startYoutube () val=<"+q+">");

	startYoutube (q); 
}


function playYoutubeHistory(index){

	var id = getVideoID(youtubeHistory[index][1]);

	var urlTail = 'findAndPlay&id='+id+'&time='+new Date ().getTime();		// try cache
	$.getJSON('b2gci.fcgi',urlTail,function(data){	
		if (data) console.log ("Cache hit");
		else startYoutube (youtubeHistory[index][1]);		
	});	
}	

function playYoutubeSearchResult(index){

	startYoutube (youtubeSearchResults[index][1]);	

}	

function addToYoutubeHistory (title,url){

	var item = [title,url];
	var i;
	
	for (i=0;i<youtubeHistory.length;i++){
		if (youtubeHistory[i][0]===title)
			youtubeHistory.splice (i,1);
	}		
	
	youtubeHistory.unshift (item);
	while (youtubeHistory.length > 20) youtubeHistory.pop ();
}

function uploadHistory (){
	
	var formData = new FormData ();

	formData.append ("history",JSON.stringify(youtubeHistory));

	$.ajax ({
		url: 'b2cgi.fcgi?uploadYoutubeHistory',
		type: 'POST',
		data: formData,
		cache: false,
		dataType: 'json',
		processData: false,
		contentType: false,
		success: function (data, textStatus, jqXHR) {
			console.log ("uploadHistory OK");
		},
		error: function (jqXHR, textStatus, errorThrown){
			console.log ("uploadHistory Error "+errorThrown);	
		}	
	});	
}

function getHistory (callback){
	
	var urlTail = 'getYoutubeHistory&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){
		youtubeHistory = data;
		if (callback) callback ();
	});	
};	


function openToneControl (){
	console.log ("openToneControl () bass="+nowPlaying.bass+" treble="+nowPlaying.treble);
	$('#toneModal').modal();			


	$("#bassSlider").val(nowPlaying.bass);
	$("#trebleSlider").val(nowPlaying.treble);

}	

function toneChange (){
	console.log ("toneChange ()");
	console.log ("Treble = "+$("#trebleSlider").val());		

	var bass = $("#bassSlider").val();
	var treble = $("#trebleSlider").val();

	var urlTail = 'setTone&bass='+bass+'&treble='+treble+'&time='+new Date ().getTime();		// IE
	$.getJSON('b2gci.fcgi',urlTail,function(data){});	

}	

function playlistFilterToggle (){

	console.log ("playlistFilterToggle ()");
	console.log ("state = "+!$("#playlistCheckbox").hasClass ("myGrey"));
	
//	searchFunction ();
	
}	


</script>


	

</body>
</html>
